<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>日系突突机</title>
    <style>
      /* --- 全局平滑过渡效果 --- */
body, #chat-container, #chat-header, #bottom-panel, .settings-content, 
.feature-modal-content, .action-item-icon, .chat-item, .modal-overlay,
.form-group input, .form-group textarea, .form-group select {
    transition: background-color 0.4s ease, color 0.4s ease, border-color 0.4s ease;
}

/* --- 夜间模式核心样式 --- */
body.dark-mode {
    --bg-color: #121212;
    --chat-bg-color: rgba(30, 30, 30, 0.85);
    --header-bg-color: rgba(45, 45, 45, 0.9);
    --input-bg-color: #252525;
    --text-color: #E0E0E0;
    --text-light-color: #9E9E9E;
    --accent-color: #ff8fab;
    --accent-dark-color: #f87197;
    --border-color: #424242;
}

/* --- 针对特定组件的夜间模式微调 --- */
body.dark-mode #chat-container {
    box-shadow: 0 0 30px rgba(255, 143, 171, 0.1);
}
body.dark-mode .settings-content,
body.dark-mode .feature-modal-content {
    background: #2D2D30;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
}
body.dark-mode .form-group label {
    color: #BDBDBD;
}
body.dark-mode .form-group input,
body.dark-mode .form-group select,
body.dark-mode .form-group textarea {
    background-color: #1E1E1E;
    border-color: #555;
    color: #E0E0E0;
}
body.dark-mode .form-group input:focus,
body.dark-mode .form-group select:focus,
body.dark-mode .form-group textarea:focus {
    border-color: var(--accent-color);
    box-shadow: 0 0 5px var(--accent-color);
}
body.dark-mode .close-btn,
body.dark-mode .feature-modal-close {
    color: #757575;
}
body.dark-mode .close-btn:hover,
body.dark-mode .feature-modal-close:hover {
    color: #BDBDBD;
}
body.dark-mode .data-zone button,
body.dark-mode .sticker-zone button {
    background-color: #333;
    border-color: var(--accent-color);
}
body.dark-mode .data-zone button:hover,
body.dark-mode .sticker-zone button:hover {
    background-color: var(--accent-color);
    color: white;
}
body.dark-mode .danger-zone button {
    border-color: var(--delete-color);
}
body.dark-mode .danger-zone button:hover {
    background-color: var(--delete-color);
}
body.dark-mode .chat-item {
    background-color: #2a2a2e;
    border-color: #444;
}
body.dark-mode .chat-item:hover {
    background-color: #3a3a40;
}
body.dark-mode .chat-item.active {
    border-color: var(--accent-color);
    background-color: #312a2c;
}
body.dark-mode .theme-option {
  background-color: #2D2D30;
}
body.dark-mode #load-more-btn {
    background-color: #333;
    color: #aaa;
}
body.dark-mode #load-more-btn:hover {
    background-color: #444;
}
body.dark-mode .moment-comments {
    background: #252525;
}
body.dark-mode .comment {
    border-bottom-color: #3a3a3a;
}
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500&family=ZCOOL+KuaiLe&family=Long+Cang&family=Zhi+Mang+Xing&family=Ma+Shan+Zheng&family=LXGW+WenKai+Mono+TC&family=Press+Start+2P&family=DotGothic16&family=VT323&family=Noto+Serif+TC:wght@400;500&family=Pacifico&family=ZCOOL+QingKe+HuangYou&display=swap');
        /* --- Global Styles & Variables --- */
        :root {
    --font-main: 'Cubic 11', 'Noto Sans JP', sans-serif;
    --font-ui: 'Cubic 11', 'Noto Sans JP', sans-serif;
    --font-logo: 'Pacifico', cursive;
    
    --bg-color: #FFFFFF;
    --chat-bg-color: rgba(255, 255, 255, 0.85);
    --header-bg-color: rgba(255, 255, 255, 0.95);
    --input-bg-color: #ffffff;
    --text-color: #5c5c5c;
    --text-light-color: #a0a0a0;
    --accent-color: #ff8fab;
    --accent-dark-color: #f87197;
    --border-color: #fde2e2;
    --delete-color: #ff6b6b;
    --success-color: #4CAF50;
    --notification-bg: rgba(255, 143, 171, 0.9);
    --red-packet-color: #e67e22;

    --base-font-size: 16px;
    --bubble-padding: 10px 15px;
    --ui-scale: 1.0;

    /* ...后面的颜色变量保持不变... */*/
    --ui-scale: 1.0; /* Default UI scale */

    /* Bubble Themes */
    /* 默认主题 */
    --theme1-ai-bg: #ffffff; --theme1-ai-text: #333333;
    --theme1-user-bg: #333333; --theme1-user-text: #ffffff;
    --theme2-ai-bg: #333333; --theme2-ai-text: #ffffff;
    --theme2-user-bg: #ffffff; --theme2-user-text: #333333;
    
        /* 修复字体色的旧主题 (已更新颜色) */
    --theme3-ai-bg: #F8F8F8; --theme3-ai-text: #333333;
    --theme3-user-bg: #BDE6F1; --theme3-user-text: #333333; /* 更浅的天蓝色 */
    --theme4-ai-bg: #F8F8F8; --theme4-ai-text: #333333;
    --theme4-user-bg: #C1E1C1; --theme4-user-text: #333333; /* 更浅的草绿色 */
    --theme5-ai-bg: #ffffff; --theme5-ai-text: #333333;
    --theme5-user-bg: #ffe4f1; --theme5-user-text: #c2185b; /* 樱花色 */

    /* 新增主题 (已更新AI灰色) */
    --theme6-ai-bg: #F8F8F8; --theme6-ai-text: #333333; /* 最浅灰 / 深空蓝 */
    --theme6-user-bg: #007aff; --theme6-user-text: #ffffff;
    --theme7-ai-bg: #5698d2; --theme7-ai-text: #333333; /* 马龙卡蓝 / 奶油黄 */
    --theme7-user-bg: #fff2cc; --theme7-user-text: #333333;
    --theme8-ai-bg: #ffffff; --theme8-ai-text: #333333; /* 微信日间 */
    --theme8-user-bg: #a9ea7a; --theme8-user-text: #333333;
    --theme9-ai-bg: #343434; --theme9-ai-text: #E5E5E5; /* 微信夜间 */
    --theme9-user-bg: #57BD61; --theme9-user-text: #343434;
    
    /* TASK 13: Add 4 New Bubble Themes (已更新AI灰色) */
    --theme10-ai-bg: #F8F8F8; --theme10-ai-text: #333333; /* 最浅的灰和次浅的灰 */
    --theme10-user-bg: #EFEFEF; --theme10-user-text: #333333;
    --theme11-ai-bg: #795548; --theme11-ai-text: #ffffff; /* 薄巧的薄荷色和薄巧的巧克力色 */
    --theme11-user-bg: #A8E6CF; --theme11-user-text: #333333; 
    --theme12-ai-bg: #A7D8F0; --theme12-ai-text: #333333; /* 捡手机文学的淡天空蓝和淡奶油黄 */
    --theme12-user-bg: #FFFACD; --theme12-user-text: #333333; 
    --theme13-ai-bg: #F8F8F8; --theme13-ai-text: #333333; /* 最浅的灰色和很浅的奶油黄 */
    --theme13-user-bg: #FFFDD0; --theme13-user-text: #333333;

    --ai-bubble-bg: var(--theme1-ai-bg);
    --ai-bubble-text: var(--theme1-ai-text);
    --user-bubble-bg: var(--theme1-user-bg);
    --user-bubble-text: var(--theme1-user-text);
}
        /* --- Base & Layout --- */
        html {
           /* TASK 9: Use CSS variable for base font size to allow scaling */
           font-size: var(--base-font-size); 
        }
        html, body { height: 100%; overflow: hidden; }
        body {
            font-family: var(--font-main);
            margin: 0; padding: 0;
            background-color: var(--bg-color);
            /* TASK 8: Remove background image */
            /* background-image: url('data:image/svg+xml,...'); */
            color: var(--text-color);
            transition: background-color 0.5s ease;
        }

        #chat-container {
            display: flex; flex-direction: column; height: 100%; max-width: 800px; margin: 0 auto;
            background-color: var(--chat-bg-color); backdrop-filter: blur(10px); box-shadow: 0 0 30px rgba(255, 143, 171, 0.15);
            transition: background-color 0.5s ease, transform 0.3s ease;
            position: relative;
            background-size: cover;
            background-repeat: no-repeat;
            background-position: center center;
            /* TASK 9: Apply UI scaling */
            transform: scale(var(--ui-scale));
            transform-origin: center center;
        }
        
        #top-notification {
            position: absolute; top: -60px; left: 5%; width: 90%;
            background-color: var(--notification-bg);
            color: white; text-align: center;
            padding: 10px; border-radius: 0 0 12px 12px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            font-family: var(--font-ui); font-size: 0.9em;
            z-index: 100; transition: top 0.5s ease-in-out;
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        #top-notification.show { top: 0; }
        #top-notification img { width: 24px; height: 24px; border-radius: 50%; }

        #chat-header {
            display: flex; justify-content: space-between; align-items: center; padding: 10px 15px;
            background-color: var(--header-bg-color); border-bottom: 1px solid var(--border-color); backdrop-filter: blur(5px); z-index: 10;
            flex-shrink: 0;
        }
        #chat-manager-btn { background: none; border: none; cursor: pointer; padding: 5px; }
        #chat-manager-btn svg { width: 26px; height: 26px; fill: var(--accent-color); transition: transform 0.3s ease, fill 0.3s ease; }
        #chat-manager-btn:hover svg { fill: var(--accent-dark-color); transform: scale(1.1); }
        
        /* TASK 7: Make header avatar circular and remove border */
        #header-avatar {
            width: 40px; height: 40px; border-radius: 50%; object-fit: cover;
            /* border: 2px solid var(--border-color); */
            cursor: pointer; transition: transform 0.2s ease;
        }
        #header-avatar:hover { transform: scale(1.1); }
        #chat-name-header { flex-grow: 1; text-align: center; font-size: 1.2em; font-weight: 500; color: var(--accent-dark-color); padding: 5px; border-radius: 5px; transition: background-color 0.2s; }
        #chat-name-header:focus { outline: 1px solid var(--accent-color); background-color: rgba(255, 143, 171, 0.1); }
        #settings-btn { background: none; border: none; cursor: pointer; padding: 5px; }
        #settings-btn svg { width: 24px; height: 24px; fill: var(--accent-color); transition: transform 0.3s ease, fill 0.3s ease; }
        #settings-btn:hover svg { transform: rotate(45deg); fill: var(--accent-dark-color); }
        
        #messages { flex-grow: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 5px; }
        #messages::-webkit-scrollbar { width: 6px; }
        #messages::-webkit-scrollbar-track { background: transparent; }
        #messages::-webkit-scrollbar-thumb { background-color: var(--accent-color); border-radius: 10px; }
        
        #load-more-btn {
            align-self: center; background-color: #f0f0f0; border: none; padding: 8px 15px;
            border-radius: 15px; cursor: pointer; color: #888; font-family: var(--font-ui);
            margin-bottom: 15px; transition: background-color 0.2s;
        }
        #load-more-btn:hover { background-color: #e0e0e0; }

        /* --- Message Bubbles --- */
        .message { display: flex; align-items: flex-end; gap: 10px; max-width: 80%; cursor: pointer; margin-bottom: 10px; }
        .message.user { align-self: flex-end; flex-direction: row-reverse; }
        .message.ai { align-self: flex-start; }
        .message .sender-name { font-size: 0.75em; color: #999; margin-bottom: 4px; padding: 0 5px; display: none; }
        .message.group-chat.ai .sender-name { display: block; }
        .message.system { align-self: center; background: #e0e0e0; color: #757575; font-size: 0.8em; padding: 4px 10px; border-radius: 10px; max-width: none; cursor: default; }
        .message.system .avatar, .message.system .timestamp { display: none; }
        .avatar { 
            width: 40px; height: 40px; 
            /* TASK 7: Make avatars circular and remove border */
            border-radius: 50%;
            object-fit: cover;
            /* border: 2px solid var(--border-color); */
            flex-shrink: 0;
        }
        .message-content { display: flex; flex-direction: column; }
        .message.user .message-content { align-items: flex-end; }
        .message.ai .message-content { align-items: flex-start; }
        .bubble { 
            /* TASK 9: Use CSS variable for padding */
            padding: var(--bubble-padding); 
            border-radius: 18px; position: relative;
            /* TASK 7: Remove box-shadow */
            /* box-shadow: 0 2px 5px rgba(0,0,0,0.05); */
            word-wrap: break-word; max-width: 100%; transition: transform 0.2s ease, border 0.2s ease, opacity 0.2s ease; 
        }
        :not(.custom-style-active) .message.ai .bubble { background-color: var(--ai-bubble-bg); color: var(--ai-bubble-text); }
        :not(.custom-style-active) .message.user .bubble { background-color: var(--user-bubble-bg); color: var(--user-bubble-text); }
        .message.ai .bubble { border-bottom-left-radius: 4px; }
        .message.user .bubble { border-bottom-right-radius: 4px; }
        .bubble p { margin: 0; }
        .timestamp { font-size: 0.7em; color: var(--text-light-color); margin-top: 5px; padding: 0 5px; }

        /* TASK 7: Style for "Read" status */
.message {
    position: relative; /* 关键：让整个消息容器作为“已读”的定位参考 */
}
.read-status {
    position: absolute; /* 使用绝对定位，让它“漂浮”起来 */
    top: -12px;         /* 向上移动，把它放到头像的上方区域 */
    font-size: 0.6em;   /* 保持小巧的字体 */
    color: var(--text-light-color);
    background-color: var(--chat-bg-color, white); /* 给一点背景色，避免和背景混淆 */
    padding: 1px 4px;
    border-radius: 5px;
    white-space: nowrap;
    opacity: 0.8;       /* 稍微透明一点，不那么抢眼 */
}
/* 用户消息的已读，定位在右侧头像上方 */
.message.user .read-status {
    right: 50px; /* 从右侧开始定位，50px大约是头像的宽度+间距 */
}
/* AI消息的已读，定位在左侧头像上方 */
.message.ai .read-status {
    left: 50px; /* 从左侧开始定位 */
}
        
        .multi-select-mode .message:not(.selected):not(.system) { opacity: 0.6; }
        .multi-select-mode .message.selected .bubble { transform: scale(1.03); border: 2px solid var(--accent-dark-color); }

        .typing-indicator { align-items: center; gap: 8px; font-size: 0.9em; font-style: italic; color: #aaa; }
        .typing-indicator .dot { width: 6px; height: 6px; background-color: #ccc; border-radius: 50%; animation: typing 1.4s infinite; }
        .typing-indicator .dot:nth-child(1) { animation-delay: 0.2s; }
        .typing-indicator .dot:nth-child(2) { animation-delay: 0.4s; }
        @keyframes typing { 0%, 60%, 100% { transform: translateY(0); } 30% { transform: translateY(-4px); } }

        /* --- Input Area & Action Panel --- */
        #bottom-panel { position: relative; flex-shrink: 0; background: var(--header-bg-color); }
        #input-area { display: flex; align-items: flex-end; padding: 10px 15px; border-top: 1px solid var(--border-color); transition: opacity 0.3s ease, visibility 0.3s ease; gap: 10px; }
        #action-btn { background: none; border: none; cursor: pointer; padding: 5px; margin-right: 5px; align-self: center; flex-shrink: 0;}
        #action-btn svg { width: 28px; height: 28px; fill: var(--accent-color); transition: transform 0.3s ease, fill 0.2s; }
        #action-btn:hover svg { fill: var(--accent-dark-color); }
        #message-input { flex-grow: 1; border: 1px solid var(--border-color); border-radius: 20px; padding: 10px 15px; font-size: 1em; font-family: var(--font-main); resize: none; transition: border-color 0.3s ease, box-shadow 0.3s ease; max-height: 100px; overflow-y: auto; }
        #message-input:focus { outline: none; border-color: var(--accent-color); box-shadow: 0 0 5px var(--accent-color); }
        
        /* TASK 5: Add styles for the new receive button */
        #receive-btn, #send-btn { background-color: var(--accent-color); border: none; border-radius: 50%; width: 44px; height: 44px; cursor: pointer; display: flex; justify-content: center; align-items: center; transition: background-color 0.3s ease, transform 0.2s ease; flex-shrink: 0; }
        #receive-btn:hover, #send-btn:hover { background-color: var(--accent-dark-color); transform: scale(1.1); }
        #send-btn:disabled { background-color: #f8c3d1; cursor: not-allowed; transform: scale(1); }
        #receive-btn svg, #send-btn svg { width: 20px; height: 20px; fill: white; }

        #action-panel { display: grid; grid-template-columns: repeat(auto-fill, minmax(70px, 1fr)); gap: 15px; padding: 0 20px; border-top: 1px solid var(--border-color); max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out, padding 0.3s ease-out; }
        #action-panel.show { max-height: 300px; padding-top: 20px; padding-bottom: 20px; }
        .action-item { display: flex; flex-direction: column; align-items: center; cursor: pointer; font-family: var(--font-ui); font-size: 0.8em; color: var(--text-color); }
        .action-item-icon { width: 50px; height: 50px; background-color: #fff; border: 1px solid var(--border-color); border-radius: 12px; display: flex; justify-content: center; align-items: center; margin-bottom: 5px; transition: all 0.2s ease; }
        .action-item:hover .action-item-icon { transform: translateY(-3px); box-shadow: 0 4px 10px rgba(255, 143, 171, 0.3); }
        .action-item-icon svg { width: 24px; height: 24px; fill: var(--accent-color); }

        /* --- Feature-Specific Bubbles --- */
        .bubble.message-image, .bubble.message-sticker { padding: 5px; background: transparent; box-shadow: none; }
        .bubble-image-content { max-width: 250px; max-height: 250px; border-radius: 15px; object-fit: cover; display: block; border: 1px solid var(--border-color); }
        
        .bubble.message-text-image { display: flex; flex-direction: column; gap: 8px; }
        .message.ai .bubble.message-text-image { background-color: var(--ai-bubble-bg); color: var(--ai-bubble-text); }
        .message.user .bubble.message-text-image { background-color: var(--user-bubble-bg); color: var(--user-bubble-text); }
        .text-image-header { display: flex; align-items: center; gap: 8px; font-size: 0.9em; opacity: 0.8;}
        .text-image-header svg { width: 18px; height: 18px; fill: currentColor; }
        .text-image-description { border-left: 2px solid var(--accent-color); padding-left: 10px; font-family: var(--font-ui); white-space: pre-wrap; }

        .bubble.message-voice { display: flex; align-items: center; gap: 10px; }
        .message.ai .bubble.message-voice { background: var(--ai-bubble-bg); color: var(--ai-bubble-text); }
        .message.user .bubble.message-voice { background: var(--user-bubble-bg); color: var(--user-bubble-text); }
        .voice-icon svg { width: 20px; height: 20px; fill: currentColor; }
        .voice-duration { font-family: var(--font-ui); }

        .bubble.message-transfer { padding: 0; border-radius: 12px; overflow: hidden; background: #ff7675; color: white; width: 240px; position: relative; cursor: default; }
        .message.ai .bubble.message-transfer { cursor: pointer; }
        .transfer-cover { width: 100%; height: 110px; object-fit: cover; display: block; }
        .transfer-info { padding: 10px 15px; }
        .transfer-amount { font-size: 1.4em; font-weight: bold; font-family: var(--font-ui); }
        .transfer-memo { font-size: 0.9em; opacity: 0.9; margin-top: 5px; }
        .transfer-footer { font-size: 0.7em; opacity: 0.8; padding: 5px 15px; background: rgba(0,0,0,0.1); }
        .transfer-acknowledged { position: absolute; top:0; left:0; right:0; bottom:0; background: rgba(0,0,0,0.3); backdrop-filter: blur(2px); display:flex; justify-content:center; align-items:center; color:white; font-family:var(--font-ui); font-size:1.1em; }

        /* Red Packet Bubble */
        .bubble.message-red-packet { width: 250px; padding: 0; background: var(--red-packet-color); border-radius: 12px; color: white; }
        .red-packet-body { padding: 15px; }
        .red-packet-body-header { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        .red-packet-body-header svg { width: 32px; height: 32px; fill: white; }
        .red-packet-memo { font-size: 1.1em; }
        .red-packet-grab-btn { background: #f39c12; border: none; color: white; width: 100%; padding: 12px; font-size: 1.1em; cursor: pointer; transition: background-color 0.2s; font-family: var(--font-main); }
        .red-packet-grab-btn:hover { background: #f1c40f; }
        .red-packet-footer { font-size: 0.75em; padding: 5px 15px; background: rgba(0,0,0,0.1); }
        .red-packet-results { padding: 10px; background: white; color: var(--text-color); border-radius: 0 0 12px 12px; }
        .red-packet-result-item { display: flex; justify-content: space-between; padding: 4px 5px; font-size: 0.85em; }

        /* Poll Bubble */
        .bubble.message-poll { background: #fff; border: 1px solid var(--border-color); padding: 15px; color: var(--text-color); max-width: 280px; }
        .poll-question { font-weight: 500; margin-bottom: 15px; font-size: 1.05em; color: var(--accent-dark-color); }
        .poll-option { margin-bottom: 10px; }
        .poll-option-label { display: block; margin-bottom: 5px; font-size: 0.9em; }
        .poll-progress-bar { background: #f0f0f0; border-radius: 5px; overflow: hidden; height: 20px; position: relative; }
        .poll-progress-fill { background: linear-gradient(45deg, var(--accent-color), #ffb8ca); height: 100%; border-radius: 5px; transition: width 0.5s ease; display: flex; align-items: center; justify-content: flex-end; padding-right: 5px; box-sizing: border-box; }
        .poll-percentage { color: white; font-size: 0.8em; font-weight: bold; text-shadow: 1px 1px 2px rgba(0,0,0,0.2); }
        .poll-voters { display: flex; flex-wrap: wrap; gap: 4px; margin-top: 5px; padding-left: 2px; }
        .poll-voter-avatar { width: 20px; height: 20px; border-radius: 50%; object-fit: cover; border: 1px solid white; box-shadow: 0 0 2px rgba(0,0,0,0.2); }
        .poll-vote-btn { background: #f7f7f7; border: 1px solid #ddd; border-radius: 8px; padding: 8px 12px; cursor: pointer; font-size: 0.9em; transition: all 0.2s ease; display: block; width: 100%; margin-top: 8px; text-align: center; }
        .poll-vote-btn:hover { background: #eee; border-color: #ccc; }
        .poll-vote-btn.voted, .poll-vote-btn:disabled { background: var(--accent-color); color: white; border-color: var(--accent-color); cursor: not-allowed; opacity: 0.7; }

        /* --- Generic & Specific Modals --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.4); backdrop-filter: blur(5px); display: none; justify-content: center; align-items: center; z-index: 2001; animation: fadeIn 0.3s ease; }
        .modal-overlay.show { display: flex; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
        .modal-overlay.hiding { animation: fadeOut 0.3s ease forwards; }

        .feature-modal-content { font-family: var(--font-ui); background: #fff; padding: 25px 35px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); width: 90%; max-width: 450px; animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes slideOut { from { transform: translateY(0); opacity: 1; } to { transform: translateY(20px); opacity: 0; } }
        .modal-overlay.hiding .feature-modal-content { animation: slideOut 0.3s ease-out forwards; }
        
        .feature-modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .feature-modal-header h3 { margin: 0; font-family: var(--font-logo); color: var(--accent-dark-color); font-size: 1.8em; }
        .feature-modal-close { background: none; border: none; font-size: 2em; color: #ccc; cursor: pointer; transition: color 0.3s ease, transform 0.3s ease; }
        .feature-modal-close:hover { color: #999; transform: rotate(90deg); }
        .feature-modal-body .form-group { margin-bottom: 15px; }
        .feature-modal-body .form-group input, .feature-modal-body .form-group textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-family: var(--font-ui); box-sizing: border-box; }
        .feature-modal-footer { text-align: right; margin-top: 20px; }
        .feature-modal-submit-btn { padding: 10px 20px; background: var(--accent-dark-color); color: white; border: none; border-radius: 8px; cursor: pointer; }
        
        #mind-voice-modal-content { background: rgba(0,0,0,0.7); color: white; padding: 25px; border-radius: 15px; max-width: 90%; max-height: 70vh; overflow-y: auto; font-family: var(--font-ui); font-size: 1.1em; line-height: 1.6; border: 1px solid rgba(255,255,255,0.2); }
        #mind-voice-modal-content p { margin: 0; }
        #mind-voice-close-btn { position: absolute; top: 15px; right: 15px; background: none; border: none; font-size: 2.5em; color: white; cursor: pointer; line-height: 1; text-shadow: 0 0 5px black; }

        #sticker-gallery { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 10px; max-height: 300px; overflow-y: auto; padding: 5px; border: 1px solid #eee; border-radius: 8px; }
        #sticker-gallery img { width: 100%; height: 80px; object-fit: cover; border-radius: 8px; cursor: pointer; transition: transform 0.2s; }
        #sticker-gallery img:hover { transform: scale(1.1); }

        #video-call-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 1001; display: none; flex-direction: column; justify-content: space-between; align-items: center; color: white; font-family: var(--font-ui); padding: 20px; box-sizing: border-box; }
        #video-call-overlay.show { display: flex; }
        .video-main-view { width: 100%; height: 100%; position: absolute; top: 0; left: 0; object-fit: cover; opacity: 0.3; z-index: -1; }
        .video-self-view { position: absolute; top: 20px; right: 20px; width: 100px; height: 150px; border: 2px solid white; border-radius: 12px; object-fit: cover; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .video-character-info { z-index: 2; text-align: center; margin-top: 6vh; flex-shrink: 0; }
        .video-character-info .avatar { width: 120px; height: 120px; border-radius: 50%; border: 4px solid white; }
        .video-character-info h2 { margin: 10px 0 5px 0; font-size: 1.8em; }
        .video-character-info p { font-size: 1em; color: #eee; }
        #video-chat-log { z-index: 2; width: 100%; max-width: 500px; flex-grow: 1; margin-top: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; }
        #video-chat-log::-webkit-scrollbar { display: none; }
        .video-chat-message { padding: 8px 12px; border-radius: 12px; max-width: 70%; word-wrap: break-word; font-family: var(--font-main); }
        .video-chat-message i { font-style: italic; opacity: 0.8; }
        .video-chat-message.user { background: rgba(255,255,255,0.2); align-self: flex-end; }
        .video-chat-message.ai { background: rgba(0,0,0,0.2); align-self: flex-start; }
        #video-input-area { z-index: 2; display: flex; width: 100%; max-width: 520px; margin: 15px 0; gap: 10px; flex-shrink: 0; }
        #video-message-input { flex-grow: 1; background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.3); color: white; border-radius: 18px; padding: 8px 15px; font-family: var(--font-main); }
        #video-message-input::placeholder { color: rgba(255,255,255,0.6); }
        #video-send-btn { background: var(--accent-color); border: none; border-radius: 18px; color: white; padding: 8px 18px; cursor: pointer; font-family: var(--font-ui); }
        .video-controls { z-index: 2; margin-bottom: 2vh; display: flex; gap: 40px; flex-shrink: 0; }
        .video-btn { width: 70px; height: 70px; border-radius: 50%; border: none; cursor: pointer; display: flex; justify-content: center; align-items: center; }
        .video-btn svg { width: 35px; height: 35px; fill: white; }
        .video-btn.accept { background-color: var(--success-color); }
        .video-btn.decline { background-color: var(--delete-color); }
        
        #delete-toolbar { position: absolute; bottom: 0; left: 0; width: 100%; box-sizing: border-box; background: var(--header-bg-color); padding: 15px 20px; border-top: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; z-index: 5; }
        #delete-toolbar.show { opacity: 1; visibility: visible; }
        #delete-info { font-family: var(--font-ui); color: var(--text-color); }
        #delete-actions button { font-family: var(--font-ui); font-size: 0.9em; padding: 8px 16px; border: none; border-radius: 10px; cursor: pointer; transition: background-color 0.2s ease; }
        #confirm-delete-btn { background-color: var(--delete-color); color: white; margin-right: 10px; }
        #cancel-delete-btn { background-color: #eee; color: #555; }
        
        .settings-content { background: #fff; padding: 25px 35px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); width: 90%; max-width: 600px; max-height: 90vh; display: flex; flex-direction: column; font-family: var(--font-ui); }
        .settings-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 15px; }
        .settings-header h2 { margin: 0; font-family: var(--font-logo); color: var(--accent-dark-color); font-size: 2em; }
        .close-btn { background: none; border: none; font-size: 2em; color: #ccc; cursor: pointer; transition: color 0.3s ease, transform 0.3s ease; }
        .close-btn:hover { color: #999; transform: rotate(90deg); }
        .settings-body { overflow-y: auto; padding-right: 15px; }
        .settings-body::-webkit-scrollbar { width: 5px; }
        .settings-body::-webkit-scrollbar-track { background: #f1f1f1; }
        .settings-body::-webkit-scrollbar-thumb { background: #ddd; border-radius: 10px; }
        .settings-section { margin-bottom: 25px; }
        .settings-section h3 { margin: 0 0 15px 0; font-weight: 500; color: var(--accent-color); border-left: 3px solid var(--accent-color); padding-left: 10px; }
        .form-group { margin-bottom: 15px; display: flex; flex-direction: column; }
        .form-group label { margin-bottom: 5px; font-size: 0.9em; color: #666; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-family: var(--font-ui); box-sizing: border-box; transition: border-color 0.3s, box-shadow 0.3s; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: var(--accent-color); box-shadow: 0 0 5px var(--accent-color); }
        .form-group textarea { min-height: 120px; resize: vertical; }
        .model-group { display: flex; align-items: center; gap: 10px; }
        .model-group button { padding: 10px 15px; background: var(--accent-color); color: white; border: none; border-radius: 8px; cursor: pointer; transition: background-color 0.3s ease; white-space: nowrap; }
        .avatar-upload-group { display: flex; align-items: center; gap: 15px; }
        /* TASK 7: Make preview avatars circular */
        .avatar-preview { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; border: 2px dashed var(--border-color); }
        .file-input-label { background: #f7f7f7; border: 1px solid #ddd; border-radius: 8px; padding: 8px 12px; cursor: pointer; font-size: 0.9em; transition: background-color 0.3s ease; display: inline-block; text-align: center; }
        .theme-selector { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 10px; }
        .theme-option { flex-grow: 1; padding: 10px; border-radius: 8px; cursor: pointer; border: 2px solid transparent; text-align: center; transition: all 0.3s ease; }
        .theme-option.active { border-color: var(--accent-dark-color); font-weight: 500; }
        .theme-option span { display: block; width: 20px; height: 20px; border-radius: 5px; margin: 5px auto 0 auto; background: var(--user-bubble-bg); }
        #theme1 { background: #f9f9f9; } #theme1 span { background: var(--theme1-user-bg); }
        #theme2 { background: #f9f9f9; } #theme2 span { background: var(--theme2-user-bg); }
        #theme3 { background: #f9f9f9; } #theme3 span { background: var(--theme3-user-bg); }
        #theme4 { background: #f9f9f9; } #theme4 span { background: var(--theme4-user-bg); }
        #theme5 { background: #f9f9f9; } #theme5 span { background: var(--theme5-user-bg); }
        .data-zone button, .sticker-zone button { width: 100%; padding: 10px; background-color: #fff; color: var(--accent-color); border: 1px solid var(--accent-color); border-radius: 8px; cursor: pointer; transition: background-color 0.2s, color 0.2s; }
        .data-zone button:hover, .sticker-zone button:hover { background-color: var(--accent-color); color: white; border-color: var(--accent-color); }
        .danger-zone button { color: var(--delete-color); border-color: var(--delete-color); }
        .danger-zone button:hover { background-color: var(--delete-color); color: white; border-color: var(--delete-color); }
        #delete-character-btn { margin-top: 10px; }
        .settings-footer { margin-top: 20px; text-align: right; border-top: 1px solid #eee; padding-top: 20px; }
        #save-settings-btn { padding: 12px 25px; font-size: 1em; font-weight: 500; background: var(--accent-dark-color); color: white; border: none; border-radius: 10px; cursor: pointer; transition: background-color 0.3s ease, transform 0.2s ease; }
        #save-settings-btn:hover { background-color: #e06387; transform: translateY(-2px); }

        /* --- Moments (朋友圈) Modal --- */
        #moments-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fdfdfd; z-index: 2000; display: none; flex-direction: column; }
        #moments-overlay.show { display: flex; animation: fadeIn 0.3s ease; }
        
        #moments-feed-container { flex-grow: 1; overflow-y: auto; background-color: #fff; }
        
        #moments-cover-area { position: relative; width: 100%; height: 35vh; background-color: #eee; background-size: cover; background-position: center; flex-shrink: 0; }
        #moments-user-info { position: absolute; bottom: -25px; right: 20px; display: flex; align-items: flex-end; gap: 15px; }
        #moments-user-name { color: white; font-size: 1.2em; text-shadow: 1px 1px 3px rgba(0,0,0,0.5); margin-bottom: 5px; font-weight: bold; }
        /* TASK 7: Make moments avatar circular */
        #moments-user-avatar { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 3px solid white; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        
        #moments-header { position: absolute; top: 0; left: 0; width: 100%; display: flex; align-items: center; justify-content: space-between; padding: 15px; box-sizing: border-box; background: linear-gradient(to bottom, rgba(0,0,0,0.3), transparent); }
        #moments-close-btn { background: rgba(0,0,0,0.2); border: none; color: white; width: 30px; height: 30px; border-radius: 50%; font-size: 1.5em; line-height: 30px; text-align: center; cursor: pointer; transition: background-color 0.2s; }
        #moments-close-btn:hover { background: rgba(0,0,0,0.4); }
        #post-new-moment-btn { background: rgba(255,255,255,0.9); border: none; color: var(--accent-dark-color); padding: 8px; border-radius: 50%; cursor: pointer; box-shadow: 0 1px 5px rgba(0,0,0,0.1); }
        #post-new-moment-btn svg { width: 24px; height: 24px; display: block; }

        #moments-feed { padding-top: 45px; } /* Space for cover overlap */
        .moment-post { border-bottom: 1px solid #f0f0f0; padding: 15px 20px; display: flex; gap: 12px; }
        .moment-post:last-child { border-bottom: none; }
        /* TASK 7: Make moment post avatars circular */
        .moment-avatar { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; flex-shrink: 0; cursor: pointer; }
        .moment-body { flex-grow: 1; }
        .moment-username { font-weight: 500; color: var(--accent-dark-color); margin-bottom: 8px; }
        .moment-content { margin-bottom: 10px; font-size: 0.95em; line-height: 1.6; color: #444; white-space: pre-wrap; }
        .moment-image-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 5px; margin-bottom: 10px; }
        .moment-image-grid img { width: 100%; height: 100px; object-fit: cover; border-radius: 8px; }
        .moment-image { width: 100%; max-width: 300px; border-radius: 12px; object-fit: cover; margin-bottom: 10px; }
        .moment-footer { display: flex; justify-content: space-between; align-items: center; font-size: 0.8em; color: var(--text-light-color); }
        .moment-actions button { background: none; border: none; cursor: pointer; color: var(--text-light-color); padding: 5px 8px; border-radius: 5px; transition: background-color 0.2s, color 0.2s; }
        .moment-actions button:hover { background-color: #fcefee; }
        .moment-actions button.liked { color: var(--accent-dark-color); font-weight: bold; }
        .moment-actions button svg { width: 16px; height: 16px; vertical-align: middle; margin-right: 4px; }
        
        .moment-comments { margin-top: 10px; background: #fafafa; border-radius: 8px; padding: 2px 10px; }
        .comment { padding: 6px 0; border-bottom: 1px solid #f0f0f0; font-size: 0.9em; }
        .comment:last-child { border-bottom: none; }
        .comment-user { color: var(--accent-color); font-weight: 500; }
        .comment-text { cursor: pointer; }
           /* -- 我们不再需要嵌套样式了，所以把它注释掉 -- */
    /*
    .comment .replies {
        padding-left: 20px;
        margin-top: 8px;
        border-left: 2px solid #eee;
    }
    */

        /* TASK 4: Fix comment input form CSS */
        .comment-input-form { 
            display: flex; 
            margin-top: 8px; 
            gap: 5px; 
            width: 100%; /* Ensure it doesn't overflow */
            box-sizing: border-box; /* Include padding in width calculation */
        }
        .comment-input-form input { flex-grow: 1; border: 1px solid #eee; border-radius: 15px; padding: 5px 10px; font-size: 0.9em; font-family: var(--font-ui); min-width: 0; /* Allow input to shrink */ }
        .comment-input-form input:focus { border-color: var(--accent-color); outline: none; }
        .comment-input-form button { background: var(--accent-color); color: white; border: none; border-radius: 15px; padding: 5px 12px; font-size: 0.85em; cursor: pointer; flex-shrink: 0; }

        /* --- Chat Management (Character & Group) Modal --- */
        .chat-manager-tabs { display: flex; border-bottom: 1px solid var(--border-color); margin-bottom: 15px; }
        .chat-manager-tab { padding: 10px 20px; cursor: pointer; font-size: 1.1em; color: var(--text-light-color); position: relative; }
        .chat-manager-tab.active { color: var(--accent-dark-color); font-weight: 500; }
        .chat-manager-tab.active::after { content: ''; position: absolute; bottom: -1px; left: 0; right: 0; height: 2px; background-color: var(--accent-dark-color); }
        .chat-manager-content { display: none; }
        .chat-manager-content.active { display: block; }
        .chat-list { max-height: 50vh; overflow-y: auto; padding-right: 10px; }
        .chat-item { display: flex; align-items: center; padding: 12px; border-radius: 10px; margin-bottom: 10px; cursor: pointer; transition: background-color 0.2s; border: 1px solid #eee; }
        .chat-item:hover { background-color: #fcf6f8; }
        .chat-item.active { background-color: var(--bg-color); border-color: var(--accent-color); }
        /* TASK 7: Make chat list item avatars circular */
        .chat-item img { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; margin-right: 15px; }
        .chat-item .name { font-weight: 500; font-size: 1.1em; flex-grow: 1; }
        .chat-item .delete-btn { background: none; border: none; cursor: pointer; color: #ccc; font-size: 1.5em; padding: 0 5px; transition: color 0.2s; }
        .chat-item .delete-btn:hover { color: var(--delete-color); }
        .add-new-btn { width: 100%; padding: 12px; background-color: var(--accent-color); color: white; border: none; border-radius: 10px; cursor: pointer; font-size: 1em; font-family: var(--font-ui); margin-top: 15px; }
        #create-group-members { max-height: 200px; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px; padding: 10px; }
        .member-select-item { display: flex; align-items: center; gap: 10px; padding: 8px; border-radius: 8px; }
        .member-select-item:hover { background: #f7f7f7; }
        .member-select-item input[type=checkbox] { width: 20px; height: 20px; cursor: pointer; }
    
        /* Diary Modal */
        #diary-modal-content {
            font-family: var(--font-ui); background: #fff8f5; padding: 25px 35px; border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1); width: 90%; max-width: 500px; max-height: 80vh;
            display: flex; flex-direction: column;
        }
        #diary-header {
            text-align: center; font-family: var(--font-logo); color: var(--accent-dark-color);
            font-size: 2em; padding-bottom: 15px; border-bottom: 2px dashed var(--border-color); margin-bottom: 15px;
        }
        #diary-entries { flex-grow: 1; overflow-y: auto; padding-right: 10px; }
        .diary-entry {
            background: rgba(255, 255, 255, 0.7); border-radius: 10px; padding: 15px;
            margin-bottom: 15px; border-left: 4px solid var(--accent-color);
            position: relative; /* For delete button positioning */
        }
        .diary-date { font-weight: bold; color: var(--accent-dark-color); margin-bottom: 8px; }
        .diary-content { line-height: 1.7; color: #555; white-space: pre-wrap; }
        /* TASK 2: Style for diary delete button */
        .diary-delete-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            color: #ccc;
            cursor: pointer;
            font-size: 1.5em;
            line-height: 1;
            transition: color 0.2s;
        }
        .diary-delete-btn:hover {
            color: var(--delete-color);
        }
        /* --- 全新的气泡样式切换 --- */
/* 这是默认样式的“尾巴”，我们先把它定义好 */
.message.ai .bubble { border-bottom-left-radius: 4px; }
.message.user .bubble { border-bottom-right-radius: 4px; }

/* 这是“圆滚滚”样式的定义 */
.bubble-style-round .message .bubble {
    border-radius: 25px !important; /* 让四个角都变得圆滚滚！!important是给它最高优先级 */
}
      /* --- 仿微信尖角样式 --- */
.bubble-style-wechat .message .bubble {
    border-radius: 5px !important; /* 微信的圆角比较小 */
}
.bubble-style-wechat .message .bubble::before {
    content: '';
    position: absolute;
    width: 0;
    height: 0;
    border-top: 6px solid transparent;
    border-bottom: 6px solid transparent;
    top: 14px;
}
.bubble-style-wechat .message.ai .bubble::before {
    left: -8px;
    border-right: 10px solid var(--ai-bubble-bg, #ffffff);
}
.bubble-style-wechat .message.user .bubble::before {
    right: -8px;
    border-left: 10px solid var(--user-bubble-bg, #95ec69);
}
      /* =============================================================== */
/* ================= 新增的预设和滑块功能的CSS样式 ================= */
/* =============================================================== */
.preset-item {
    background: #f9f9f9;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 15px;
    display: flex;
    flex-direction: column;
    gap: 10px;
}
.preset-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.preset-header .form-group {
    flex-grow: 1;
    margin-bottom: 0;
}
.preset-header .form-group input {
    font-weight: 500;
}
.preset-actions {
    display: flex;
    align-items: center;
    gap: 15px;
    flex-shrink: 0;
    margin-left: 15px;
}
.preset-delete-btn {
    background: #ffcccc;
    border: 1px solid #ff9999;
    color: #c53030;
    border-radius: 5px;
    padding: 5px 8px;
    cursor: pointer;
    font-size: 0.8em;
}
.preset-toggle {
    position: relative;
    display: inline-block;
    width: 50px;
    height: 28px;
}
.preset-toggle input {
    opacity: 0;
    width: 0;
    height: 0;
}
.preset-toggle .slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #ccc;
    transition: .4s;
    border-radius: 28px;
}
.preset-toggle .slider:before {
    position: absolute;
    content: "";
    height: 20px;
    width: 20px;
    left: 4px;
    bottom: 4px;
    background-color: white;
    transition: .4s;
    border-radius: 50%;
}
.preset-toggle input:checked + .slider {
    background-color: var(--accent-color);
}
.preset-toggle input:checked + .slider:before {
    transform: translateX(22px);
}

input[type=range] {
  -webkit-appearance: none;
  width: 100%;
  margin: 7px 0;
  background: transparent;
}
input[type=range]:focus {
  outline: none;
}
input[type=range]::-webkit-slider-runnable-track {
  width: 100%;
  height: 6px;
  cursor: pointer;
  background: #f0f0f0;
  border-radius: 3px;
  border: 1px solid #ddd;
}
input[type=range]::-webkit-slider-thumb {
  border: 2px solid var(--accent-color);
  height: 20px;
  width: 20px;
  border-radius: 50%;
  background: #ffffff;
  cursor: pointer;
  -webkit-appearance: none;
  margin-top: -8px;
}
      /* =================================================== */
/* ================ 紧凑模式 (类微信风格) =============== */
/* =================================================== */

/* --- 整体布局与间距 --- */
.compact-mode #chat-header {
    padding: 8px 12px;
}
.compact-mode #messages {
    padding: 15px;
}
.compact-mode .message {
    gap: 8px;
    margin-bottom: 8px;
}

/* --- 头像缩小 --- */
.compact-mode #header-avatar,
.compact-mode .message .avatar {
    width: 36px;
    height: 36px;
}

/* --- 消息气泡与字体 --- */
.compact-mode .bubble {
    /* TASK 9: Use variable for padding */
    padding: var(--bubble-padding);
    font-size: 0.95em; /* 字体也稍微缩小一点 */
}
.compact-mode .timestamp {
    font-size: 0.65em;
    margin-top: 4px;
}

/* --- 核心：输入区域紧凑化 --- */
.compact-mode #input-area {
    padding: 8px 12px;
    align-items: center; /* 垂直居中对齐，更像微信 */
}
.compact-mode #message-input {
    padding: 8px 12px;
    font-size: 0.95em;
    border-radius: 18px;
    max-height: 90px; /* 限制输入框最大高度 */
}
.compact-mode #action-btn svg {
    width: 24px;
    height: 24px;
}
.compact-mode #send-btn, .compact-mode #receive-btn {
    width: 38px;
    height: 38px;
}
.compact-mode #send-btn svg, .compact-mode #receive-btn svg {
    width: 18px;
    height: 18px;
}

/* --- 其他功能图标微调 --- */
.compact-mode .action-item-icon {
    width: 45px;
    height: 45px;
}
.compact-mode .action-item {
    font-size: 0.75em;
}

      #streak-notification {
    background: linear-gradient(135deg, #fff0f5, rgba(255, 255, 255, 0.9)); /* 粉白渐变背景 */
    color: #e85a70; /* 柔和的粉红色字体 */
    font-family: 'LXGW WenKai Mono TC', cursive; /* 使用我们可爱的繁体字体 */
    font-size: 0.85em;
    padding: 6px 12px;
    margin: 8px 15%; /* 左右留白，让它变成长条形 */
    border-radius: 15px; /* 圆角 */
    box-shadow: 0 2px 8px rgba(232, 90, 112, 0.15); /* 淡淡的粉色阴影 */
    
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px; /* 图标和文字的间距 */

    /* 默认隐藏，带动画效果 */
    opacity: 0;
    max-height: 0;
    overflow: hidden;
    transition: all 0.5s ease-in-out;
}

#streak-notification.show {
    opacity: 1;
    max-height: 40px; /* 控制它展开后的高度 */
    margin-top: 8px;
    margin-bottom: 8px;
}

#streak-notification #streak-icon svg {
    fill: #ff8fab; /* 图标填充为可爱的粉色 */
    vertical-align: middle; /* 垂直居中对齐 */
    position: relative;
    top: -1px;
}
/* ============================================================== */
/* ========================= CSS样式结束 ========================== */
/* ============================================================== */
    </style>
  <style id="custom-bubble-style-tag"></style>
</head>
<body>
    <div id="chat-container">
        <div id="top-notification">
            <img id="notification-avatar" src="">
            <span id="notification-text"></span>
        </div>
        <div id="chat-header">
            <button id="chat-manager-btn" title="切换聊天">
                <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M16.5 12c1.38 0 2.5-1.12 2.5-2.5S17.88 7 16.5 7C15.12 7 14 8.12 14 9.5s1.12 2.5 2.5 2.5zM9 11c1.66 0 3-1.34 3-3S10.66 5 9 5C7.34 5 6 6.34 6 8s1.34 3 3 3zm7.5 3c-1.83 0-5.5.92-5.5 2.75V19h11v-2.25c0-1.83-3.67-2.75-5.5-2.75zM9 13c-2.33 0-7 1.17-7 3.5V19h7v-2.25c0-.85.33-2.34 2.37-3.47C10.5 13.1 9.66 13 9 13z"/></svg>
            </button>
            <img id="header-avatar" src="" title="读取他的心声 / 群组信息">
            <h1 id="chat-name-header" contenteditable="true"></h1>
            <button id="settings-btn" title="设置">
                <svg viewBox="0 0 24 24"><path d="M19.43 12.98c.04-.32.07-.64.07-.98s-.03-.66-.07-.98l2.11-1.65c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.3-.61-.22l-2.49 1c-.52-.4-1.08-.73-1.69-.98l-.38-2.65C14.46 2.18 14.25 2 14 2h-4c-.25 0-.46.18-.49.42l-.38 2.65c-.61.25-1.17-.59-1.69-.98l-2.49-1c-.23-.09-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64l2.11 1.65c-.04.32-.07.65-.07.98s.03.66.07.98l-2.11 1.65c-.19.15-.24.42-.12-.64l2 3.46c.12.22.39.3.61.22l2.49 1c.52.4 1.08.73 1.69.98l.38 2.65c.03.24.24.42.49.42h4c.25 0 .46-.18.49.42l.38-2.65c.61-.25 1.17-.59 1.69-.98l2.49 1c.23.09.49 0 .61.22l2-3.46c.12-.22.07-.49-.12-.64l-2.11-1.65zM12 15.5c-1.93 0-3.5-1.57-3.5-3.5s1.57-3.5 3.5-3.5 3.5 1.57 3.5 3.5-1.57 3.5-3.5 3.5z"/></svg>
            </button>
        </div>

        <div id="messages"></div>

        <div id="bottom-panel">
            <div id="action-panel">
                <div class="action-item" id="action-show-moments">
                    <div class="action-item-icon"><svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M20 2H4c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM8 20H4v-4h4v4zm0-6H4v-4h4v4zm0-6H4V4h4v4zm6 12h-4v-4h4v4zm0-6h-4v-4h4v4zm0-6h-4V4h4v4zm6 12h-4v-4h4v4zm0-6h-4v-4h4v4zm0-6h-4V4h4v4z"/></svg></div>
                    <span>朋友圈</span>
                </div>
                <div class="action-item" id="action-send-text-image">
                    <div class="action-item-icon"><svg viewBox="0 0 24 24"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg></div>
                    <span>图文说明</span>
                </div>
                <div class="action-item" id="action-send-voice">
                    <div class="action-item-icon"><svg viewBox="0 0 24 24"><path d="M12 14c1.66 0 2.99-1.34 2.99-3L15 5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.3-3c0 3-2.54 5.1-5.3 5.1S6.7 14 6.7 11H5c0 3.41 2.72 6.23 6 6.72V21h2v-3.28c3.28-.48 6-3.3 6-6.72h-1.7z"/></svg></div>
                    <span>语音</span>
                </div>
                <div class="action-item" id="action-send-transfer">
                     <div class="action-item-icon"><svg viewBox="0 0 24 24"><path d="M20 4H4c-1.11 0-2 .89-2 2v12c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V6c0-1.11-.89-2-2-2zm-1 14H5c-.55 0-1-.45-1-1V7c0-.55.45-1 1-1h14c.55 0 1 .45 1 1v10c0 .55-.45 1-1 1zM9 14h6c.55 0 1-.45 1-1s-.45-1-1-1H9c-.55 0-1 .45-1 1s.45 1 1 1zm-2.5-4c.83 0 1.5-.67 1.5-1.5S7.33 7 6.5 7 5 7.67 5 8.5 5.67 10 6.5 10z"/></svg></div>
                    <span>转账</span>
                </div>
                 <div class="action-item" id="action-send-red-packet">
                    <div class="action-item-icon"><svg style="fill: var(--red-packet-color);" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 4H6C4.9 4 4 4.9 4 6v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm-6 11.5c-2.49 0-4.5-2.01-4.5-4.5S9.51 6.5 12 6.5s4.5 2.01 4.5 4.5-2.01 4.5-4.5 4.5z"/><path d="M12 8.5c-1.38 0-2.5 1.12-2.5 2.5s1.12 2.5 2.5 2.5 2.5-1.12 2.5-2.5-1.12-2.5-2.5-2.5z"/></svg></div>
                    <span>红包</span>
                </div>
                 <div class="action-item" id="action-send-sticker">
                    <div class="action-item-icon"><svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1.5-6.5c.83 0 1.5.67 1.5 1.5s-.67 1.5-1.5 1.5-1.5-.67-1.5-1.5.67-1.5 1.5-1.5zm3-2c.83 0 1.5.67 1.5 1.5s-.67 1.5-1.5 1.5-1.5-.67-1.5-1.5.67-1.5 1.5-1.5zM8 12.5c0 .83-.67 1.5-1.5 1.5S5 13.33 5 12.5 5.67 11 6.5 11s1.5.67 1.5 1.5z"/></svg></div>
                    <span>表情</span>
                </div>
                 <div class="action-item" id="action-video-call">
                    <div class="action-item-icon"><svg viewBox="0 0 24 24"><path d="M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4z"/></svg></div>
                    <span>视频</span>
                </div>
                 <div class="action-item" id="action-send-real-image">
                    <div class="action-item-icon"><svg viewBox="0 0 24 24" style="fill: #8BC34A"><path d="M4 4h7V2H4c-1.1 0-2 .9-2 2v7h2V4zm6 9-3 3.99h12l-4-5.01-3.01 4.02L9 15l-2-2.01zM20 2h-7v2h7v7h2V4c0-1.1-.9-2-2-2zM4 13H2v7c0 1.1.9 2 2 2h7v-2H4v-7z"/></svg></div>
                    <span>相册</span>
                </div>
                <div class="action-item" id="action-create-poll">
                    <div class="action-item-icon"><svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px"><path d="M0 0h24v24H0z" fill="none"/><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-4h2v4zm4 0h-2v-2h2v2zm0-4h-2V7h2v6zm4 4h-2v-6h2v6z"/></svg></div>
                    <span>投票</span>
                </div>
                <div class="action-item" id="action-show-diary">
                    <div class="action-item-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-6 2c1.1 0 2 .9 2 2s-.9 2-2 2-2-.9-2-2 .9-2 2-2zm6 16H6v-1c0-2 4-3.1 6-3.1s6 1.1 6 3.1v1z"/></svg></div>
                    <span>日记</span>
                </div>
            </div>
            <!-- TASK 5: Modify input area to include receive button -->
            <div id="input-area">
                 <button id="action-btn" title="其他功能">
                     <svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
                </button>
                <textarea id="message-input" placeholder="输入消息..." rows="1"></textarea>
                <button id="send-btn" title="发送">
                    <svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
                </button>
                <button id="receive-btn" title="接收消息">
                    <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM17 13l-5 5-5-5h3V9h4v4h3z"/></svg>
                </button>
            </div>
            <div id="delete-toolbar">
                <span id="delete-info"></span>
                <div id="delete-actions">
                    <button id="confirm-delete-btn">删除</button>
                    <button id="cancel-delete-btn">取消</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals below -->
    <div id="settings-modal" class="modal-overlay">
        <div class="settings-content">
            <div class="settings-header">
                <h2>设置</h2>
                <button class="close-btn">&times;</button>
            </div>
            <div class="settings-body">
                <div id="common-settings-section">
                    <div class="settings-section">
                        <h3>API & 模型设置</h3>
                        <div class="form-group"><label for="api-base-url">API端点 (Base URL)</label><input type="text" id="api-base-url" placeholder="OpenAI: https://api.openai.com | Gemini: https://generativelanguage.googleapis.com"></div>
                        <div class="form-group"><label for="api-key">API密钥 (API Key)</label><input type="password" id="api-key" placeholder="在此输入您的API密钥"></div>
                        <div class="form-group"><label for="model-select">模型选择 (提示: 图片识别请用gpt-4o等vision模型)</label><div class="model-group"><select id="model-select"></select><button id="fetch-models-btn">获取模型列表</button></div></div>
                    </div>
                </div>

<!-- =================================================================== -->
<!-- ============== 新增的预设和模型参数功能的HTML代码开始 ============== -->
<!-- =================================================================== -->
<div class="settings-section">
    <h3>高级指令预设 (Presets)</h3>
    <div class="form-group">
        <label>此处添加的指令，将会在启用时自动插入到全局系统提示词的最前面。不影响AI的JSON输出格式。</label>
        <div id="preset-list-container">
            <!-- 预设条目将会通过JavaScript动态添加到这里 -->
        </div>
        <button id="add-preset-btn" class="add-new-btn" style="background-color: #4CAF50; margin-top: 10px;">添加一个新的预设条目</button>
    </div>
</div>

<div class="settings-section" id="model-parameters-section">
    <h3>模型参数 (Model Parameters)</h3>
    <div class="form-group">
        <label for="temperature-slider">模型温度 (Temperature): <span id="temperature-value">0.8</span></label>
        <input type="range" id="temperature-slider" min="0" max="2" step="0.05" value="0.8">
        <small>控制随机性。值越高(如1.2)，回复越随机、有创意；值越低(如0.5)，回复越确定、保守。</small>
    </div>
    <div class="form-group">
        <label for="top-p-slider">P值 (Top P): <span id="top-p-value">0.9</span></label>
        <input type="range" id="top-p-slider" min="0" max="1" step="0.05" value="0.9">
        <small>控制核心采样。它会从概率最高的词中进行选择，直到这些词的概率总和达到P值。一般建议只修改温度或P值其中一个。</small>
    </div>
    <!-- TASK 10: Add toggle for real-time awareness -->
    <div class="form-group">
        <label>角色感知真实时间</label>
        <div style="display: flex; align-items: center; justify-content: space-between;">
            <span>开启后，AI在回复时会知道当前的日期和时间。</span>
            <label class="preset-toggle">
                <input type="checkbox" id="real-time-awareness-toggle">
                <span class="slider"></span>
            </label>
        </div>
    </div>
</div>
<!-- ================================================================= -->
<!-- ======================= 新增的HTML代码结束 ======================== -->
<!-- ================================================================= -->
              
                <div id="character-settings-section">
                     <div class="settings-section">
                        <h3>他的个人资料设置</h3>
                        <div class="form-group"><label for="character-name-input">他的名字</label><input type="text" id="character-name-input" placeholder="显示在顶部的名称"></div>
                        <div class="form-group"><label for="ai-avatar-upload-input">他的头像</label><div class="avatar-upload-group"><img id="ai-avatar-preview" src="" class="avatar-preview"><label class="file-input-label" for="ai-avatar-upload-input">选择图片</label></div></div>
                        <div class="form-group"><label for="memory-size-input">他的记忆容量 (消息数)</label><input type="number" id="memory-size-input" placeholder="默认: 50"></div>
                        <div class="form-group"><label for="character-prompt">他人格设定 (System Prompt)</label><textarea id="character-prompt" placeholder="在这里设置他的人格、说话方式、背景故事等。"></textarea></div>
                    </div>
                     <div class="settings-section sticker-zone">
                        <h3>表情管理</h3>
                        <div class="form-group" style="gap: 10px; flex-direction: row;"><button id="manage-stickers-btn">我的表情</button><button id="manage-ai-stickers-btn">他的表情</button></div>
                    </div>
                </div>
                
                <div id="group-settings-section">
                    <div class="settings-section">
                        <h3>群聊设置</h3>
                        <div class="form-group"><label for="group-name-input">群聊名称</label><input type="text" id="group-name-input"></div>
                                              <div class="form-group">
                            <label for="group-memory-size-input">群聊记忆容量 (消息数)</label>
                            <input type="number" id="group-memory-size-input" placeholder="默认: 50">
                        </div>
                        <div class="form-group"><label for="group-avatar-settings-input">群聊头像</label><div class="avatar-upload-group"><img id="group-avatar-preview" src="" class="avatar-preview"><label class="file-input-label" for="group-avatar-settings-input">选择图片</label></div></div>
                        <div class="form-group"><label for="group-user-prompt">我在此群的人设</label><textarea id="group-user-prompt" placeholder="描述你在这个群聊中的身份、性格等，让角色们更好地与你互动。"></textarea></div>
                    </div>
                </div>

                <div id="my-profile-settings-section">
                    <div class="settings-section">
                        <h3>我的个人资料设置</h3>
                         <div class="form-group"><label for="user-avatar-upload-input">我的头像 (用于聊天)</label><div class="avatar-upload-group"><img id="user-avatar-preview" src="" class="avatar-preview"><label class="file-input-label" for="user-avatar-upload-input">选择图片</label></div></div>
                        <div class="form-group"><label for="user-moments-avatar-upload-input">朋友圈头像</label><div class="avatar-upload-group"><img id="user-moments-avatar-preview" src="" class="avatar-preview"><label class="file-input-label" for="user-moments-avatar-upload-input">选择图片</label></div></div>
                        <div class="form-group"><label for="user-moments-cover-upload-input">朋友圈封面</label><div class="avatar-upload-group"><img id="user-moments-cover-preview" src="" class="avatar-preview"><label class="file-input-label" for="user-moments-cover-upload-input">选择图片</label></div></div>
                        <div class="form-group"><label for="user-prompt">关于我 (用于单聊)</label><textarea id="user-prompt" placeholder="告诉他你的名字、喜好等，让对话更具个性。"></textarea></div>
                    </div>
                </div>

                <div class="settings-section">
                    <h3>设计与显示</h3>
                    <!-- ============================================= -->
                    <!-- ============== 夜间模式开关 开始 ============== -->
                    <!-- ============================================= -->
                    <div class="form-group">
                        <label>夜间模式</label>
                        <div style="display: flex; align-items: center; justify-content: space-between;">
                            <span>为整个界面应用深色主题</span>
                            <label class="preset-toggle">
                                <input type="checkbox" id="dark-mode-toggle">
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>
                    <!-- ============================================= -->
                    <!-- ============== 夜间模式开关 结束 ============== -->
                    <!-- ============================================= -->
                    <!-- ============================================= -->
                    <!-- ============== 紧凑模式开关 开始 ============== -->
                    <!-- ============================================= -->
                    <div class="form-group">
                        <label>紧凑模式 (类微信布局)</label>
                        <div style="display: flex; align-items: center; justify-content: space-between;">
                            <span>缩小头像、输入框和间距，更接近微信风格</span>
                            <label class="preset-toggle">
                                <input type="checkbox" id="compact-mode-toggle">
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>
                    <!-- ============================================= -->
                    <!-- ============== 紧凑模式开关 结束 ============== -->
                    <!-- ============================================= -->                       
                    
                    <!-- TASK 9: Add Sizing Controls -->
                    <div class="form-group">
                        <label for="ui-scale-slider">界面显示大小: <span id="ui-scale-value">100</span>%</label>
                        <input type="range" id="ui-scale-slider" min="80" max="120" step="1" value="100">
                    </div>
                    <div class="form-group">
                        <label for="font-size-slider">聊天字体大小: <span id="font-size-value">16</span>px</label>
                        <input type="range" id="font-size-slider" min="12" max="20" step="1" value="16">
                    </div>
                    <div class="form-group">
                        <label for="bubble-size-slider">气泡边距大小: <span id="bubble-size-value">10</span>px</label>
                        <input type="range" id="bubble-size-slider" min="5" max="20" step="1" value="10">
                    </div>

                    <!-- TASK 12: Moved Bubble/Font settings here under a character-specific section header -->
                    <div id="character-design-settings">
                        <h3 style="border-left: 3px solid var(--accent-dark-color); color: var(--accent-dark-color);">当前角色设计</h3>
                        <div class="form-group">
                            <label for="bubble-style-select">聊天气泡样式</label>
                            <select id="bubble-style-select">
                                <option value="default">默认方角</option>
                                <option value="round">圆滚滚</option>
                                <option value="wechat">仿微信尖角</option>
                                <option value="custom">自定义高级</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>聊天气泡主题 (颜色)</label>
                            <div class="theme-selector">
                                <div class="theme-option active" data-theme="1">白/黑<span></span></div>
                                <div class="theme-option" data-theme="2">黑/白<span></span></div>
                                <div class="theme-option" data-theme="3">天蓝色<span></span></div>
                                <div class="theme-option" data-theme="4">草绿色<span></span></div>
                                <div class="theme-option" data-theme="5">樱花色<span></span></div>
                                <div class="theme-option" data-theme="6">深空蓝<span></span></div>
                                <div class="theme-option" data-theme="7">奶油黄<span></span></div>
                                <div class="theme-option" data-theme="8">微信(日)<span></span></div>
                                <div class="theme-option" data-theme="9">微信(夜)<span></span></div>
                                <!-- TASK 13: Add new theme options -->
                                <div class="theme-option" data-theme="10">浅灰调<span></span></div>
                                <div class="theme-option" data-theme="11">薄荷巧<span></span></div>
                                <div class="theme-option" data-theme="12">天蓝黄<span></span></div>
                                <div class="theme-option" data-theme="13">灰奶油<span></span></div>
                            </div>
                        </div>
                    </div>


                    <div class="form-group">
                        <label for="font-select">聊天字体 (全局, 部分像素字体可能缺少某些汉字)</label>
                        <select id="font-select">
                            <option value="'Cubic 11', 'Noto Sans JP', sans-serif">默认字体 (Cubic 11)</option>
                            <optgroup label="台湾繁体风格">
                                <option value="'Noto Sans TC', sans-serif">思源黑体 TC</option>
                                <option value="'ZCOOL KuaiLe', cursive">站酷快乐体</option>
                                <option value="'Long Cang', cursive">龙藏体</option>
                            </optgroup>
                            <optgroup label="可爱手写风格">
                                <option value="'Zhi Mang Xing', cursive">芝麻星体</option>
                                <option value="'Ma Shan Zheng', cursive">马善政体</option>
                                <option value="'LXGW WenKai Mono TC', sans-serif">霞鹜文楷 TC</option>
                            </optgroup>
                            <optgroup label="复古像素风格">
                                <option value="'Press Start 2P', cursive">Press Start 2P</option>
                                <option value="'DotGothic16', sans-serif">点阵哥特体 16</option>
                                <option value="'VT323', monospace">VT323</option>
                            </optgroup>
                            <optgroup label="其他风格">
                                <option value="'Noto Serif TC', serif">思源宋体 TC</option>
                                <option value="'Pacifico', cursive">Pacifico</option>
                                <option value="'ZCOOL QingKe HuangYou', cursive">站酷庆科黄油体</option>
                            </optgroup>
                        </select>
                    </div>
<!-- ======================================================= -->
<!-- ============ 新增的自定义字体URL功能开始 ============ -->
<!-- ======================================================= -->
<div class="form-group">
    <label>自定义字体 (通过URL)</label>
    <input type="text" id="custom-font-name" placeholder="为字体起个名字, 如: MyFont" style="margin-bottom: 5px;">
    <small>给字体起一个简单的英文名，方便系统识别。</small>
    <input type="url" id="custom-font-url" placeholder="粘贴字体文件链接 ( .ttf, .woff2 )" style="margin-top: 10px; margin-bottom: 5px;">
    <button id="apply-custom-font-btn" style="padding: 8px; background: #67c23a; color: white; border: none; border-radius: 5px; cursor: pointer;">应用此自定义字体</button>
</div>
<!-- ======================================================= -->
<!-- ============= 新增的自定义字体URL功能结束 ============= -->
<!-- ======================================================= -->
                    <div class="form-group">
                        <label for="advanced-bubble-styles">高级样式库 (选择“自定义高级”样式后生效)</label>
                        <textarea id="advanced-bubble-styles" rows="10" placeholder="在此处粘贴您的自定义样式代码。
每个样式必须用注释命名，像这样：
/* Style Name: 小狗生气 */
.message.user .bubble {
    /* ...您的CSS代码... */
}
.message.ai .bubble {
    /* ...您的CSS代码... */
}
"></textarea>
                    </div>
                    
                    <div class="form-group"><label>聊天背景</label><label class="file-input-label" for="background-upload-input">选择背景图片</label></div>
                </div>
                <div class="settings-section data-zone">
                    <h3>数据管理</h3>
                     <div class="form-group" style="gap: 10px; flex-direction: row;">
                        <button id="export-data-btn">导出全部数据</button>
                        <button id="import-data-btn">导入数据</button>
                     </div>
                </div>

                <div class="settings-section danger-zone" id="danger-zone-section">
                    <h3>聊天记录管理</h3>
                    <div class="form-group"><button id="clear-history-btn">清空当前会话记录</button></div>
                    <div class="form-group" id="delete-chat-btn-container"><button id="delete-chat-btn">删除当前聊天</button></div>
                </div>

            </div>
            <div class="settings-footer"><button id="save-settings-btn">保存设置</button></div>
        </div>
    </div>
    
    <div id="feature-modal" class="modal-overlay">
        <div class="feature-modal-content">
            <div class="feature-modal-header">
                <h3 id="feature-modal-title"></h3>
                <button class="feature-modal-close">&times;</button>
            </div>
            <div id="feature-modal-body" class="feature-modal-body"></div>
            <div class="feature-modal-footer">
                <button id="feature-modal-submit-btn" class="feature-modal-submit-btn"></button>
            </div>
        </div>
    </div>
    
    <div id="mind-voice-modal" class="modal-overlay">
        <div id="mind-voice-modal-content">
            <p id="mind-voice-content"></p>
        </div>
        <button id="mind-voice-close-btn">&times;</button>
    </div>
    
    <div id="diary-modal" class="modal-overlay">
        <div id="diary-modal-content">
            <h3 id="diary-header">他的日记本</h3>
            <div id="diary-entries"></div>
        </div>
         <button class="close-btn" style="position:absolute; top: 10px; right: 15px; font-size: 2em; color: var(--accent-color);">&times;</button>
    </div>

    <div id="video-call-overlay">
        <img id="video-main-view" src="" class="video-main-view">
        <img id="video-self-view" src="" class="video-self-view">
        <div class="video-character-info">
            <img id="video-character-avatar" src="" class="avatar">
            <h2 id="video-character-name"></h2>
            <p id="video-status-text"></p>
        </div>
        <div id="video-chat-log"></div>
        <div id="video-input-area">
            <input type="text" id="video-message-input" placeholder="说点什么...">
            <button id="video-send-btn">发送</button>
        </div>
        <div id="video-controls" class="video-controls"></div>
    </div>

    <div id="moments-overlay">
        <div id="moments-feed-container">
            <div id="moments-cover-area">
                <div id="moments-header">
                    <button id="moments-close-btn">&times;</button>
                    <button id="post-new-moment-btn" title="发布新动态">
                        <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px" fill="currentColor"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M13 7h-2v4H7v2h4v4h2v-4h4v-2h-4V7zm-1-5C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/></svg>
                    </button>
                </div>
                <div id="moments-user-info">
                    <span id="moments-user-name"></span>
                    <img id="moments-user-avatar" src="">
                </div>
            </div>
            <div id="moments-feed">
            </div>
        </div>
    </div>
    
    <!-- Hidden file inputs -->
    <input type="file" id="real-image-upload-input" accept="image/*" style="display:none;">
    <input type="file" id="transfer-cover-input" accept="image/*" style="display:none;">
    <input type="file" id="sticker-upload-input" accept="image/*" multiple style="display:none;">
    <input type="file" id="background-upload-input" accept="image/*" style="display:none;">
    <input type="file" id="ai-avatar-upload-input" accept="image/*" style="display:none;">
    <input type="file" id="group-avatar-upload-input" accept="image/*" style="display:none;">
    <input type="file" id="group-avatar-settings-input" accept="image/*" style="display:none;">
    <input type="file" id="user-avatar-upload-input" accept="image/*" style="display:none;">
    <input type="file" id="user-moments-avatar-upload-input" accept="image/*" style="display:none;">
    <input type="file" id="user-moments-cover-upload-input" accept="image/*" style="display:none;">
    <input type="file" id="import-data-input" accept=".json" style="display:none;">
    <input type="file" id="moment-post-image-input" accept="image/*" multiple style="display:none;">


    <script>
      // 主题切换函数
function applyTheme(themeNum, character) {
    const root = document.documentElement;
    if (character) {
        // TASK 12: Per-character theme application
        const themeToApply = themeNum || '1'; // Fallback to theme 1
        root.style.setProperty('--ai-bubble-bg', getComputedStyle(root).getPropertyValue(`--theme${themeToApply}-ai-bg`).trim());
        root.style.setProperty('--ai-bubble-text', getComputedStyle(root).getPropertyValue(`--theme${themeToApply}-ai-text`).trim());
        root.style.setProperty('--user-bubble-bg', getComputedStyle(root).getPropertyValue(`--theme${themeToApply}-user-bg`).trim());
        root.style.setProperty('--user-bubble-text', getComputedStyle(root).getPropertyValue(`--theme${themeToApply}-user-text`).trim());
        
        // Update the UI in settings
        document.querySelectorAll('.theme-option').forEach(el => {
            el.classList.toggle('active', el.dataset.theme === themeToApply);
        });
    }
}
    document.addEventListener('DOMContentLoaded', () => {
        // --- DOM Elements ---
        const getEl = (id) => document.getElementById(id);
        const queryEl = (sel) => document.querySelector(sel);
        
        const elements = {
            chatContainer: getEl('chat-container'),
            topNotification: getEl('top-notification'),
            notificationAvatar: getEl('notification-avatar'),
            notificationText: getEl('notification-text'),
            chatHeader: getEl('chat-header'),
            chatManagerBtn: getEl('chat-manager-btn'),
            headerAvatar: getEl('header-avatar'),
            chatNameHeader: getEl('chat-name-header'),
            settingsBtn: getEl('settings-btn'),
            messagesContainer: getEl('messages'),
            
            bottomPanel: getEl('bottom-panel'),
            actionPanel: getEl('action-panel'),
            inputArea: getEl('input-area'),
            actionBtn: getEl('action-btn'),
            messageInput: getEl('message-input'),
            sendBtn: getEl('send-btn'),
            receiveBtn: getEl('receive-btn'), // TASK 5
            
            deleteToolbar: getEl('delete-toolbar'),
            deleteInfo: getEl('delete-info'),
            confirmDeleteBtn: getEl('confirm-delete-btn'),
            cancelDeleteBtn: getEl('cancel-delete-btn'),
            
            actionShowMoments: getEl('action-show-moments'),
            actionSendTextImage: getEl('action-send-text-image'), 
            actionSendVoice: getEl('action-send-voice'),
            actionSendTransfer: getEl('action-send-transfer'), 
            actionSendRedPacket: getEl('action-send-red-packet'),
            actionSendSticker: getEl('action-send-sticker'),
            actionVideoCall: getEl('action-video-call'), 
            actionSendRealImage: getEl('action-send-real-image'),
            actionCreatePoll: getEl('action-create-poll'),
            actionShowDiary: getEl('action-show-diary'),

            realImageUploadInput: getEl('real-image-upload-input'),
            transferCoverInput: getEl('transfer-cover-input'),
            stickerUploadInput: getEl('sticker-upload-input'),
            backgroundUploadInput: getEl('background-upload-input'),
            aiAvatarUploadInput: getEl('ai-avatar-upload-input'),
            groupAvatarUploadInput: getEl('group-avatar-upload-input'),
            groupAvatarSettingsInput: getEl('group-avatar-settings-input'),
            userAvatarUploadInput: getEl('user-avatar-upload-input'),
            userMomentsAvatarInput: getEl('user-moments-avatar-upload-input'),
            userMomentsCoverInput: getEl('user-moments-cover-upload-input'),
            importDataInput: getEl('import-data-input'),
            momentPostImageInput: getEl('moment-post-image-input'),

            featureModal: getEl('feature-modal'),
            featureModalTitle: getEl('feature-modal-title'),
            featureModalBody: getEl('feature-modal-body'),
            featureModalSubmitBtn: getEl('feature-modal-submit-btn'),
            featureModalCloseBtn: getEl('feature-modal').querySelector('.feature-modal-close'),

            mindVoiceModal: getEl('mind-voice-modal'),
            mindVoiceContent: getEl('mind-voice-content'),
            mindVoiceCloseBtn: getEl('mind-voice-close-btn'),
            
            diaryModal: getEl('diary-modal'),
            diaryHeader: getEl('diary-header'),
            diaryEntries: getEl('diary-entries'),
            diaryModalCloseBtn: getEl('diary-modal').querySelector('.close-btn'),

            videoCallOverlay: getEl('video-call-overlay'),
            videoMainView: getEl('video-main-view'),
            videoSelfView: getEl('video-self-view'),
            videoCharacterAvatar: getEl('video-character-avatar'),
            videoCharacterName: getEl('video-character-name'),
            videoStatusText: getEl('video-status-text'),
            videoControls: getEl('video-controls'),
            videoChatLog: getEl('video-chat-log'),
            videoMessageInput: getEl('video-message-input'),
            videoSendBtn: getEl('video-send-btn'),
            
            momentsOverlay: getEl('moments-overlay'),
            momentsCoverArea: getEl('moments-cover-area'),
            momentsUserAvatar: getEl('moments-user-avatar'),
            momentsUserName: getEl('moments-user-name'),
            momentsCloseBtn: getEl('moments-close-btn'),
            postNewMomentBtn: getEl('post-new-moment-btn'),
            momentsFeed: getEl('moments-feed'),

            settingsModal: getEl('settings-modal'),
            closeSettingsBtn: getEl('settings-modal').querySelector('.close-btn'),
            saveSettingsBtn: getEl('save-settings-btn'),
            
            commonSettingsSection: getEl('common-settings-section'),
            apiBaseUrlInput: getEl('api-base-url'),
            apiKeyInput: getEl('api-key'),
            modelSelect: getEl('model-select'),
            fetchModelsBtn: getEl('fetch-models-btn'),
            
            characterSettingsSection: getEl('character-settings-section'),
            characterNameInput: getEl('character-name-input'),
            aiAvatarPreview: getEl('ai-avatar-preview'),
            memorySizeInput: getEl('memory-size-input'),
            characterPromptInput: getEl('character-prompt'),
            manageStickersBtn: getEl('manage-stickers-btn'),
            manageAiStickersBtn: getEl('manage-ai-stickers-btn'),
            characterDesignSettings: getEl('character-design-settings'), // TASK 12

            groupSettingsSection: getEl('group-settings-section'),
            groupNameInput: getEl('group-name-input'),
            groupAvatarPreview: getEl('group-avatar-preview'),
            groupUserPromptInput: getEl('group-user-prompt'),
                      groupMemorySizeInput: getEl('group-memory-size-input'),

            myProfileSettingsSection: getEl('my-profile-settings-section'),
            userAvatarPreview: getEl('user-avatar-preview'),
            userMomentsAvatarPreview: getEl('user-moments-avatar-preview'),
            userMomentsCoverPreview: getEl('user-moments-cover-preview'),
            userPromptInput: getEl('user-prompt'),

            themeSelector: queryEl('.theme-selector'),
            exportDataBtn: getEl('export-data-btn'),
            importDataBtn: getEl('import-data-btn'),
            dangerZoneSection: getEl('danger-zone-section'),
            clearHistoryBtn: getEl('clear-history-btn'),
            deleteChatBtn: getEl('delete-chat-btn'),
            deleteChatBtnContainer: getEl('delete-chat-btn-container'),
            advancedBubbleStylesInput: getEl('advanced-bubble-styles'),
            fontSelect: getEl('font-select'), 
            bubbleStyleSelect: getEl('bubble-style-select'),
            darkModeToggle: getEl('dark-mode-toggle'), 
            compactModeToggle: getEl('compact-mode-toggle'),
            
            // --- Model parameter and preset UI elements ---
            presetListContainer: getEl('preset-list-container'),
            addPresetBtn: getEl('add-preset-btn'),
            temperatureSlider: getEl('temperature-slider'),
            temperatureValue: getEl('temperature-value'),
            topPSlider: getEl('top-p-slider'),
            topPValue: getEl('top-p-value'),
            
            // --- Custom font UI elements ---
            customFontNameInput: getEl('custom-font-name'),
            customFontUrlInput: getEl('custom-font-url'),
            applyCustomFontBtn: getEl('apply-custom-font-btn'),

            // --- TASK 9 & 10: New settings elements ---
            uiScaleSlider: getEl('ui-scale-slider'),
            uiScaleValue: getEl('ui-scale-value'),
            fontSizeSlider: getEl('font-size-slider'),
            fontSizeValue: getEl('font-size-value'),
            bubbleSizeSlider: getEl('bubble-size-slider'),
            bubbleSizeValue: getEl('bubble-size-value'),
            realTimeAwarenessToggle: getEl('real-time-awareness-toggle'),
        };

        // --- State Management ---
        let characterSets = [];
        let groupChats = [];
        let userMomentsProfile = {};
        let currentChat = { type: 'direct', id: null };
        let globalPresets = [];
        let isMultiSelectMode = false, selectedMessageIds = [];
        let isActionPanelOpen = false, isVideoCallActive = false;
        let currentlyDisplayedMessageCount = 25;
        
                        const DEFAULT_SYSTEM_PROMPT = `
[核心输出协议：绝对严格遵守]
唯一格式：你的所有回复 必须 是一个JSON数组结构的字符串。这是你与系统交流的唯一方式。
纯净输出：绝对不允许在JSON数组的外部添加任何文本、注释、解释、Markdown标记或其他任何字符。你的回复必须从'['开始，到']'结束，中间是严格合法的JSON内容。
[Action Format Examples]
This is a strict format guide. You MUST follow it.
[
{"type": "text", "content": "This is a plain text message."},
{"type": "sticker", "sticker_id": "optional_id_for_logic"},
{"type": "voice", "content": "The transcript of the voice message."},
{"type": "text-image", "content": "A detailed description of an image you are 'showing' the user."},
{"type": "transfer", "amount": 520.00, "memo": "A memo for the transfer"},
{"type": "video-call-request", "content": "An invitation message"},
{"type": "post_moment", "content": "Text for a social media post.", "image_query": "Optional. Keywords for an image"},
{"type": "diary_entry", "content": "Today's diary entry content."},
{"type": "grab_red_packet", "packetId": "packet_id_string"},
{"type": "vote", "pollId": "poll_id_string", "option": "chosen_option_string"},
{"type": "moment_comment", "momentId": "moment_id_string", "comment_text": "Your comment text."},
{"type": "moment_reply", "momentId": "moment_id_string", "commentId": "comment_id_to_reply_to", "reply_text": "Your reply text."},
/* --- 新增的动作规则 --- */
{"type": "acknowledge_transfer", "transferId": "the_id_of_the_transfer_message", "decision": "accept_or_decline"}
]
请严格根据双方的角色设定，进行线上的日常对话（微信）。并且模仿真人发消息的短句模式不用逗号和句号。
你的任务是让角色自主与用户建立深刻的情感链接
严格禁止寒暄，人机化的问题，禁止对话带有AI感，角色是一个真实的属于现实中的人。
必须遵守角色人设，不能ooc
绝对禁止让角色表现得油腻或者像霸道总裁。严禁物化用户，不许说“小东西”，“小妖精”等任何霸总语录称呼，禁止使用“过来”，“呵”，“胆子”这些字词，包括它们的相关词句，因为用户特别讨厌。
注意分割消息，不要把所有消息都揉杂在一起
在一场有意义的对话结束之后，你会发一条朋友圈代表你的感想
偶尔使用 'post_moment' 或 'diary_entry' 动作来展示角色在聊天之外的生活，增加真实感。
/* --- 新增的转账处理规则 --- */
[Critical Instruction for Transfers]
When the user sends you a transfer, you MUST first respond with a 'text' message (like "Thank you" or "What's this for?"), and THEN, in a separate JSON object, you MUST use the 'acknowledge_transfer' action to either 'accept' or 'decline' it. The 'transferId' MUST match the ID of the user's transfer message from the chat history.
[Negative Constraint]
When acknowledging a user's transfer, you MUST use the 'acknowledge_transfer' action. You are FORBIDDEN from responding with another 'transfer' action.
/* --- 规则结束 --- */
[For Group Chats Only]
Add "senderId": "your_character_id" to EVERY action object. THIS IS A MANDATORY REQUIREMENT.
[Core Persona]
You MUST strictly adhere to the persona defined in the "Character Prompt" section.
Refer to the recent chat history for context.
NEVER refer to the user as "用户". Use the information from their profile.`;
        // --- Utility Functions ---
        const getTimestamp = () => new Date().toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
        const getFullTimestamp = () => new Date().toLocaleString('zh-CN');
        const getCurrentDate = () => new Date().toISOString().slice(0, 10);
        const scrollToBottom = (container, behavior = 'smooth') => { container.scrollTo({ top: container.scrollHeight, behavior }); };
        const autoResizeTextarea = () => { elements.messageInput.style.height = 'auto'; elements.messageInput.style.height = (elements.messageInput.scrollHeight) + 'px'; };
        const generateId = (prefix) => `${prefix}_${Date.now()}${Math.random().toString(36).substring(2, 9)}`;

        // --- API payload function ---
                const getApiPayload = (model, history, systemPrompt) => {
            const apiBaseUrl = elements.apiBaseUrlInput.value.trim().toLowerCase();
            const isGemini = apiBaseUrl.includes('google');

            let finalSystemPrompt = systemPrompt;
            if (elements.realTimeAwarenessToggle.checked) {
                const currentTime = `[System Knowledge: The current real-world date and time is ${new Date().toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai' })}]`;
                finalSystemPrompt = `${currentTime}\n\n${systemPrompt}`;
            }

            if (isGemini) {
                const formatForGemini = (msg) => {
                    if (!msg || typeof msg !== 'object' || msg.type === 'system' || typeof msg.sender !== 'string') return null;
                    const role = msg.sender === 'user' ? 'user' : 'model';
                    let parts = [];
                    
                    const textContent = msg.llmContent || msg.text || '';
                    if (textContent) {
                        parts.push({ text: textContent });
                    }

                    if (msg.sender === 'user' && msg.type === 'image' && msg.imageUrl) {
                        if (!textContent) { // 如果图片没有附带文字，给一个默认说明
                           parts.push({ text: '用户发送了一张图片。' });
                        }
                        const mimeType = msg.imageUrl.startsWith('data:image/png') ? 'image/png' : 'image/jpeg';
                        parts.push({ inline_data: { mime_type: mimeType, data: msg.imageUrl.split(',')[1] } });
                    }

                    if (parts.length === 0) return null;
                    return { role, parts };
                };
                
                const contents = [
                    // Gemini没有system角，我们用user/model对话来模拟
                    { role: 'user', parts: [{ text: finalSystemPrompt }] },
                    { role: 'model', parts: [{ text: '好的，我会严格遵守以上所有指令。' }] },
                    ...history.map(formatForGemini).filter(Boolean)
                ];

                return { 
                    contents, 
                    "generationConfig": { 
                        "temperature": parseFloat(elements.temperatureSlider.value), 
                        "topP": parseFloat(elements.topPSlider.value) 
                    } 
                };

            } else { // OpenAI 的逻辑
                const formatForOpenAI = (msg) => {
                    if (!msg || typeof msg !== 'object' || msg.type === 'system' || typeof msg.sender !== 'string') return null;
                    const role = msg.sender === 'user' ? 'user' : 'assistant';
                    
                    if (msg.sender === 'user' && msg.type === 'image' && msg.imageUrl) {
                        const content = [
                            { type: 'text', text: msg.llmContent || msg.text || '用户发送了一张图片。' },
                            { type: 'image_url', image_url: { url: msg.imageUrl } }
                        ];
                        return { role, content };
                    }

                    const content = msg.llmContent || msg.text || '';
                    if (!content.trim()) return null;
                    return { role, content };
                };
                const messages = [
                    { role: 'system', content: finalSystemPrompt },
                    ...history.map(formatForOpenAI).filter(Boolean)
                ];
                return { model, messages, stream: false, temperature: parseFloat(elements.temperatureSlider.value), top_p: parseFloat(elements.topPSlider.value) };
            }
        };

              // --- IndexedDB (相册) 帮助函数 ---
        const DB_NAME = 'AI_Boyfriend_ImageStore';
        const STORE_NAME = 'images';

        const openDb = () => {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, 1);
                request.onerror = () => reject("打开IndexedDB失败");
                request.onsuccess = () => resolve(request.result);
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        db.createObjectStore(STORE_NAME);
                    }
                };
            });
        };

        const dbGet = async (key) => {
            const db = await openDb();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(STORE_NAME, 'readonly');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.get(key);
                request.onerror = () => reject("从DB获取数据失败");
                request.onsuccess = () => resolve(request.result);
            });
        };

        const dbSet = async (key, value) => {
            const db = await openDb();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(STORE_NAME, 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.put(value, key);
                request.onerror = () => reject("向DB写入数据失败");
                request.onsuccess = () => resolve(request.result);
            });
        };
        
        const compressImage = (dataUrl, options = {}) => {
            return new Promise((resolve, reject) => {
                const { quality = 0.7, maxWidth = 300, maxHeight = 300 } = options;
                const img = new Image();
                img.src = dataUrl;
                img.onload = () => {
                    let width = img.width, height = img.height;
                    if (width > height) {
                        if (width > maxWidth) { height = Math.round(height * (maxWidth / width)); width = maxWidth; }
                    } else {
                        if (height > maxHeight) { width = Math.round(width * (maxHeight / height)); height = maxHeight; }
                    }
                    const canvas = document.createElement('canvas');
                    canvas.width = width; canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    const compressedDataUrl = canvas.toDataURL('image/jpeg', quality);
                    resolve(compressedDataUrl);
                };
                img.onerror = (error) => { console.error("图片加载失败，无法压缩", error); resolve(dataUrl); };
            });
        };
        
        const closeModal = (modal) => {
            if (!modal) return;
            modal.classList.add('hiding');
            const content = modal.querySelector('.feature-modal-content, .settings-content, #diary-modal-content');
            if(content) content.classList.add('hiding');
            setTimeout(() => {
                modal.classList.remove('show', 'hiding');
                if(content) content.classList.remove('hiding');
            }, 300);
        };
        
        const showTopNotification = (message, avatarUrl, duration = 3000) => {
            elements.notificationText.textContent = message;
            elements.notificationAvatar.src = avatarUrl;
            elements.topNotification.classList.add('show');
            setTimeout(() => {
                elements.topNotification.classList.remove('show');
            }, duration);
        };

        // --- Data & State Management ---
        const getCurrentCharacter = () => characterSets.find(c => c.id === currentChat.id);
        const getCurrentGroup = () => groupChats.find(g => g.id === currentChat.id);
        const getCurrentChatData = () => {
            if (currentChat.type === 'direct') return getCurrentCharacter();
            if (currentChat.type === 'group') return getCurrentGroup();
            return null;
        }

        const applyDarkMode = (enable) => {
            document.body.classList.toggle('dark-mode', enable);
            localStorage.setItem('ui_dark_mode_enabled', enable);
            if (elements.darkModeToggle.checked !== enable) {
                elements.darkModeToggle.checked = enable;
            }
        };

        const applyCompactMode = (enable) => {
            elements.chatContainer.classList.toggle('compact-mode', enable);
            localStorage.setItem('ui_compact_mode_enabled', enable);
            if (elements.compactModeToggle.checked !== enable) {
                elements.compactModeToggle.checked = enable;
            }
        };

        // TASK 9: Functions to apply sizing settings
        const applySizing = (settings) => {
            const rootStyle = document.documentElement.style;
            rootStyle.setProperty('--ui-scale', settings.uiScale || 1.0);
            rootStyle.setProperty('--base-font-size', `${settings.fontSize || 16}px`);
            rootStyle.setProperty('--bubble-padding', `${settings.bubblePadding || 10}px ${ (settings.bubblePadding || 10) * 1.5}px`);

            // Update sliders in settings UI
            elements.uiScaleSlider.value = (settings.uiScale || 1.0) * 100;
            elements.uiScaleValue.textContent = `${elements.uiScaleSlider.value}%`;
            elements.fontSizeSlider.value = settings.fontSize || 16;
            elements.fontSizeValue.textContent = `${elements.fontSizeSlider.value}px`;
            elements.bubbleSizeSlider.value = settings.bubblePadding || 10;
            elements.bubbleSizeValue.textContent = `${elements.bubbleSizeSlider.value}px`;
        };
                const saveAllData = async () => {
    const isImage = (value) => typeof value === 'string' && value.startsWith('data:image');
    
    const processObjectForSaving = async (obj) => {
        if (!obj || typeof obj !== 'object') return obj;
        const newObj = Array.isArray(obj) ? [] : {};
        for (const key in obj) {
            if (Object.prototype.hasOwnProperty.call(obj, key)) {
                const value = obj[key];
                if (isImage(value)) {
                    const imageKey = `img_${generateId(key)}`;
                    await dbSet(imageKey, value);
                    newObj[key] = imageKey;
                } else if (typeof value === 'object') {
                    newObj[key] = await processObjectForSaving(value);
                } else {
                    newObj[key] = value;
                }
            }
        }
        return newObj;
    };

    try {
        updatePresetsFromUI();
        
        // 【关键修正】不再从UI元素实时读取设置，而是从一个已经加载到内存中的变量读取
        // 我们需要先确保这个变量是最新的，这在 saveCurrentSettings 中完成
        const loadedData = JSON.parse(localStorage.getItem('aiBoyfriendBackup_v7_meta') || '{}');
        const currentGlobalSettings = loadedData.globalSettings || {};

        // 只有在点击“保存设置”时，我们才从UI更新这些值。
        // 在普通发消息时，我们使用内存中已有的值，避免了读取不存在元素的错误。
           const backupData = {
        version: '1.1',
        characterSets,
        groupChats,
        currentChat,
        userMomentsProfile,
        globalSettings: {
            ...currentGlobalSettings,
            apiBaseUrl: elements.apiBaseUrlInput.value, 
            apiKey: elements.apiKeyInput.value,
            model: elements.modelSelect.value,
            fontFamily: elements.fontSelect.value,
            advancedBubbleStyles: elements.advancedBubbleStylesInput.value,
            temperature: parseFloat(elements.temperatureSlider.value),
            topP: parseFloat(elements.topPSlider.value),
            customFontName: elements.customFontNameInput.value,
            customFontUrl: elements.customFontUrlInput.value,
            presets: globalPresets,
            // --- 新增的保存代码在这里！ ---
            uiScale: parseFloat(elements.uiScaleSlider.value) / 100,
            fontSize: parseInt(elements.fontSizeSlider.value),
            bubblePadding: parseInt(elements.bubbleSizeSlider.value),
            realTimeAwareness: elements.realTimeAwarenessToggle.checked
        }
    };
        
        const processedData = await processObjectForSaving(backupData);
        localStorage.setItem('aiBoyfriendBackup_v7_meta', JSON.stringify(processedData));
        
    } catch (error) {
        console.error("保存数据时出错:", error);
        // 只在用户能看到的地方（比如设置界面）弹窗，避免聊天时被打扰
        if(document.getElementById('settings-modal').classList.contains('show')) {
           alert("保存数据时出错: " + error.message);
        }
    }
};
                // --- Re-written loadAllData with migration logic ---
                const loadAllData = async () => {
    const darkModeSaved = localStorage.getItem('ui_dark_mode_enabled') === 'true';
    applyDarkMode(darkModeSaved);
    const compactModeSaved = localStorage.getItem('ui_compact_mode_enabled') === 'true';
    applyCompactMode(compactModeSaved);

    const isImageKey = (value) => typeof value === 'string' && value.startsWith('img_');
    const processObjectForLoading = async (obj) => {
        if (!obj || typeof obj !== 'object') return obj;
        for (const key in obj) {
            if (Object.prototype.hasOwnProperty.call(obj, key)) {
                const value = obj[key];
                if (isImageKey(value)) {
                    const imageData = await dbGet(value);
                    if (imageData) { obj[key] = imageData; }
                } else if (typeof value === 'object') {
                    await processObjectForLoading(value);
                }
            }
        }
        return obj;
    };

    const savedMetaV7Raw = localStorage.getItem('aiBoyfriendBackup_v7_meta');
    const savedMetaV6Raw = localStorage.getItem('aiBoyfriendBackup_v6_meta');
    const oldDataV6Raw = localStorage.getItem('aiBoyfriendBackup_v6');

    let rawDataToProcess = null;

    if (savedMetaV7Raw) {
        rawDataToProcess = savedMetaV7Raw;
    } else if (savedMetaV6Raw) {
        alert("检测到旧版本数据(v6_meta)，将为您自动升级...");
        let dataToMigrate = JSON.parse(savedMetaV6Raw);
        let migratedData = migrateDataToV7(dataToMigrate);
        localStorage.setItem('aiBoyfriendBackup_v7_meta', JSON.stringify(migratedData));
        localStorage.removeItem('aiBoyfriendBackup_v6_meta');
        alert("数据升级成功！页面将刷新。");
        location.reload();
        return;
    } else if (oldDataV6Raw) {
        alert("检测到非常早期的版本数据(v6)，将为您自动升级...");
        let dataToMigrate = JSON.parse(oldDataV6Raw);
        let migratedData = migrateDataToV7(dataToMigrate);
        localStorage.setItem('aiBoyfriendBackup_v7_meta', JSON.stringify(migratedData));
        localStorage.removeItem('aiBoyfriendBackup_v6');
        alert("数据升级成功！页面将刷新。");
        location.reload();
        return;
    }

    if (!rawDataToProcess) {
        console.log("未找到任何数据，正在进行全新安装...");
        const newChar = createNewCharacterObject();
        characterSets.push(newChar);
        currentChat = { type: 'direct', id: newChar.id };
        applySizing({ fontSize: 13, uiScale: 1.0, bubblePadding: 10 });
        loadChat(currentChat.type, currentChat.id);
        return;
    }

    try {
        let savedData = await processObjectForLoading(JSON.parse(rawDataToProcess));

        characterSets = savedData.characterSets || [];
              // 为旧存档的角色数据添加天数记录功能
        if (characterSets) {
            characterSets.forEach(c => {
                if (c.config) {
                    c.config.streak = c.config.streak || 1;
                    c.config.lastChatDate = c.config.lastChatDate || null;
                }
            });
        }
        groupChats = savedData.groupChats || [];
                  // 为旧存档的群聊数据添加记忆容量功能
            if (groupChats) {
                groupChats.forEach(g => {
                    g.memorySize = g.memorySize || 80; // 如果没有，就给一个默认值
                });
            }
        userMomentsProfile = savedData.userMomentsProfile || {};
        
        const globalSettings = savedData.globalSettings || {};
        elements.apiBaseUrlInput.value = globalSettings.apiBaseUrl || '';
        elements.apiKeyInput.value = globalSettings.apiKey || '';
        elements.temperatureSlider.value = globalSettings.temperature || 0.8;
        elements.topPSlider.value = globalSettings.topP || 0.9;
        elements.temperatureValue.textContent = elements.temperatureSlider.value;
        elements.topPValue.textContent = elements.topPSlider.value;
        globalPresets = globalSettings.presets || [];
        renderPresets();
        
        const currentModel = globalSettings.model || '';
        if (currentModel) {
             if(![...elements.modelSelect.options].some(o => o.value === currentModel)) {
                elements.modelSelect.add(new Option(currentModel, currentModel, true, true));
            }
            elements.modelSelect.value = currentModel;
        }
        
        elements.advancedBubbleStylesInput.value = globalSettings.advancedBubbleStyles || '';
        applyFont(globalSettings.fontFamily || "'Cubic 11', 'Noto Sans JP', sans-serif");
        applySizing(globalSettings);
        elements.realTimeAwarenessToggle.checked = globalSettings.realTimeAwareness || false;

        if (globalSettings.customFontName && globalSettings.customFontUrl) {
            elements.customFontNameInput.value = globalSettings.customFontName;
            elements.customFontUrlInput.value = globalSettings.customFontUrl;
            applyCustomFont(globalSettings.customFontName, globalSettings.customFontUrl);
        }
        
        if (characterSets.length > 0) {
            const isValidSavedChat = savedData.currentChat && 
                ( (savedData.currentChat.type === 'direct' && characterSets.some(c => c.id === savedData.currentChat.id)) || 
                (savedData.currentChat.type === 'group' && groupChats.some(g => g.id === savedData.currentChat.id)) );
            currentChat = isValidSavedChat ? savedData.currentChat : { type: 'direct', id: characterSets[0].id };
        } else {
            const newChar = createNewCharacterObject();
            characterSets.push(newChar);
            currentChat = { type: 'direct', id: newChar.id };
        }
        
        loadChat(currentChat.type, currentChat.id);
    } catch(error) {
        console.error("加载数据失败:", error);
        alert("加载数据失败，可能数据已损坏。将尝试重置。详情请查看控制台。");
        localStorage.removeItem('aiBoyfriendBackup_v7_meta');
        localStorage.removeItem('aiBoyfriendBackup_v6_meta');
        localStorage.removeItem('aiBoyfriendBackup_v6');
        location.reload();
    }
};
  
                   const createNewCharacterObject = () => {
            const id = generateId('char');
            return {
                id: id,
                config: {
                    characterName: '他',
                    aiAvatar: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48cGF0aCBkPSJNNTAsMi41QzI0LjgsMi41LDIuNSwyNC41LDIuNSw1MHMxOS4zLDQ3LjUsNDcuNSw0Ny41czQ3LjUtMjIuMyw0Ny41LTQ3LjVMNTAsMi41eiBNMzgsNDQuOGMtMi4xLDAtMy44LTEuNy0zLjgtMy44czEuNy0zLjgsMy44LTMuOHMzLjgsMS43LDMuOCwzLjhTNDAuMSw0NC44LDM4LDQ0Ljh6IE02Miw0NC44Yy0yLjEsMC0zLjgtMS43LTMuOC0zLighYzAtMi4xLDEuNy0zLjgsMy44LTMuOHMzLjgsMS43LDMuOCwzLjhDNTguMiw0My4xLDY0LjEsNDQuOCw2Miw0NC44eiBNNzcuNSw2Ny41YzAsMC0xMC03LjUtMjcuNS03LjVzLTI3LjUsNy41LTI3LjUsNy41cy0yLjUtMTAgMC0yMHMxMi41LTEyLjUsMjcuNS0xMi41czI3LjUsMi41LDI3LjUsMTIuNVM3Ny41LDY3LjUsNzcuNSw2Ny41eiIgZmlsbD0iI2ZlY2VkNiIvPjwvc3ZnPg==',
                    characterPrompt: '',
                    memorySize: 50,
                    theme: '1',
                    bubbleStyle: 'default',
                    // --- 新增的属性 ---
                    streak: 1, // 初始天数为1
                    lastChatDate: null // 上次聊天日期，初始为空
                },
                userPrompt: '', 
                chatHistory: [],
                userStickers: [],
                aiStickers: [],
                moments: [],
                diary: []
            };
        };
        
                const createNewGroupObject = (name, avatar, memberIds) => {
            const id = generateId('group');
            return {
                id, name, avatar, memberIds,
                userPrompt: '',
                chatHistory: [],
                polls: [],
                groupMoments: [],
                 memorySize: 80, // 为群聊设置默认记忆容量
                theme: '1',
                bubbleStyle: 'default',
            };
        };

                const loadChat = (type, id) => {
            currentChat = { type, id };
            currentlyDisplayedMessageCount = 25;
            const chatData = getCurrentChatData();
            if (!chatData) return;

            const isGroup = type === 'group';
            elements.actionCreatePoll.style.display = isGroup ? 'flex' : 'none';
            elements.actionSendRedPacket.style.display = isGroup ? 'flex' : 'none';
            elements.actionSendTransfer.style.display = isGroup ? 'none' : 'flex';
            elements.actionVideoCall.style.display = isGroup ? 'none' : 'flex';
            elements.actionShowDiary.style.display = isGroup ? 'none' : 'flex';

            if (type === 'direct') {
                const { config } = chatData;
                elements.chatNameHeader.textContent = config.characterName;
                elements.headerAvatar.src = config.aiAvatar;
                elements.headerAvatar.title = "读取他的心声";
                elements.headerAvatar.onclick = showMindVoice;
                elements.chatContainer.style.backgroundImage = config.chatBackground ? `url("${config.chatBackground}")` : '';
                applyTheme(config.theme, chatData);
                applyBubbleStyle(config.bubbleStyle, chatData);
            } else if (type === 'group') {
                elements.chatNameHeader.textContent = chatData.name;
                elements.headerAvatar.src = chatData.avatar;
                elements.headerAvatar.title = "群组信息";
                elements.headerAvatar.onclick = () => elements.settingsBtn.click();
                elements.chatContainer.style.backgroundImage = chatData.chatBackground ? `url("${chatData.chatBackground}")` : '';
                
                // 【关键修正】加载并应用群聊自己保存的样式
                applyTheme(chatData.theme, null); // 第二个参数为null，表示不是针对某个特定角色
                applyBubbleStyle(chatData.bubbleStyle, null);
            }
            
            renderAllMessages();
        };
      
        const applyCustomFont = (fontName, fontUrl) => {
            if (!fontName || !fontUrl) return;
            let styleTag = document.getElementById('runtime-custom-font-style');
            if (!styleTag) {
                styleTag = document.createElement('style');
                styleTag.id = 'runtime-custom-font-style';
                document.head.appendChild(styleTag);
            }
            const fontFaceRule = `@font-face { font-family: '${fontName}'; src: url('${fontUrl}'); }`;
            styleTag.innerHTML = fontFaceRule;
            applyFont(`'${fontName}'`);
            console.log(`已尝试应用自定义字体: ${fontName}`);
        };
      
            const saveCurrentSettings = async () => {
        const chatData = getCurrentChatData();
        if (!chatData) return;

        userMomentsProfile.chatAvatar = elements.userAvatarPreview.src;
        userMomentsProfile.momentsAvatar = elements.userMomentsAvatarPreview.src;
        userMomentsProfile.cover = elements.userMomentsCoverPreview.src;

        if (currentChat.type === 'direct') {
            const character = chatData;
            character.userPrompt = elements.userPromptInput.value;
            character.config = {
                ...character.config,
                characterName: elements.characterNameInput.value.trim() || '他', 
                characterPrompt: elements.characterPromptInput.value,
                aiAvatar: elements.aiAvatarPreview.src, 
                memorySize: parseInt(elements.memorySizeInput.value) || 50,
                theme: elements.themeSelector.querySelector('.theme-option.active')?.dataset.theme || '1',
                bubbleStyle: elements.bubbleStyleSelect.value,
            };
            character.config.chatBackground = elements.chatContainer.style.backgroundImage.slice(5, -2);
        } else { // 如果是群聊
            const group = chatData;
            group.name = elements.groupNameInput.value.trim() || '群聊';
            group.avatar = elements.groupAvatarPreview.src;
            group.chatBackground = elements.chatContainer.style.backgroundImage.slice(5, -2);
            group.userPrompt = elements.groupUserPromptInput.value;
                      group.memorySize = parseInt(elements.groupMemorySizeInput.value) || 80;

            // 【关键修正】在这里为群聊对象添加并保存样式设置
            group.theme = elements.themeSelector.querySelector('.theme-option.active')?.dataset.theme || '1';
            group.bubbleStyle = elements.bubbleStyleSelect.value;
        }
        
        const globalSettings = JSON.parse(localStorage.getItem('aiBoyfriendBackup_v7_meta') || '{}').globalSettings || {};
        globalSettings.uiScale = parseFloat(elements.uiScaleSlider.value) / 100;
        globalSettings.fontSize = parseInt(elements.fontSizeSlider.value);
        globalSettings.bubblePadding = parseInt(elements.bubbleSizeSlider.value);
        globalSettings.realTimeAwareness = elements.realTimeAwarenessToggle.checked;

        await saveAllData(); 
        loadChat(currentChat.type, currentChat.id);
    };

                        const openSettingsModal = () => {
        const chatData = getCurrentChatData();
        if (!chatData) return;
        
        elements.myProfileSettingsSection.style.display = 'block';
        elements.userAvatarPreview.src = userMomentsProfile.chatAvatar;
        elements.userMomentsAvatarPreview.src = userMomentsProfile.momentsAvatar; 
        elements.userMomentsCoverPreview.src = userMomentsProfile.cover;

        if (currentChat.type === 'direct') {
            const character = chatData;
            elements.characterSettingsSection.style.display = 'block';
            elements.groupSettingsSection.style.display = 'none';
            elements.characterDesignSettings.style.display = 'block'; 
            elements.characterDesignSettings.querySelector('h3').textContent = '当前角色设计';
            elements.deleteChatBtn.textContent = '删除此角色';
            
            elements.userPromptInput.value = character.userPrompt || ''; 
            getEl('group-user-prompt').closest('.form-group').style.display = 'none';
            getEl('user-prompt').closest('.form-group').style.display = 'flex';

            elements.characterNameInput.value = character.config.characterName;
            elements.aiAvatarPreview.src = character.config.aiAvatar;
            elements.memorySizeInput.value = character.config.memorySize;
            elements.characterPromptInput.value = character.config.characterPrompt;
            
            const charTheme = character.config.theme || '1';
            elements.themeSelector.querySelectorAll('.theme-option').forEach(opt => opt.classList.toggle('active', opt.dataset.theme === charTheme));
            elements.bubbleStyleSelect.value = character.config.bubbleStyle || 'default';

        } else { // 如果是群聊
            const group = chatData;
            elements.characterSettingsSection.style.display = 'none';
            elements.groupSettingsSection.style.display = 'block';
            
            // 【关键修正】重新显示样式设置，并修改标题提示
            elements.characterDesignSettings.style.display = 'block'; 
            elements.characterDesignSettings.querySelector('h3').textContent = '当前群聊基础设计'; // 告知用户这是群聊设置

            elements.deleteChatBtn.textContent = '删除此群聊';

            elements.groupUserPromptInput.value = group.userPrompt || '';
            getEl('group-user-prompt').closest('.form-group').style.display = 'flex';
            getEl('user-prompt').closest('.form-group').style.display = 'none';

            elements.groupNameInput.value = group.name;
            elements.groupAvatarPreview.src = group.avatar;
                        elements.groupMemorySizeInput.value = group.memorySize || 80;
            // 加载群聊当前保存的样式
            const groupTheme = group.theme || '1';
            elements.themeSelector.querySelectorAll('.theme-option').forEach(opt => opt.classList.toggle('active', opt.dataset.theme === groupTheme));
            elements.bubbleStyleSelect.value = group.bubbleStyle || 'default';
        }
        
        elements.settingsModal.classList.add('show');
    };
       const applyFont = (fontFamily) => {
            document.documentElement.style.setProperty('--font-main', fontFamily);
            document.documentElement.style.setProperty('--font-ui', fontFamily);
            if (elements.fontSelect.value !== fontFamily) {
                elements.fontSelect.value = fontFamily;
            }
        }; 

const applyBubbleStyle = (style, character) => {
    const container = elements.chatContainer;
    const customStyleTag = getEl('custom-bubble-style-tag');

    container.classList.remove('bubble-style-round', 'bubble-style-wechat', 'custom-style-active');
    customStyleTag.textContent = '';

    // 【关键修正】优先使用传入的style参数，如果它不存在，再从角色配置中读取
    const styleToApply = style || (character ? character.config.bubbleStyle : 'default');

    if (styleToApply === 'round') {
        container.classList.add('bubble-style-round');
    } else if (styleToApply === 'wechat') {
        container.classList.add('bubble-style-wechat');
    } else if (styleToApply === 'custom') {
        customStyleTag.textContent = getEl('advanced-bubble-styles').value;
        container.classList.add('custom-style-active');
    }
    
    // 更新设置界面里的下拉框，让它显示正确的样式
    if (elements.bubbleStyleSelect.value !== styleToApply) {
        elements.bubbleStyleSelect.value = styleToApply;
    }
};
      
        const handleFileUpload = (file, callback, compressionOptions = {}) => { 
            if (file) { 
                const reader = new FileReader(); 
                reader.onload = async (e) => {
                    let result = e.target.result;
                    if (compressionOptions.compress) {
                        try {
                            result = await compressImage(result, compressionOptions);
                        } catch (err) {
                            console.error("压缩图片时出错:", err);
                        }
                    }
                    callback(result); 
                }; 
                reader.readAsDataURL(file); 
            } 
        };
        
        const clearChatHistory = () => { 
            const chatData = getCurrentChatData();
            if(!chatData) return;
            const chatName = currentChat.type === 'direct' ? chatData.config.characterName : chatData.name;
            if (confirm(`确定要清空与「${chatName}」的全部聊天记录吗？此操作无法撤销。`)) { 
                chatData.chatHistory = []; 
                if (chatData.polls) chatData.polls = [];
                saveAllData(); 
                renderAllMessages(); 
                alert('聊天记录已清空。'); 
                closeModal(elements.settingsModal); 
            } 
        };

        // --- Chat & Message UI Logic ---
        const addMessage = (msgData, toHistory = true) => {
            const chatData = getCurrentChatData();
            if(!chatData) return;
        
            const fullMessage = { id: generateId('msg'), timestamp: getTimestamp(), ...msgData };

            if (toHistory) {
                chatData.chatHistory.push(fullMessage);
                if (fullMessage.type === 'poll' && currentChat.type === 'group') {
                    chatData.polls.push({ pollId: fullMessage.pollId, question: fullMessage.question, options: fullMessage.options, votes: {}, status: 'open' });
                }
                saveAllData();
            }

            const shouldScroll = elements.messagesContainer.scrollHeight - elements.messagesContainer.scrollTop <= elements.messagesContainer.clientHeight + 50;
            elements.messagesContainer.appendChild(addMessageToUI(fullMessage));
            if(shouldScroll) scrollToBottom(elements.messagesContainer, 'smooth');
            
            return fullMessage;
        };
        
                const addMessageToUI = (msg) => {
            const { sender, text, type = 'text', id } = msg;

            const messageElement = document.createElement('div');
            // 【核心修改 1】: 无论是什么消息，我们都先给它分配好ID！
            messageElement.dataset.id = id;

            // 现在我们分情况处理
            if (type === 'system') {
                // 这是处理“系统/报错”消息的分支
                messageElement.className = 'message system';
                messageElement.innerHTML = `<span>${text}</span>`;
                // 这里处理完后，会直接跳到函数末尾去绑定事件监听器
            } else {
                // 这是处理“普通聊天”消息的分支 (我们把旧代码挪到了这里)
                messageElement.className = `message message-bubble ${sender === 'user' ? 'user' : 'ai'}`;
                if (currentChat.type === 'group' && sender !== 'user') messageElement.classList.add('group-chat');
                if (msg.type === 'video_log') return document.createDocumentFragment();

                let senderData;
                if (sender === 'user') {
                    senderData = { avatar: userMomentsProfile.chatAvatar, name: userMomentsProfile.name };
                } else {
                    const char = characterSets.find(c => c.id === sender);
                    senderData = char ? { avatar: char.config.aiAvatar, name: char.config.characterName } : { avatar: getEl('header-avatar').src, name: '未知' };
                }

                const avatar = document.createElement('img');
                avatar.className = 'avatar';
                avatar.src = senderData.avatar;
                avatar.title = senderData.name;

                const contentWrapper = document.createElement('div');
                contentWrapper.className = 'message-content';
                
                const senderNameDiv = document.createElement('div');
                senderNameDiv.className = 'sender-name';
                senderNameDiv.textContent = senderData.name;

                const bubble = document.createElement('div');
                bubble.className = `bubble content message-${msg.type}`;
                
                let bubbleContent = '';
                
                switch(msg.type) {
                    case 'text': bubbleContent = `<p>${text.replace(/\n/g, '<br>')}</p>`; break;
                    case 'image': bubbleContent = `<img src="${msg.imageUrl}" class="bubble-image-content" alt="发送的图片">`; break;
                    case 'text-image': bubbleContent = `<div class="text-image-header"><svg viewBox="0 0 24 24"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg><span>展示了一张照片</span></div><div class="text-image-description">${text}</div>`; break;
                    case 'sticker': bubbleContent = `<img src="${msg.stickerUrl}" class="bubble-image-content" alt="表情" style="width:120px; height:120px; border: none;">`; break;
                    case 'voice': bubble.style.width = `${Math.min(60 + (text?.length || 0) * 8, 250)}px`; bubbleContent = `<span class="voice-icon"><svg viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"></path></svg></span><span class="voice-duration">${msg.voiceDuration}</span>`; bubble.onclick = () => alert(`语音内容：\n\n${text}`); break;
                                    case 'transfer':
                    const recipientName = sender === 'user' ? (getCurrentCharacter()?.config.characterName || '对方') : '你';
                    bubbleContent = `<img src="${msg.transferCoverUrl}" class="transfer-cover" alt="Transfer"><div class="transfer-info"><div class="transfer-amount">¥ ${msg.transferAmount}</div>${msg.transferMemo ? `<div class="transfer-memo">${msg.transferMemo}</div>` : ''}</div><div class="transfer-footer">给${recipientName}的转账</div>`;
                    
                    // --- 核心显示逻辑在这里！---
                    if (msg.transferStatus === 'received') {
                        bubbleContent += `<div class="transfer-acknowledged">${sender === 'user' ? '对方已收款' : '我已收款'}</div>`;
                    } else if (msg.transferStatus === 'declined') {
                        bubbleContent += `<div class="transfer-acknowledged" style="background: rgba(100,100,100,0.5);">${sender === 'user' ? '对方已拒收' : '已退还'}</div>`;
                    } else if (sender !== 'user') { 
                        // 只有AI发的、并且还未处理的转账，才添加点击收款事件
                        bubble.onclick = () => acknowledgeTransfer(id);
                    }
                    break;
                    case 'red-packet': bubble.innerHTML = renderRedPacket(msg); break;
                    case 'poll': bubble.innerHTML = renderPoll(msg); break;
                }
                if(msg.type !== 'poll' && msg.type !== 'red-packet') bubble.innerHTML = bubbleContent;

                const readStatus = Object.assign(document.createElement('span'), { className: 'read-status', textContent: '已读' });

                contentWrapper.append(senderNameDiv, bubble, Object.assign(document.createElement('div'), { className: 'timestamp', textContent: msg.timestamp }));
                messageElement.append(avatar, contentWrapper, readStatus);
            }

            // 【核心修改 2】: 无论是什么消息，最后都统一在这里绑定事件监听器！
            let pressTimer = null, isLongPress = false;
            const startPress = (e) => { e.preventDefault(); isLongPress = false; pressTimer = setTimeout(() => { isLongPress = true; if (!isMultiSelectMode) toggleMultiSelectMode(true); toggleMessageSelection(messageElement); }, 750); };
            const cancelPress = () => clearTimeout(pressTimer);
            const clickHandler = () => { if (isMultiSelectMode && !isLongPress) toggleMessageSelection(messageElement); };
            
            messageElement.addEventListener('mousedown', startPress);
            messageElement.addEventListener('mouseup', cancelPress);
            messageElement.addEventListener('mouseleave', cancelPress);
            messageElement.addEventListener('touchstart', startPress, { passive: true });
            messageElement.addEventListener('touchend', cancelPress);
            messageElement.addEventListener('touchmove', cancelPress);
            messageElement.addEventListener('click', clickHandler);

            return messageElement;
        };
                // 新增的“翻译官”函数，负责将自然语言转换为程序所需的JSON格式
                // 升级版“翻译官”函数，带有详细的探针
                       // 升级版“翻译官”函数，作为Plan B使用
        const convertToJSON = async (naturalLanguageResponse, targetActionType, moment, commentToReply) => {
            const apiBaseUrl = elements.apiBaseUrlInput.value.trim();
            const apiKey = elements.apiKeyInput.value.trim();
            const model = elements.modelSelect.value;
            if (!apiBaseUrl || !apiKey || !model) { throw new Error("API configuration is missing for JSON conversion."); }
            const isGemini = apiBaseUrl.includes('google');

            let conversionPrompt = `[Task]: Convert the following natural language text into a single JSON object based on the target action type.
[Natural Language Text]: "${naturalLanguageResponse}"
[Target Action Type]: "${targetActionType}"
[JSON Output Rules]: Your entire response MUST be a single, valid JSON object. Do NOT wrap it in an array ([]). Do NOT include any other text, explanations, or markdown.
[Example Formats]:
- For "moment_comment": {"type": "moment_comment", "momentId": "${moment?.id}", "comment_text": "The comment text"}
- For "moment_reply": {"type": "moment_reply", "momentId": "${moment?.id}", "commentId": "${commentToReply?.id}", "reply_text": "The reply text"}
[Your JSON output]:`;

            const conversionPayload = {
                model: model,
                messages: [{ role: 'user', content: conversionPrompt }],
                contents: [{ role: 'user', parts: [{ text: conversionPrompt }] }],
                generationConfig: { "temperature": 0.0 }
            };

            const fetchUrl = isGemini ? `${apiBaseUrl}/v1beta/models/${model}:generateContent?key=${apiKey}` : `${apiBaseUrl}/v1/chat/completions`;
            const headers = isGemini ? { 'Content-Type': 'application/json' } : { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` };

            const response = await fetch(fetchUrl, {
                method: 'POST',
                headers: headers,
                body: JSON.stringify(isGemini ? { contents: conversionPayload.contents, generationConfig: conversionPayload.generationConfig } : { model: conversionPayload.model, messages: conversionPayload.messages, temperature: 0.0 })
            });
            
            const rawTextResponse = await response.text();
            if (!response.ok) { throw new Error(`JSON conversion API call failed: ${rawTextResponse}`); }

            let jsonString = rawTextResponse;
            const parsedData = JSON.parse(rawTextResponse);
            if (isGemini) {
                jsonString = parsedData.candidates?.[0]?.content?.parts?.[0]?.text;
            } else {
                jsonString = parsedData.choices?.[0]?.message?.content;
            }
            if (!jsonString) throw new Error("AI did not return a string for JSON conversion.");

            jsonString = jsonString.replace(/^```json\s*/, '').replace(/\s*```$/, '');
            return JSON.parse(jsonString);
        };
        const renderAllMessages = () => {
            const chatData = getCurrentChatData();
            
            const oldScrollHeight = elements.messagesContainer.scrollHeight;
            const oldScrollTop = elements.messagesContainer.scrollTop;
            
            elements.messagesContainer.innerHTML = ''; 
            if (!chatData) return;

            const messagesToRender = chatData.chatHistory.slice(-currentlyDisplayedMessageCount);
            
            if (chatData.chatHistory.length > currentlyDisplayedMessageCount) {
                const loadMoreBtn = document.createElement('button');
                loadMoreBtn.id = 'load-more-btn';
                loadMoreBtn.textContent = '加载更早的记录';
                loadMoreBtn.onclick = () => {
                    currentlyDisplayedMessageCount += 20;
                    renderAllMessages();
                };
                elements.messagesContainer.appendChild(loadMoreBtn);
            }

            messagesToRender.forEach(msg => {
                elements.messagesContainer.appendChild(addMessageToUI(msg));
            });
            
            const newScrollHeight = elements.messagesContainer.scrollHeight;

            if (oldScrollHeight > 0 && chatData.chatHistory.length > messagesToRender.length) {
                elements.messagesContainer.scrollTop = oldScrollTop + (newScrollHeight - oldScrollHeight);
            } else {
                 scrollToBottom(elements.messagesContainer, 'auto');
            }
        };

        // --- Core Logic ---
        const handleUserAction = (msgData) => {
            const content = msgData.text || msgData.imageUrl || msgData.stickerUrl || msgData.llmContent || msgData.type === 'red-packet' || msgData.type === 'poll';
            if (!content) return;
            // TASK 5: Don't trigger AI response automatically
            addMessage(msgData);
                  // 如果是用户发送的文本或图片消息，就触发天数记录
        if (msgData.sender === 'user' && (msgData.type === 'text' || msgData.type === 'image')) {
            const character = getCurrentCharacter();
            if (character) {
                updateAndShowStreak(character);
            }
        }
        };
        
        const getRecentMomentsContext = (limit = 5) => {
            let allPosts = [];
            const chatData = getCurrentChatData();
            if (!chatData) return '';

            if (currentChat.type === 'direct') {
                const character = chatData;
                allPosts = [
                    ...(character.moments || []).map(m => ({ ...m, senderType: 'ai' })),
                    ...(userMomentsProfile.posts || []).map(p => ({ ...p, senderType: 'user' }))
                ];
            } else if (currentChat.type === 'group') {
                const group = chatData;
                allPosts = [...(group.groupMoments || [])];
            }

            if (allPosts.length === 0) return '';

            allPosts.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            const recentPosts = allPosts.slice(0, limit);

            if (recentPosts.length === 0) return '';

            const context = recentPosts.map(post => {
                let senderName = 'Unknown';
                if (post.senderId === 'user') {
                    senderName = userMomentsProfile.name || '我';
                } else {
                    const char = characterSets.find(c => c.id === post.senderId);
                    senderName = char ? char.config.characterName : 'Unknown';
                }
                return `[朋友圈动态 by ${senderName}: "${post.content}" (发表于: ${new Date(post.timestamp).toLocaleString()})]`;
            }).join('\n');

            return `\n\n[Recent Social Media Posts (朋友圈动态) for context]:\n${context}`;
        };

                                const triggerAiResponse = async () => {
            elements.receiveBtn.disabled = true;
            const chatData = getCurrentChatData();
            const apiBaseUrl = elements.apiBaseUrlInput.value.trim();
            const apiKey = elements.apiKeyInput.value.trim();
            const model = elements.modelSelect.value;

            if (!chatData || isVideoCallActive || !apiBaseUrl || !apiKey || !model) {
                elements.receiveBtn.disabled = false;
                if (apiBaseUrl.includes('google') && apiKey) {
                    // Gemini special case where key is in URL, so main field can be empty
                } else {
                     return;
                }
            }
            
            const isGemini = apiBaseUrl.includes('google');
            const avatarForNotif = (chatData.config && chatData.config.aiAvatar) ? chatData.config.aiAvatar : (chatData.avatar || '');
            showTopNotification("对方正在快速积极地敲键盘哦…", avatarForNotif, 5000);

            // --- 这就是之前被我错误省略掉的、定义 presetsPrompt 的关键代码 ---
            let systemPrompt;
            let history;
            const globalSystemPrompt = DEFAULT_SYSTEM_PROMPT;
            const momentsContext = getRecentMomentsContext();
            const activePresets = globalPresets.filter(p => p.enabled && p.content.trim() !== '');
            let presetsPrompt = activePresets.length > 0 ? activePresets.map(p => `[Active Preset: ${p.name || 'Untitled'}]\n${p.content}`).join('\n\n') + '\n\n' : '';
            // --- 关键代码结束 ---

            if (currentChat.type === 'direct') {
                const character = chatData;
                const memorySize = character.config.memorySize || 50;
                systemPrompt = `${presetsPrompt}${globalSystemPrompt}\n\n[Character Prompt]:\n${character.config.characterPrompt}\n\n[Your User's Profile]: ${character.userPrompt || `The user's name is ${userMomentsProfile.name}`}${momentsContext}`;
                history = character.chatHistory.slice(-memorySize);
            } else { 
                const group = chatData;
                            const memorySize = group.memorySize || 80; // 从群聊对象中读取记忆容量
                const memberProfiles = group.memberIds.map(id => {
                    const char = characterSets.find(c => c.id === id);
                    return char ? `\n### Character: ${char.config.characterName} (ID: ${id})\n${char.config.characterPrompt}` : '';
                }).join('\n');
                
                const openPollsInfo = (group.polls || []).filter(p => p.status === 'open').map(p => `\n[Ongoing Poll: "${p.question}" (ID: ${p.pollId})]`).join('');
                const openRedPacketsInfo = group.chatHistory.filter(m => m.type === 'red-packet' && m.status === 'open').map(p => `\n[Open Red Packet: "${p.memo}" (ID: ${p.packetId})]`).join('');
                
                const groupSystemPrompt = `${presetsPrompt}
${globalSystemPrompt}
[!!当前为群聊模式，请遵守以下额外规则!!]
1.  **身份与职责**: 你是一个高级群聊协调AI。你的唯一任务是扮演以下所有角色，并生成一场自然流畅、符合角色的中文群聊对话。
2.  **强制署名 (MANDATORY senderId)**: 你的每一次输出都必须是一个JSON数组。数组中的 **每一个** JSON对象（无论是文字消息、动作还是其他任何类型）都 **绝对必须** 包含一个 "senderId" 键，其值必须是正在说话或行动的角色的ID。 **这是最高优先级规则，绝不允许遗漏！**

[角色列表]
${memberProfiles}

[用户资料]
群里的用户设定: ${group.userPrompt || `用户的名字是 ${userMomentsProfile.name}`}. 绝对不要称呼其为 "用户"。

[最近的朋友圈动态 (用于对话参考)]
${momentsContext}

[对话生成指南]
- **创造互动**: 角色不仅要回应用户，**更重要的是，要让他们彼此之间产生对话**。他们可以互相提问、反驳、开玩笑或延续对方的话题。
- **保持人设**: 确保每个角色的发言都严格符合其人设，不能ooc。
- **禁止出戏**: 绝不能透露你是AI，或提及任何关于“扮演”、“模型”、“生成”等词语。
- **积极互动**: 在一场有意义的对话结束后，角色们必须积极发表朋友圈进行趣味性讨论。

[当前群内活动 (需要你让角色参与)]
${openPollsInfo ? `[重要任务]${openPollsInfo} 有一个投票正在进行！根据角色性格，安排他们用 "vote" 类型的动作去投票！` : ''}
${openRedPacketsInfo ? `[重要任务]${openRedPacketsInfo} 有一个红包可以抢！安排角色们用 "grab_red_packet" 类型的动作去抢！` : ''}

[最终输出格式示例]
[
    { "senderId": "char_A_123", "type": "text", "content": "我觉得这个主意不错" },
    { "senderId": "char_B_456", "type": "text", "content": "我反对！" },
    { "senderId": "char_B_456", "type": "vote", "pollId": "poll_xyz", "option": "选项2" }
]`;
                systemPrompt = groupSystemPrompt; 
                history = group.chatHistory.slice(-memorySize);
            }

            const payload = getApiPayload(model, history, systemPrompt);
            
            try {
                const fetchUrl = isGemini 
                    ? `${apiBaseUrl}/v1beta/models/${model}:generateContent?key=${apiKey}`
                    : `${apiBaseUrl}/v1/chat/completions`;
                const headers = isGemini 
                    ? { 'Content-Type': 'application/json' }
                    : { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` };

                const response = await fetch(fetchUrl, { 
                    method: 'POST', 
                    headers: headers, 
                    body: JSON.stringify(payload) 
                });
                
                if (!response.ok) { const errorData = await response.text(); throw new Error(`HTTP Error ${response.status}: ${errorData}`); }
                const responseData = await response.json();
                
                if (responseData.error) { throw new Error(`API Error: ${responseData.error.message || JSON.stringify(responseData.error)}`); }

                let content = '';
                if (isGemini) {
                    if (!responseData.candidates || responseData.candidates.length === 0) {
                        const safetyFeedback = responseData.promptFeedback?.blockReason || '未知安全原因';
                        const finishReason = responseData.candidates?.[0]?.finishReason || '未知';
                        throw new Error(`Gemini由于 (${safetyFeedback}/${finishReason}) 阻止了回复，请检查您的提示词或API安全设置。`);
                    }
                    content = responseData.candidates[0]?.content?.parts?.[0]?.text;
                } else {
                    content = responseData.choices?.[0]?.message?.content;
                }

                if (content) {
                    processAiResponse(content);
                } else { 
                    throw new Error('Invalid or empty API response format.'); 
                }
            } catch (error) {
                addMessage({ sender: 'system', text: `错误: ${error.message}`, type: 'system' });
            } finally {
                elements.receiveBtn.disabled = false;
            }
        };
        
                        const processAiResponse = (rawText) => {
            let responseArray = [];
                        try {
                // --- 终极净化器 ---
                // 步骤1: 使用正则表达式，从AI返回的杂乱文本中，强行“抠出”被[]包裹的、我们真正需要的部分。
                // 这个正则表达式 [\s\S]*? 能匹配包括换行符在内的所有字符。
                const jsonMatch = rawText.match(/\[[\s\S]*?\]/);
                
                let jsonString = null;

                if (jsonMatch) {
                    // 步骤2: 如果成功“抠出”，我们就得到了一个可能还含有换行符的字符串。
                    // 步骤3: 在解析前，我们把抠出来的这部分里的所有换行符(\n)、回车符(\r)、制表符(\t)都替换掉。
                    jsonString = jsonMatch[0].replace(/[\n\r\t]/g, '');
                } else {
                    // 如果连[]都找不到，说明格式错得太离谱，直接抛出错误，交给catch处理。
                    throw new Error("在AI的回复中找不到有效的JSON数组结构。");
                }
                
                // 步骤4: 将这个被彻底净化过的、干干净净的字符串送去解析。
                if (jsonString) {
                    responseArray = JSON.parse(jsonString);
                } else {
                    throw new Error("净化后未能获得有效的JSON字符串。");
                }
                       } catch (e) {
                // 首先，还是在控制台里记录一下原始错误，方便以后万一有问题还能看到
                console.error("JSON解析失败，启动Plan B。原始错误:", e);
                console.error("收到的原始文本:", rawText);

                // 给用户一个友好的提示，告诉他我们正在尝试补救
                addMessage({ sender: 'system', text: `AI回复格式不标准，已尝试按文本内容解析。`, type: 'system' });

                // 这是我们的“Plan B”核心：
                // 1. 确定是谁在说话
                const senderId = currentChat.type === 'direct' ? currentChat.id : null;
                
                // 只有在能确定发送者的情况下才继续（单聊模式）
                if (senderId) {
                    // 2. 把可能存在的JSON符号、标记都清理掉，只留下纯文本
                    const plainText = rawText.replace(/```json|```|\[|\]|\{|\}/g, '').trim();

                    // 3. 按换行符把文本分割成一行一行的数组
                    const lines = plainText.split('\n');

                    // 4. 遍历每一行，只要不是空行，就作为一条新消息发送出来
                    lines.forEach(line => {
                        if (line.trim()) { // 确保不是空的行
                            addMessage({
                                sender: senderId,
                                type: 'text',
                                text: line.trim() // 发送清理过的单行文本
                            });
                        }
                    });
                }
            }
            if (!Array.isArray(responseArray) || responseArray.length === 0) { return; }

            let dataChanged = false;
            let aiMemoryInjections = {}; 

            responseArray.forEach(msgObj => {
                // ... (兼容旧格式的代码保持不变) ...
                 if (!msgObj.type) {
                    if (msgObj.packetId || msgObj.redPacketId) msgObj.type = 'grab_red_packet';
                    else if (msgObj.pollId && msgObj.option) msgObj.type = 'vote';
                    else if (msgObj.will_like === true) msgObj.type = 'moment_like';
                    else if (msgObj.momentId && msgObj.comment_text) msgObj.type = 'moment_comment';
                    else if (msgObj.momentId && msgObj.reply_text) msgObj.type = 'moment_reply';
                    else if (msgObj.transferId && msgObj.decision) msgObj.type = 'acknowledge_transfer';
                }

                // --- 【决定性修复 2：优先使用AI自己的签名】 ---
                // 只有在AI真的、真的忘了签名的情况下，我们才使用备用方案
                const senderId = msgObj.senderId || currentChat.id;
                const momentType = currentChat.type === 'group' ? 'group' : 'direct';
                
                switch(msgObj.type) {
                    case 'vote': if (senderId) { handleAiVote_dataOnly(msgObj); dataChanged = true; } break;
                    case 'grab_red_packet':
                        if (senderId) {
                            const currentPacketId = msgObj.packetId || msgObj.redPacketId;
                            if (currentPacketId) {
                                const amount = handleAiGrabRedPacket(currentPacketId, senderId);
                                if (typeof amount === 'number') {
                                    aiMemoryInjections[senderId] = `[Internal Memo: You just grabbed a red packet and got ${amount.toFixed(2)} yuan.]`;
                                }
                                dataChanged = true;
                            }
                        }
                        break;
                    case 'acknowledge_transfer': if (msgObj.transferId && msgObj.decision) { if (handleAcknowledgeTransfer(msgObj.transferId, msgObj.decision)) { dataChanged = true; } } break;
                    case 'moment_like': if (senderId && msgObj.momentId) { handleAiLike(msgObj.momentId, senderId, momentType); dataChanged = true; } break;
                    case 'moment_comment': if (senderId && msgObj.momentId && msgObj.comment_text) { addCommentOrReplyByAI('comment', msgObj.momentId, msgObj.comment_text, senderId, null, momentType); dataChanged = true; } break;
                    case 'moment_reply': if (senderId && msgObj.momentId && msgObj.reply_text) { addCommentOrReplyByAI('reply', msgObj.momentId, msgObj.reply_text, senderId, msgObj.commentId, momentType); dataChanged = true; } break;
                }
            });

            if (dataChanged) {
                renderAllMessages();
                if (elements.momentsOverlay.classList.contains('show')) renderMoments();
            }

            // --- 界面显示部分 (这部分没有逻辑错误，保持原样) ---
            responseArray.forEach((msgObj, index) => {
                const isAction = ['vote', 'grab_red_packet', 'moment_like', 'moment_comment', 'moment_reply', 'acknowledge_transfer'].includes(msgObj.type);
                if (isAction) return;
                
                if (!msgObj.type && (msgObj.content || msgObj.message)) { msgObj.type = 'text'; msgObj.content = msgObj.content || msgObj.message; }
                
                setTimeout(() => {
                    const senderId = msgObj.senderId || currentChat.id;
                    const character = characterSets.find(c => c.id === senderId);
                    if (!character) return;
                    
                    let llmContentForHistory = (index === 0) ? rawText : null;
                    if (aiMemoryInjections[senderId]) { llmContentForHistory = (llmContentForHistory || '') + '\n' + aiMemoryInjections[senderId]; delete aiMemoryInjections[senderId]; }
                    
                    let messageData = { sender: senderId, llmContent: llmContentForHistory };

                    switch (msgObj.type) {
                        case 'text': addMessage({ ...messageData, text: msgObj.content, type: 'text' }); break;
                        case 'voice': addMessage({ ...messageData, text: msgObj.content, type: 'voice', voiceDuration: `0:${Math.max(1, Math.round((msgObj.content || '').length / 5)).toString().padStart(2, '0')}` }); break;
                        case 'text-image': addMessage({ ...messageData, text: msgObj.content, type: 'text-image' }); break;
                        case 'sticker': if (character.aiStickers.length > 0) { addMessage({ ...messageData, type: 'sticker', stickerUrl: character.aiStickers[Math.floor(Math.random() * character.aiStickers.length)] }); } break;
                        case 'transfer': addMessage({ ...messageData, type: 'transfer', transferAmount: msgObj.amount, transferMemo: msgObj.memo, transferCoverUrl: `https://files.catbox.moe/qwu221.jpg`, transferStatus: 'pending' }); break;
                        case 'video-call-request': if (currentChat.type === 'direct') handleIncomingVideoCall(msgObj.content); break;
                        case 'post_moment': if (character) { const momentType = currentChat.type === 'group' ? 'group' : 'direct'; addMomentByAI(character.id, { content: msgObj.content, image_query: msgObj.image_query }, momentType); } break;
                        case 'diary_entry':
                            if (character && msgObj.content) {
                                const today = new Date();
                                const year = today.getFullYear();
                                const month = String(today.getMonth() + 1).padStart(2, '0');
                                const day = String(today.getDate()).padStart(2, '0');
                                const todayString = `${year}-${month}-${day}`;
                                addDiaryEntry(character.id, msgObj.content, todayString);
                            }
                            break;
                    }
                }, index * 1200 + (dataChanged ? 200 : 0));
            });
        };
        
        const handleAcknowledgeTransfer = (transferId, decision) => {
            const character = getCurrentCharacter();
            if (!character || !character.chatHistory) return;

            const transferMsg = character.chatHistory.find(m => m.id === transferId && m.sender === 'user');
            
            if (transferMsg && transferMsg.transferStatus === 'pending') {
                if (decision === 'accept') {
                    transferMsg.transferStatus = 'received';
                } else if (decision === 'decline') {
                    transferMsg.transferStatus = 'declined';
                }
                saveAllData();
                return true; // 表示操作成功
            }
            return false; // 表示没找到或者已经处理过了
        };
        
        const acknowledgeTransfer = (msgId) => {
            const chatData = getCurrentChatData();
            if(!chatData) return;
            const transferMsg = chatData.chatHistory.find(m => String(m.id) === String(msgId));
            if (transferMsg && transferMsg.sender !== 'user' && transferMsg.transferStatus !== 'received') {
                if (confirm('确定要接收这笔转账吗？')) {
                    transferMsg.transferStatus = 'received';
                    saveAllData();
                    renderAllMessages();
                }
            }
        };

        const toggleMultiSelectMode = (enable) => {
            isMultiSelectMode = enable;
            elements.messagesContainer.classList.toggle('multi-select-mode', enable);
            elements.deleteToolbar.classList.toggle('show', enable);
            elements.inputArea.style.visibility = enable ? 'hidden' : 'visible';
            if (!enable) {
                selectedMessageIds = [];
                document.querySelectorAll('.message.selected').forEach(el => el.classList.remove('selected'));
            }
        };
        const toggleMessageSelection = (messageElement) => {
            const id = messageElement.dataset.id;
            if (!id) return;
            messageElement.classList.toggle('selected');
            const index = selectedMessageIds.indexOf(id);
            if (index > -1) { selectedMessageIds.splice(index, 1); } else { selectedMessageIds.push(id); }
            elements.deleteInfo.textContent = selectedMessageIds.length > 0 ? `已选择 ${selectedMessageIds.length} 项` : '';
            if (selectedMessageIds.length === 0) { toggleMultiSelectMode(false); }
        };
        const deleteSelectedMessages = () => {
            const chatData = getCurrentChatData();
            if(!chatData || selectedMessageIds.length === 0) return;
            chatData.chatHistory = chatData.chatHistory.filter(msg => !selectedMessageIds.includes(String(msg.id)));
            saveAllData();
            renderAllMessages();
            toggleMultiSelectMode(false);
        };
        
        const toggleActionPanel = (forceClose = false) => { isActionPanelOpen = forceClose ? false : !isActionPanelOpen; elements.actionPanel.classList.toggle('show', isActionPanelOpen); elements.actionBtn.style.transform = isActionPanelOpen ? 'rotate(45deg)' : 'rotate(0)'; };
        let onFeatureModalSubmit = null;
        const openFeatureModal = (title, bodyHtml, submitText, onSubmit) => { elements.featureModalTitle.textContent = title; elements.featureModalBody.innerHTML = bodyHtml; elements.featureModalSubmitBtn.style.display = onSubmit ? 'inline-block' : 'none'; if(onSubmit){ elements.featureModalSubmitBtn.textContent = submitText; onFeatureModalSubmit = onSubmit; } elements.featureModal.classList.add('show'); };
        
        const handleTextImageSend = () => { openFeatureModal('描述一张图片', `<div class="form-group"><label for="text-image-input">请输入图片描述:</label><textarea id="text-image-input" rows="4"></textarea></div>`, '发送', () => { const text = getEl('text-image-input').value.trim(); if (text) { handleUserAction({ sender: 'user', type: 'text-image', text, llmContent: `[展示了一张照片。照片内容: ${text}]` }); closeModal(elements.featureModal); } }); };
        const handleVoiceSend = () => { openFeatureModal('发送语音消息', `<div class="form-group"><label for="voice-text-input">请输入你想“说”的内容:</label><textarea id="voice-text-input" rows="4"></textarea></div>`, '发送', () => { const text = getEl('voice-text-input').value.trim(); if (text) { handleUserAction({ sender: 'user', type: 'voice', text, voiceDuration: `0:${Math.max(1, Math.round(text.length / 5)).toString().padStart(2, '0')}`, llmContent: `[发送了一条语音消息。内容是: ${text}]` }); closeModal(elements.featureModal); } }); };
        const handleTransferSend = () => { let tempCover = "https://images.unsplash.com/photo-1593697821028-7655f8458345?q=80&w=400"; openFeatureModal('转账', `<div class="form-group"><label>转账封面</label><img id="transfer-preview" src="${tempCover}" style="width:100%; height:110px; object-fit:cover; border-radius:8px; margin-bottom:10px; cursor:pointer;"></div><div class="form-group"><label for="transfer-amount">金额</label><input type="number" id="transfer-amount" placeholder="0.00"></div><div class="form-group"><label for="transfer-memo">备注</label><input type="text" id="transfer-memo" placeholder="（选填）"></div>`, '发送', () => { const amount = getEl('transfer-amount').value; if (amount > 0) { const memo = getEl('transfer-memo').value.trim(); handleUserAction({ sender: 'user', type: 'transfer', transferAmount: parseFloat(amount).toFixed(2), transferMemo: memo, transferCoverUrl: tempCover, transferStatus: 'pending', llmContent: `[转账 ${amount} 元。备注: ${memo}]` });closeModal(elements.featureModal); } }); getEl('transfer-preview').onclick = () => elements.transferCoverInput.click(); elements.transferCoverInput.onchange = (e) => handleFileUpload(e.target.files[0], (d) => { tempCover = d; getEl('transfer-preview').src = d; }); };
        const handleStickerSend = () => { if (currentChat.type !== 'direct') {alert('群聊中暂不支持发送表情。'); return;} const character = getCurrentCharacter(); if(!character) return; let galleryHtml = '<p style="text-align:center;color:#999">没有表情。请在设置中添加。</p>'; if (character.userStickers.length > 0) galleryHtml = character.userStickers.map(url => `<img src="${url}" data-sticker-url="${url}" alt="sticker">`).join(''); openFeatureModal('选择表情', `<div id="sticker-gallery">${galleryHtml}</div>`, null, null); getEl('sticker-gallery').onclick = e => { if (e.target.tagName === 'IMG') { handleUserAction({ sender: 'user', type: 'sticker', stickerUrl: e.target.dataset.stickerUrl, llmContent: '[发送了一个表情]' }); closeModal(elements.featureModal); } }; };
        
        // --- Video Call Logic (Fully Isolated) ---
        const addVideoChatMessageToUI = (msg) => { const msgEl = document.createElement('div'); msgEl.className = `video-chat-message ${msg.sender === 'user' ? 'user' : 'ai'}`; msgEl.innerHTML = msg.text.replace(/\*(.*?)\*/g, '<i>$1</i>'); elements.videoChatLog.appendChild(msgEl); scrollToBottom(elements.videoChatLog); };
                        const triggerVideoCallAIResponse = async () => {
            if (currentChat.type !== 'direct') return;
            const character = getCurrentCharacter();
            if(!character) return;
            const { config } = character;
            const apiBaseUrl = elements.apiBaseUrlInput.value.trim();
            const apiKey = elements.apiKeyInput.value.trim();
            const model = elements.modelSelect.value;
            const isGemini = apiBaseUrl.includes('google');

            if (!apiBaseUrl || !apiKey || !model) return;
            
            elements.videoStatusText.textContent = `${config.characterName}正在输入...`;
            const videoCallSystemPrompt = `${config.characterPrompt}\n[Current Situation: You are in a video call with the user.]\n[Special Instruction]\n- Your entire reply must be plain text, strictly following the format: "*expression or action* dialogue content".\n- Keep the dialogue short and natural, around 20-30 characters.`;
            const videoHistory = Array.from(elements.videoChatLog.children).map(el => ({ role: el.classList.contains('user') ? 'user' : 'assistant', content: el.textContent }));
            
            const historyForPayload = videoHistory.slice(-10).map(msg => ({
                sender: msg.role === 'user' ? 'user' : 'ai',
                text: msg.content
            }));
            const payload = getApiPayload(model, historyForPayload, videoCallSystemPrompt);

            try {
                const fetchUrl = isGemini
                    ? `${apiBaseUrl}/v1beta/models/${model}:generateContent?key=${apiKey}`
                    : `${apiBaseUrl}/v1/chat/completions`;
                const headers = isGemini
                    ? { 'Content-Type': 'application/json' }
                    : { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` };

                const response = await fetch(fetchUrl, { method: 'POST', headers: headers, body: JSON.stringify(payload) });

                if (!response.ok) throw new Error(`HTTP Error ${response.status}: ${await response.text()}`);
                const responseData = await response.json();
                
                if (responseData.error) { throw new Error(`API Error: ${responseData.error.message || JSON.stringify(responseData.error)}`); }

                let content = '';
                if (isGemini) {
                    if (!responseData.candidates || responseData.candidates.length === 0) { throw new Error(`Gemini由于安全原因阻止了回复。`); }
                    content = responseData.candidates[0]?.content?.parts?.[0]?.text;
                } else {
                    content = responseData.choices?.[0]?.message?.content;
                }

                if (content) {
                    addVideoChatMessageToUI({ sender: character.id, text: content });
                    elements.videoStatusText.textContent = "通话中";
                } else {
                    throw new Error('Invalid video call API response format.');
                }
            } catch (error) {
                addVideoChatMessageToUI({ sender: character.id, text: `(连接错误: ${error.message})` });
                elements.videoStatusText.textContent = "连接错误";
            }
        };
        const startVideoCall = () => { if (currentChat.type !== 'direct') return; const character = getCurrentCharacter(); if(!character) return; const { config } = character; const apiBaseUrl = elements.apiBaseUrlInput.value.trim(); const apiKey = elements.apiKeyInput.value.trim(); const model = elements.modelSelect.value; if (!apiBaseUrl || !apiKey || !model) { alert('请先在设置中填写API信息。'); return; } isVideoCallActive = true; elements.videoMainView.src = config.aiAvatar; elements.videoSelfView.src = userMomentsProfile.chatAvatar; elements.videoCharacterAvatar.src = config.aiAvatar; elements.videoCharacterName.textContent = config.characterName; elements.videoStatusText.textContent = "正在呼叫..."; elements.videoChatLog.innerHTML = ''; elements.videoControls.innerHTML = `<button class="video-btn decline"><svg viewBox="0 0 24 24"><path d="M12 9c-1.6 0-3.15.25-4.62.72v3.1c0 .39-.23.74-.56.9-.98.49-1.87 1.1-2.69 1.8l-1.1-1.1c.99-.99 2.1-1.82 3.31-2.48C7.06 10.72 9.03 10 12 10c.05 0 .1 0 .16.01l2.4-2.4C13.84 7.23 12.95 7 12 7c-4.97 0-9 4.03-9 9H0c0-6.08 4.92-11 11-11 .34 0 .67.02 1 .05l-1.43 1.43C12.21 9.02 12.11 9 12 9zM1.39 4.22l2.27 2.27C2.63 7.62 2 8.91 2 10.31v3.1c1.53-.69 3.23-1.14 5.08-1.28l3.43 3.43c-3.11.3-6.01 1.54-7.96 3.4l1.41 1.41c2.19-2.19 5.08-3.48 8.04-3.83l2.84 2.84c.32.32.88.1.88-.36V13.5c.75-.24 1.46-.56 2.12-.95l2.07 2.07 1.41-1.41L2.81 2.81 1.39 4.22zM21 5h-2.59l4.59 4.59-1.41 1.41L12 1.41 2.81 11.59l-1.41-1.41L6 5.59V5h2v.59l4-4 4 4V5h2v3.41l2.29-2.29C23.36 5.64 22.25 5 21 5z"/></svg></button>`; elements.videoControls.querySelector('.decline').onclick = endVideoCall; elements.videoCallOverlay.classList.add('show'); addVideoChatMessageToUI({ sender: 'user', text: '[发起视频通话]' }); triggerVideoCallAIResponse(); };
        const handleIncomingVideoCall = (text) => { if (currentChat.type !== 'direct') return; const { config } = getCurrentCharacter(); elements.videoMainView.src = config.aiAvatar; elements.videoSelfView.src = userMomentsProfile.chatAvatar; elements.videoCharacterAvatar.src = config.aiAvatar; elements.videoCharacterName.textContent = config.characterName; elements.videoStatusText.textContent = text || "视频来电..."; elements.videoChatLog.innerHTML = ''; elements.videoControls.innerHTML = `<button class="video-btn accept"><svg viewBox="0 0 24 24"><path d="M20.01 15.38c-1.23 0-2.42-.2-3.53-.56-.35-.12-.74-.03-1.01.24l-1.57 1.97c-2.83-1.35-5.21-3.72-6.56-6.56l1.97-1.57c.27-.27.36-.66.24-1.01-.37-1.11-.56-2.3-.56-3.53 0-.54-.45-.99-.99-.99H4.19c-.55 0-.99.45-.99.99 0 9.02 7.38 16.4 16.4 16.4.55 0 .99-.45.99-.99v-3.47c0-.54-.45-.99-.99-.99z"/></svg></button> <button class="video-btn decline"><svg viewBox="0 0 24 24"><path d="M12 9c-1.6 0-3.15.25-4.62.72v3.1c0 .39-.23.74-.56.9-.98.49-1.87 1.1-2.69 1.8l-1.1-1.1c.99-.99 2.1-1.82 3.31-2.48C7.06 10.72 9.03 10 12 10c.05 0 .1 0 .16.01l2.4-2.4C13.84 7.23 12.95 7 12 7c-4.97 0-9 4.03-9 9H0c0-6.08 4.92-11 11-11 .34 0 .67.02 1 .05l-1.43 1.43C12.21 9.02 12.11 9 12 9zM1.39 4.22l2.27 2.27C2.63 7.62 2 8.91 2 10.31v3.1c1.53-.69 3.23-1.14 5.08-1.28l3.43 3.43c-3.11.3-6.01 1.54-7.96 3.4l1.41 1.41c2.19-2.19 5.08-3.48 8.04-3.83l2.84 2.84c.32.32.88.1.88-.36V13.5c.75-.24 1.46-.56 2.12-.95l2.07 2.07 1.41-1.41L2.81 2.81 1.39 4.22zM21 5h-2.59l4.59 4.59-1.41 1.41L12 1.41 2.81 11.59l-1.41-1.41L6 5.59V5h2v.59l4-4 4 4V5h2v3.41l2.29-2.29C23.36 5.64 22.25 5 21 5z"/></svg></button>`; elements.videoControls.querySelector('.accept').onclick = () => { isVideoCallActive = true; elements.videoStatusText.textContent = "已接通"; elements.videoControls.innerHTML = elements.videoControls.innerHTML.replace(/<button class="video-btn accept">.*?<\/button>/, ''); addVideoChatMessageToUI({sender:'user', text:'[接听了视频通话]'}); triggerVideoCallAIResponse(); }; elements.videoControls.querySelector('.decline').onclick = () => { elements.videoCallOverlay.classList.remove('show'); }; elements.videoCallOverlay.classList.add('show'); };
        const endVideoCall = () => {
			const chatLogChildren = elements.videoChatLog.children;
			if (!getCurrentCharacter()) { 
				isVideoCallActive = false;
				elements.videoCallOverlay.classList.remove('show');
				return; 
			}
			if (isVideoCallActive && chatLogChildren.length > 1) {
				const character = getCurrentCharacter();
				const conversationForAI = Array.from(chatLogChildren).map(el => {
					const speaker = el.classList.contains('user') ? 'user' : character.config.characterName;
					return `${speaker}: ${el.textContent}`;
				}).join('\n');
				const memoryContent = `[我刚刚和用户结束了一次视频通话，为了记住我们聊了什么，这是通话记录：\n${conversationForAI}\n]`;
				addMessage({
					sender: 'system',
					type: 'video_log',
					llmContent: memoryContent
				});
			}
			isVideoCallActive = false;
			elements.videoCallOverlay.classList.remove('show');
		};
        
                        const showMindVoice = async () => {
            if (currentChat.type !== 'direct') return;
            const character = getCurrentCharacter();
            if (!character) return;
            const { config, chatHistory } = character;
            const apiBaseUrl = elements.apiBaseUrlInput.value.trim();
            const apiKey = elements.apiKeyInput.value.trim();
            const model = elements.modelSelect.value;
            const isGemini = apiBaseUrl.includes('google');

            if (!apiBaseUrl || !apiKey || !model) {
                elements.mindVoiceContent.textContent = '请先在设置中填写API信息。';
                elements.mindVoiceModal.classList.add('show');
                return;
            }

            elements.mindVoiceContent.textContent = '思考中...';
            elements.mindVoiceModal.classList.add('show');

                        const mindVoiceSystemPrompt = `[CRITICAL TASK: INNER MONOLOGUE]
[MANDATORY OUTPUT FORMAT]: Your entire response MUST be a single, short sentence of plain text.
[ABSOLUTELY FORBIDDEN]: Do NOT use JSON. Do NOT use markdown. Do NOT use arrays ([]). Do NOT use objects ({}). Do NOT use quotation marks. Do NOT write dialogue.

[Persona]:
${config.characterPrompt}

[Your Task]: Analyze the recent chat history. Based on your persona, write a single, private, unspoken thought. This is your character's immediate inner feeling. It is NOT a message to the user.

[Example of CORRECT Output]:
I can't believe she actually said that.

[Example of INCORRECT, FORBIDDEN Output]:
[{"type": "text", "content": "I can't believe she actually said that."}]
`;
                
            const payload = getApiPayload(model, chatHistory.slice(-config.memorySize), mindVoiceSystemPrompt);

            try {
                const fetchUrl = isGemini
                    ? `${apiBaseUrl}/v1beta/models/${model}:generateContent?key=${apiKey}`
                    : `${apiBaseUrl}/v1/chat/completions`;
                const headers = isGemini
                    ? { 'Content-Type': 'application/json' }
                    : { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` };

                const response = await fetch(fetchUrl, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error(`服务器错误 ${response.status}: ${await response.text()}`);
                const responseData = await response.json();
                
                if (responseData.error) { throw new Error(`API返回错误: ${responseData.error.message || JSON.stringify(responseData.error)}`); }

                let content = '';
                if (isGemini) {
                    if (!responseData.candidates || responseData.candidates.length === 0) {
                        const safetyFeedback = responseData.promptFeedback?.blockReason || '未知';
                        throw new Error(`Gemini由于安全原因 (${safetyFeedback}) 阻止了回复。`);
                    }
                    content = responseData.candidates[0]?.content?.parts?.[0]?.text;
                } else {
                    content = responseData.choices?.[0]?.message?.content;
                }

                                if (content) {
                    let thought = '';
                    try {
                        // 步骤1: 尝试解析为JSON，万一AI还是不听话
                        const parsed = JSON.parse(content);
                        if (Array.isArray(parsed) && parsed.length > 0) {
                            // 步骤2: 从JSON数组里找到第一条文本消息
                            for (const item of parsed) {
                                if (item.type === 'text' && item.content) {
                                    thought = item.content;
                                    break; // 找到就立刻停止
                                }
                            }
                        }
                    } catch (e) {
                        // 步骤3: 如果解析失败，说明它可能已经是纯文本了，直接使用
                        thought = content;
                    }

                    // 步骤4: 如果上面的步骤都没找到思想，就用原始回复作为最后的保障
                    if (!thought) {
                        thought = content;
                    }
                    
                    // 最后，清理一下可能残留的符号并显示
                    elements.mindVoiceContent.textContent = thought.replace(/\[|\]|\{|\}|"type"|"content"|:|"/g, '').trim();

                } else {
                    throw new Error('API没有返回有效的心声内容。');
                }
            } catch (error) {
                elements.mindVoiceContent.textContent = `读取心声失败: ${error.message}`;
            }
        };

        const openStickerManager = (context) => { if (currentChat.type !== 'direct') return; const character = getCurrentCharacter(); if(!character) return; let stickerManagementContext = context; const currentStickers = context === 'user' ? character.userStickers : character.aiStickers; let galleryHtml = '<p style="text-align:center; color:#999;">点击下方按钮添加，点击已添加的表情可删除。</p>' + currentStickers.map(url => `<img src="${url}" data-sticker-url="${url}" alt="sticker">`).join(''); openFeatureModal(context === 'user' ? '我的表情管理' : '他的表情管理', `<div id="sticker-gallery" style="margin-bottom:15px;">${galleryHtml}</div><button id="add-stickers-btn" class="file-input-label" style="text-align:center; width:100%;">从相册批量添加</button>`, '完成', () => closeModal(elements.featureModal)); getEl('add-stickers-btn').onclick = () => elements.stickerUploadInput.click(); getEl('sticker-gallery').onclick = e => { if (e.target.tagName === 'IMG') { if(confirm('要删除这个表情吗？')) { const urlToDelete = e.target.dataset.stickerUrl; if(stickerManagementContext === 'user') character.userStickers = character.userStickers.filter(url => url !== urlToDelete); else character.aiStickers = character.aiStickers.filter(url => url !== urlToDelete); saveAllData(); e.target.remove(); } } }; elements.stickerUploadInput.onchange = (e) => { Array.from(e.target.files).forEach((file, i, arr) => { handleFileUpload(file, (result) => { if (stickerManagementContext === 'user') character.userStickers.push(result); else character.aiStickers.push(result); if (i === arr.length - 1) { saveAllData(); alert(`已成功添加 ${arr.length} 个表情！`); closeModal(elements.featureModal); openStickerManager(stickerManagementContext); } }); }); e.target.value = ''; }; };

        // --- Chat Management Logic (Characters & Groups) ---
        const openChatManager = () => {
            const bodyHtml = `
                <div class="chat-manager-tabs">
                    <div class="chat-manager-tab active" data-tab="direct">单人聊天</div>
                    <div class="chat-manager-tab" data-tab="group">群组聊天</div>
                </div>
                <div id="direct-chat-list" class="chat-manager-content active">
                    <div class="chat-list">
                        ${characterSets.map(char => `
                            <div class="chat-item ${currentChat.type === 'direct' && char.id === currentChat.id ? 'active' : ''}" data-type="direct" data-id="${char.id}">
                                <img src="${char.config.aiAvatar}" alt="${char.config.characterName}">
                                <span class="name">${char.config.characterName}</span>
                                <button class="delete-btn" data-type="direct" data-id="${char.id}" title="删除角色">×</button>
                            </div>
                        `).join('')}
                    </div>
                    <button id="add-character-btn" class="add-new-btn">创建新角色</button>
                </div>
                <div id="group-chat-list" class="chat-manager-content">
                     <div class="chat-list">
                        ${groupChats.map(group => `
                            <div class="chat-item ${currentChat.type === 'group' && group.id === currentChat.id ? 'active' : ''}" data-type="group" data-id="${group.id}">
                                <img src="${group.avatar}" alt="${group.name}">
                                <span class="name">${group.name}</span>
                                <button class="delete-btn" data-type="group" data-id="${group.id}" title="删除群组">×</button>
                            </div>
                        `).join('')}
                    </div>
                    <button id="add-group-btn" class="add-new-btn">创建新群聊</button>
                </div>
            `;
            openFeatureModal('切换聊天', bodyHtml, null, null);

            const modalBody = getEl('feature-modal-body');
            modalBody.querySelectorAll('.chat-manager-tab').forEach(tab => {
                tab.onclick = () => {
                    modalBody.querySelector('.chat-manager-tab.active').classList.remove('active');
                    tab.classList.add('active');
                    modalBody.querySelector('.chat-manager-content.active').classList.remove('active');
                    getEl(tab.dataset.tab + '-chat-list').classList.add('active');
                };
            });
            
            modalBody.onclick = (e) => {
                const item = e.target.closest('.chat-item');
                const deleteBtn = e.target.closest('.delete-btn');
                const addCharBtn = e.target.closest('#add-character-btn');
                const addGroupBtn = e.target.closest('#add-group-btn');

                if (deleteBtn) {
                    e.stopPropagation();
                    handleDeleteChat(deleteBtn.dataset.type, deleteBtn.dataset.id);
                } else if (item) {
                    loadChat(item.dataset.type, item.dataset.id);
                    closeModal(elements.featureModal);
                } else if (addCharBtn) {
                    const newChar = createNewCharacterObject();
                    characterSets.push(newChar);
                    saveAllData();
                    loadChat('direct', newChar.id);
                    closeModal(elements.featureModal);
                    elements.settingsBtn.click();
                } else if (addGroupBtn) {
                    openCreateGroupModal();
                }
            };
        };

        const openCreateGroupModal = () => {
            let tempGroupAvatar = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0iI2EwYTBiMyI+PHBhdGggZD0iTTExIDEyYy0uNTUgMC0xLS40NS0xLTFzLjQ1LTEgMS0xIDEgLjQ1IDEgMXMtLjQ1IDEtMSAxem00IDBjLS41NSAwLTEtLjQ1LTEtMXMuNDUtMSAxLTEgMSAuNDUgMSAxcy0uNDUgMS0xIDF6bS04IDBjLS41NSAwLTEtLjQ1LTEtMXMuNDUtMSAxLTEgMSAuNDUgMSAxcy0uNDUgMS0xIDF6bTEwLThINWMtMS4xIDAtMiAuOS0yIDJ2MTRsNC00aDEyYzEuMSAwIDItLjkgMi0yVjZjMC0xLjEtLjktMi0yLTJ6bTAtMTJoMTJjMS4xIDAgMiAuOSAyIDJ2MTBsMiAydjQtMmMwLTEuMS0uOS0yLTItMkg2bC00IDRWMnYyaDR6Ii8+PC9zdmc+';
            const memberSelectionHtml = characterSets.map(c => `
                <label class="member-select-item">
                    <input type="checkbox" name="group-members" value="${c.id}">
                    <img src="${c.config.aiAvatar}" style="width: 30px; height: 30px; border-radius: 6px;">
                    <span>${c.config.characterName}</span>
                </label>
            `).join('');

            const bodyHtml = `
                <div class="form-group avatar-upload-group" style="justify-content:center; flex-direction:column;">
                    <img id="new-group-avatar-preview" src="${tempGroupAvatar}" class="avatar-preview" style="width:80px;height:80px;border-radius:12px;cursor:pointer;">
                    <label for="group-avatar-upload-input" class="file-input-label" style="margin-top:10px;">选择群头像</label>
                </div>
                <div class="form-group"><label for="new-group-name">群名称</label><input type="text" id="new-group-name" placeholder="欢乐一家人"></div>
                <div class="form-group"><label>选择成员</label><div id="create-group-members">${memberSelectionHtml}</div></div>
            `;
            openFeatureModal('创建新群聊', bodyHtml, '创建', () => {
                const name = getEl('new-group-name').value.trim() || '欢乐一家人';
                const selectedMembers = Array.from(document.querySelectorAll('input[name="group-members"]:checked')).map(cb => cb.value);
                if (selectedMembers.length < 1) {
                    alert('请至少选择一位成员。');
                    return;
                }
                const newGroup = createNewGroupObject(name, tempGroupAvatar, selectedMembers);
                groupChats.push(newGroup);
                saveAllData();
                loadChat('group', newGroup.id);
                closeModal(elements.featureModal);
            });
            
            getEl('new-group-avatar-preview').onclick = () => elements.groupAvatarUploadInput.click();
            elements.groupAvatarUploadInput.onchange = e => handleFileUpload(e.target.files[0], d => {
                tempGroupAvatar = d;
                getEl('new-group-avatar-preview').src = d;
            });
        };

        const handleDeleteChat = (type, idToDelete) => {
            if (type === 'direct') {
                 if (characterSets.length <= 1) {
                    alert("必须保留至少一个角色。");
                    return;
                }
                const charToDelete = characterSets.find(c => c.id === idToDelete);
                if (confirm(`确定要删除角色「${charToDelete.config.characterName}」吗？`)) {
                    characterSets = characterSets.filter(c => c.id !== idToDelete);
                    if (currentChat.id === idToDelete) {
                        loadChat('direct', characterSets[0].id);
                    }
                    saveAllData();
                    openChatManager(); 
                }
            } else { // group
                const groupToDelete = groupChats.find(g => g.id === idToDelete);
                if (confirm(`确定要删除群聊「${groupToDelete.name}」吗？`)) {
                    groupChats = groupChats.filter(g => g.id !== idToDelete);
                     if (currentChat.id === idToDelete) {
                        loadChat('direct', characterSets[0].id);
                    }
                    saveAllData();
                    openChatManager();
                }
            }
             closeModal(elements.settingsModal);
        };

               const addMomentByAI = (characterId, momentData, momentType) => {
    const character = characterSets.find(c => c.id === characterId);
    if (!character) return;
    const imageUrl = null;
    const newMoment = { id: generateId('moment'), senderId: character.id, timestamp: getFullTimestamp(), likes: [], comments: [], content: momentData.content, imageUrl };
    
    showTopNotification(`${character.config.characterName} 发布了一条新动态`, character.config.aiAvatar);

    if (momentType === 'direct') {
        if (!character.moments) character.moments = [];
        character.moments.unshift(newMoment);
    } else if (momentType === 'group') {
        const group = getCurrentGroup();
        if (group) {
            if (!group.groupMoments) group.groupMoments = [];
            group.groupMoments.unshift(newMoment);

            // **核心新增：触发其他群成员来评论**
            const otherMembers = group.memberIds.filter(id => id !== characterId && characterSets.some(c => c.id === id));
            otherMembers.forEach((memberId, index) => {
                setTimeout(() => {
                    if (Math.random() > 0.4) { // 60%的几率来评论
                        triggerAiMomentComment(newMoment, memberId, 'group');
                    }
                }, (index + 1) * 5000 + Math.random() * 3000); // 错开时间，显得更自然
            });
        }
    }
    saveAllData();
    if(elements.momentsOverlay.classList.contains('show')) renderMoments();
};
            const addMomentByUser = async (momentData) => {
    const newMoment = { id: generateId('moment'), senderId: 'user', timestamp: getFullTimestamp(), likes: [], comments: [], ...momentData };
    
    let momentTypeForAI;
    // 智能判断应该把动态发到哪里
    if (currentChat.type === 'group') {
        const group = getCurrentGroup();
        if (group) {
            if (!group.groupMoments) group.groupMoments = [];
            group.groupMoments.unshift(newMoment);
            momentTypeForAI = 'group';
        }
    } else {
        // 默认发到个人朋友圈
        if (!userMomentsProfile.posts) userMomentsProfile.posts = [];
        userMomentsProfile.posts.unshift(newMoment);
        momentTypeForAI = 'direct';
    }

    saveAllData();
    openMoments(); // 重新打开朋友圈以刷新

    // AI自动评论的逻辑保持不变，但确保触发逻辑更健壮
    const relevantChars = currentChat.type === 'direct' 
        ? [getCurrentCharacter()].filter(Boolean)
        : (getCurrentGroup() ? getCurrentGroup().memberIds.map(id => characterSets.find(c => c.id === id)).filter(Boolean) : []);
    
    for (let i = 0; i < relevantChars.length; i++) {
        const char = relevantChars[i];
        setTimeout(() => {
            // 在单人聊天中，有很大概率会评论
            const shouldComment = (currentChat.type === 'direct') ? (Math.random() > 0.1) : (Math.random() > 0.3);
            if (shouldComment) {
                triggerAiMomentComment(newMoment, char.id, momentTypeForAI);
            }
        }, (i + 1) * 4000 + Math.random() * 2000); 
    }
};
                                                                                                                                                            const triggerAiMomentComment = async (moment, commenterId, momentType) => {
                try {
                    const commenterChar = characterSets.find(c => c.id === commenterId);
                    if (!commenterChar) return;
                    
                    const postedByChar = characterSets.find(c => c.id === moment.senderId);
                    const postedBy = moment.senderId === 'user' ? (userMomentsProfile.name || '我') : (postedByChar?.config.characterName || '一位朋友');
                    
                    const chatData = getCurrentChatData();
                    const recentHistory = chatData ? chatData.chatHistory.slice(-5) : [];
                    const historyContext = recentHistory.map(msg => `${msg.sender === 'user' ? 'User' : 'AI'}: ${msg.text || '(非文本消息)'}`).join('\n');
                    
                    const finalPrompt = `[Role]: You are ${commenterChar.config.characterName}. Your persona is: ${commenterChar.config.characterPrompt}
[Recent Conversation Context]:
${historyContext}
[Current Situation]: You see a social media post from ${postedBy}. The post says: "${moment.content}".
[Task]: Based on ALL the information above (your persona and the recent conversation), write a short, natural, first-person comment in Simplified Chinese in response to this post.
[CRITICAL OUTPUT FORMAT]: Your entire response MUST be a valid JSON array containing a single object, like this example:
[{"type": "moment_comment", "momentId": "${moment.id}", "comment_text": "Your actual comment text here."}]
Do NOT leave the comment_text empty. Do NOT add any text, markdown, or explanations outside the JSON array.`;

                    const payload = getApiPayload(elements.modelSelect.value, [], finalPrompt);
                    
                    // ---【核心修复】--- 在函数内部获取API配置 ---
                    const apiBaseUrl = elements.apiBaseUrlInput.value.trim();
                    const apiKey = elements.apiKeyInput.value.trim();
                    const model = elements.modelSelect.value;
                    const isGemini = apiBaseUrl.includes('google');
                    // --- 修复结束 ---
                    
                    const fetchUrl = isGemini ? `${apiBaseUrl}/v1beta/models/${model}:generateContent?key=${apiKey}` : `${apiBaseUrl}/v1/chat/completions`;
                    const headers = isGemini ? { 'Content-Type': 'application/json' } : { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` };

                    const response = await fetch(fetchUrl, { method: 'POST', headers: headers, body: JSON.stringify(payload) });
                    const rawText = await response.text();
                    if (!response.ok) throw new Error(`API请求失败，官方报告 Status Code: ${response.status}`);

                    const responseData = JSON.parse(rawText);
                    let aiResponseText = '';
                    if (isGemini) {
                        if (!responseData.candidates || responseData.candidates.length === 0) { throw new Error("Gemini的candidates列表为空。"); }
                        aiResponseText = responseData.candidates[0].content.parts.map(part => part.text || '').join('');
                    } else {
                        aiResponseText = responseData.choices?.[0]?.message?.content;
                    }

                    if (!aiResponseText) { throw new Error("AI的响应中没有有效的文本内容。"); }

                    const cleanedJsonString = aiResponseText.trim().replace(/^```json\s*/, '').replace(/\s*```$/, '');
                    const jsonAction = JSON.parse(cleanedJsonString);

                    if (jsonAction && Array.isArray(jsonAction) && jsonAction[0] && jsonAction[0].type === 'moment_comment' && jsonAction[0].comment_text && jsonAction[0].comment_text.trim() !== "") {
                        addCommentOrReplyByAI('comment', moment.id, jsonAction[0].comment_text, commenterId, null, momentType);
                    } else {
                        console.error("最终解析出的JSON无效或内容为空。", jsonAction);
                    }
                } catch (error) { 
                    console.error("【重大错误】Moment comment AI trigger error:", error); 
                }
            };
                                                                                                                                                            const triggerAiMomentReply = async (moment, commentToReply, replierId, momentType) => {
                try {
                    const replierChar = characterSets.find(c => c.id === replierId);
                    if (!replierChar) return;

                    const originalPosterName = characterSets.find(c => c.id === moment.senderId)?.config.characterName || (userMomentsProfile.name || '我');
                    const personBeingRepliedToName = characterSets.find(c => c.id === commentToReply.sender)?.config.characterName || (userMomentsProfile.name || '我');
                    const chatData = getCurrentChatData();
                    const recentHistory = chatData ? chatData.chatHistory.slice(-5) : [];
                    const historyContext = recentHistory.map(msg => `${msg.sender === 'user' ? 'User' : 'AI'}: ${msg.text || '(非文本消息)'}`).join('\n');
                    
                    const finalPrompt = `[Role]: You are ${replierChar.config.characterName} (ID: ${replierId}). Your persona is: ${replierChar.config.characterPrompt}
[Recent Conversation Context]:
${historyContext}
[Current Situation]: On ${originalPosterName}'s social media post, ${personBeingRepliedToName} left a comment saying: "${commentToReply.text}".
[Task]: Now, write a short, natural, first-person reply in Simplified Chinese to ${personBeingRepliedToName}'s comment.
[CRITICAL OUTPUT FORMAT]: Your entire response MUST be a valid JSON array containing a single object. It MUST include your own senderId. Example:
[{"senderId": "${replierId}", "type": "moment_reply", "momentId": "${moment.id}", "commentId": "${commentToReply.id}", "reply_text": "Your actual reply text here."}]
Do NOT leave the reply_text empty. Do NOT add any text, markdown, or explanations outside the JSON array.`;
                    
                    const payload = getApiPayload(elements.modelSelect.value, [], finalPrompt);

                    // ---【核心修复】--- 在函数内部获取API配置 ---
                    const apiBaseUrl = elements.apiBaseUrlInput.value.trim();
                    const apiKey = elements.apiKeyInput.value.trim();
                    const model = elements.modelSelect.value;
                    const isGemini = apiBaseUrl.includes('google');
                    // --- 修复结束 ---
                    
                    const fetchUrl = isGemini ? `${apiBaseUrl}/v1beta/models/${model}:generateContent?key=${apiKey}` : `${apiBaseUrl}/v1/chat/completions`;
                    const headers = isGemini ? { 'Content-Type': 'application/json' } : { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` };
                    
                    const response = await fetch(fetchUrl, { method: 'POST', headers: headers, body: JSON.stringify(payload) });
                    const rawText = await response.text();
                    if (!response.ok) throw new Error(`API请求失败: ${rawText}`);

                    const responseData = JSON.parse(rawText);
                    let aiResponseText = '';
                    if (isGemini) {
                        if (!responseData.candidates) { throw new Error("Gemini的candidates列表为空。"); }
                        aiResponseText = responseData.candidates[0].content.parts.map(part => part.text || '').join('');
                    } else {
                        aiResponseText = responseData.choices?.[0]?.message?.content;
                    }

                    if (!aiResponseText) { throw new Error("AI的响应中没有有效的文本内容。"); }
                    
                    const cleanedJsonString = aiResponseText.trim().replace(/^```json\s*/, '').replace(/\s*```$/, '');
                    processAiResponse(cleanedJsonString);
                    
                } catch (error) { 
                    console.error("【重大错误】AI trigger reply error:", error); 
                }
            };
            
        const openMoments = () => { renderMoments(); elements.momentsOverlay.classList.add('show'); };
        
        const openPostMomentModal = () => { let tempImage = null; const bodyHtml = ` <div class="form-group"> <textarea id="new-moment-text" rows="5" placeholder="在想些什么？"></textarea> </div> <div class="form-group"> <label for="moment-post-image-input" class="file-input-label">添加图片</label> <img id="new-moment-preview" src="" style="max-width: 100px; max-height: 100px; border-radius: 8px; margin-top: 10px; display: none;"> </div> `; openFeatureModal('发布新动态', bodyHtml, '发布', () => { const text = getEl('new-moment-text').value.trim(); if(text || tempImage) { addMomentByUser({ content: text, imageUrl: tempImage }); closeModal(elements.featureModal); } }); const preview = getEl('new-moment-preview'); getEl('feature-modal-body').querySelector('label').onclick = () => elements.momentPostImageInput.click(); elements.momentPostImageInput.onchange = e => handleFileUpload(e.target.files[0], (dataUrl) => { tempImage = dataUrl; preview.src = dataUrl; preview.style.display = 'block'; }); };
        
        const openCreateRedPacketModal = () => {
            const bodyHtml = `
                <div class="form-group"><label for="red-packet-amount">总金额</label><input type="number" id="red-packet-amount" placeholder="0.00"></div>
                <div class="form-group"><label for="red-packet-count">红包个数</label><input type="number" id="red-packet-count" placeholder="例如: 5"></div>
                <div class="form-group"><label for="red-packet-memo">祝福语</label><input type="text" id="red-packet-memo" value="恭喜发财，大吉大利"></div>
            `;
            openFeatureModal('发红包', bodyHtml, '塞钱进红包', () => {
                const amount = parseFloat(getEl('red-packet-amount').value);
                const count = parseInt(getEl('red-packet-count').value);
                const memo = getEl('red-packet-memo').value.trim() || '恭喜发财，大吉大利';
                const group = getCurrentGroup();
                if (!group || amount <= 0 || count <= 0) { alert('请输入有效的金额和数量。'); return; }
                if (count > group.memberIds.length + 1) { alert('红包个数不能超过群成员总数。'); return; }
                if (amount < count * 0.01) { alert('总金额不足以让每个红包至少有0.01元。'); return; }

                handleUserAction({ 
                    sender: 'user', type: 'red-packet', packetId: generateId('rp'),
                    amount, count, memo, grabbers: {}, status: 'open',
                    llmContent: `[用户发了一个红包。祝福语: "${memo}"]` 
                });
                closeModal(elements.featureModal);
            });
        };

                                const renderRedPacket = (msg) => {
            if (!msg || typeof msg !== 'object') return '<p>红包数据错误</p>';
            const grabbers = msg.grabbers || {}; 
            const { packetId, memo, count, status } = msg;
            
            if (!packetId || !count) return '<p>红包信息不完整</p>';
            const hasGrabbed = Object.keys(grabbers).includes('user');
            const isFullyClaimed = Object.keys(grabbers).length >= count;
            let resultsHtml = '';
            if (Object.keys(grabbers).length > 0) {
                const items = Object.entries(grabbers).map(([id, amount]) => {
                    let name = '未知';
                    if (id === 'user') {
                        name = userMomentsProfile.name || '我';
                    } else {
                        const character = characterSets.find(c => c && c.id === id);
                        if (character && character.config) {
                            name = character.config.characterName;
                        }
                    }
                    const amountDisplay = typeof amount === 'number' ? amount.toFixed(2) : '...';
                    return `<div class="red-packet-result-item"><span>${name}</span><span>${amountDisplay}元</span></div>`;
                }).join('');
                resultsHtml = `<div class="red-packet-results">${items}</div>`;
            }
            const buttonHtml = (!hasGrabbed && !isFullyClaimed) ? `<button class="red-packet-grab-btn" onclick="handleGrabRedPacket('${packetId}')">开</button>` : '';
            const footerText = isFullyClaimed 
                ? `${count}个红包，已被抢完` 
                : (Object.keys(grabbers).length > 0 ? `已领取${Object.keys(grabbers).length}/${count}个` : `群红包，共${count}个`);
            return `<div class="red-packet-body"><div class="red-packet-body-header"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 4H6C4.9 4 4 4.9 4 6v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm-6 11.5c-2.49 0-4.5-2.01-4.5-4.5S9.51 6.5 12 6.5s4.5 2.01 4.5 4.5-2.01 4.5-4.5 4.5z"/></svg><span class="red-packet-memo">${memo || '恭喜发财，大吉大利'}</span></div>${buttonHtml}</div>${resultsHtml}<div class="red-packet-footer">${footerText}</div>`;
        };
        
        window.handleGrabRedPacket = (packetId) => { // Make it global for inline onclick
            const group = getCurrentGroup();
            if (!group) return;
            const packet = group.chatHistory.find(m => m.packetId === packetId);
            if (!packet || packet.status === 'claimed' || Object.keys(packet.grabbers).includes('user')) return;
            const remainingAmount = packet.amount - Object.values(packet.grabbers).reduce((a, b) => a + b, 0);
            const remainingCount = packet.count - Object.keys(packet.grabbers).length;
            let grabbedAmount;
            if (remainingCount === 1) { grabbedAmount = remainingAmount; } 
            else { const min = 0.01; const max = (remainingAmount - (remainingCount - 1) * min); grabbedAmount = Math.random() * (max - min) + min; }
            packet.grabbers['user'] = parseFloat(grabbedAmount.toFixed(2));
            if (Object.keys(packet.grabbers).length >= packet.count) packet.status = 'claimed';
            saveAllData(); renderAllMessages();
            handleUserAction({ sender: 'user', type: 'text', text: `[我领取了红包]`, llmContent: `[用户领取了红包]` });
        };
        
                const handleAiGrabRedPacket = (packetId, grabberId) => {
            const group = getCurrentGroup(); if (!group) return;
            const packet = group.chatHistory.find(m => m.packetId === packetId);
            if (!packet || packet.status === 'claimed' || Object.keys(packet.grabbers).includes(grabberId)) return;
            const remainingAmount = packet.amount - Object.values(packet.grabbers).reduce((a, b) => a + b, 0);
            const remainingCount = packet.count - Object.keys(packet.grabbers).length;
            if (remainingCount <= 0) return;
            let grabbedAmount;
            if (remainingCount === 1) { grabbedAmount = remainingAmount; }
            else { const min = 0.01; const max = (remainingAmount - (remainingCount - 1) * min); grabbedAmount = Math.max(min, Math.random() * (Math.max(max, min) - min) + min); }
            const finalGrabbedAmount = parseFloat(grabbedAmount.toFixed(2));
            packet.grabbers[grabberId] = finalGrabbedAmount; 
            if (Object.keys(packet.grabbers).length >= packet.count) packet.status = 'claimed';
            saveAllData();
            return finalGrabbedAmount;
        };

        // --- Poll Logic ---
        const openCreatePollModal = () => { const bodyHtml = ` <div class="form-group"><label for="poll-question">投票问题</label><input type="text" id="poll-question" placeholder="晚饭吃什么？"></div> <div class="form-group"><label>选项 (每行一个)</label><textarea id="poll-options" rows="4" placeholder="披萨\n寿司\n墨西哥卷饼"></textarea></div> `; openFeatureModal('创建投票', bodyHtml, '创建', () => { const question = getEl('poll-question').value.trim(); const options = getEl('poll-options').value.split('\n').map(o => o.trim()).filter(o => o); if (question && options.length >= 2) { const pollId = generateId('poll'); handleUserAction({ sender: 'user', type: 'poll', pollId, question, options, llmContent: `[用户发起了一个投票。问题: "${question}", 选项: ${options.join(", ")}]` }); closeModal(elements.featureModal); } else { alert('请输入问题和至少两个选项。'); } }); };
        const renderPoll = (msg) => { const group = getCurrentGroup(); if (!group) return ''; const pollData = (group.polls || []).find(p => p.pollId === msg.pollId); if (!pollData) return `<p>投票数据加载失败。</p>`; const totalVotes = Object.values(pollData.votes).flat().length; const userHasVoted = Object.values(pollData.votes).flat().includes('user'); const optionsHtml = pollData.options.map(option => { const voters = pollData.votes[option] || []; const voteCount = voters.length; const percentage = totalVotes > 0 ? (voteCount / totalVotes * 100).toFixed(0) : 0; const voterAvatars = voters.map(voterId => { const avatarSrc = voterId === 'user' ? userMomentsProfile.chatAvatar : characterSets.find(c => c.id === voterId)?.config.aiAvatar; return avatarSrc ? `<img src="${avatarSrc}" class="poll-voter-avatar" title="${characterSets.find(c=>c.id===voterId)?.config.characterName || '我'}">` : ''; }).join(''); return ` <div class="poll-option"> <div class="poll-option-label">${option} (${voteCount}票)</div> <div class="poll-progress-bar"> <div class="poll-progress-fill" style="width: ${percentage}%;"> <span class="poll-percentage">${percentage}%</span> </div> </div> <div class="poll-voters">${voterAvatars}</div> ${!userHasVoted ? `<button class="poll-vote-btn" data-poll-id="${pollData.pollId}" data-option="${option}">投这一票</button>` : ''} </div>`; }).join(''); return `<div class="poll-question">${pollData.question}</div>${optionsHtml}`; };
        const handleUserVote = (pollId, option) => { const group = getCurrentGroup(); if (!group) return; const poll = (group.polls || []).find(p => p.pollId === pollId); if (!poll || poll.status === 'closed') return; Object.keys(poll.votes).forEach(key => { poll.votes[key] = (poll.votes[key] || []).filter(v => v !== 'user'); }); if (!poll.votes[option]) poll.votes[option] = []; poll.votes[option].push('user'); saveAllData(); renderAllMessages(); handleUserAction({ sender: 'user', type: 'text', text: `[我投了: 「${option}」]`, llmContent: `[用户投票了。选项: "${option}"]` }); };
        const handleAiVote_dataOnly = (voteAction) => { const group = getCurrentGroup(); if (!group) return; const poll = (group.polls || []).find(p => p.pollId === voteAction.pollId); const voterId = voteAction.senderId; const option = voteAction.option; if (!poll || !voterId || !option || poll.status === 'closed' || !poll.options.includes(option)) return; Object.keys(poll.votes).forEach(key => { poll.votes[key] = (poll.votes[key] || []).filter(v => v !== voterId); }); if (!poll.votes[option]) poll.votes[option] = []; poll.votes[option].push(voterId); saveAllData(); };
        
            

                      // ===================================================================
// ============= 全新的、修复后的朋友圈“渲染引擎” =============
// ===================================================================

// “配菜”菜谱 1：评论扁平化工具
const flattenComments = (comments) => {
    const flatList = [];
    const traverse = (commentNodes) => {
        if (!commentNodes || commentNodes.length === 0) return;
        for (const comment of commentNodes) {
            flatList.push(comment);
            traverse(comment.replies); 
        }
    };
    traverse(comments);
    return flatList;
};

// “配菜”菜谱 2：渲染评论区
const renderComments = (comments, post) => {
    const flatCommentList = flattenComments(comments);
    if (flatCommentList.length === 0) return '';
    
    return flatCommentList.map(comment => {
        const commenterChar = characterSets.find(char => char.id === comment.sender);
        const commenterName = comment.sender === 'user' 
            ? (userMomentsProfile.name || '我') 
            : (commenterChar?.config.characterName || '一位朋友');

        let repliedToName = null;
        if (comment.replyTo) {
            const repliedToChar = characterSets.find(char => char.id === comment.replyTo);
            repliedToName = comment.replyTo === 'user' 
                ? (userMomentsProfile.name || '我') 
                : (repliedToChar?.config.characterName || '一位朋友');
        }

        return `
            <div class="comment" data-comment-id="${comment.id}" data-sender-id="${comment.sender}">
                <span class="comment-user">${commenterName}</span>
                ${repliedToName ? ` <span style="color: #555; font-weight: normal;">回复</span> <span class="comment-user">${repliedToName}</span>` : ''}:
                <span class="comment-text">${comment.text}</span>
                <button class="delete-comment-btn" title="删除评论" style="background:none; border:none; color:#aaa; cursor:pointer; font-size:1.2em; padding: 0 5px;">×</button>
            </div>
        `;
    }).join('');
};

// “主菜”菜谱：渲染单条朋友圈动态
const renderSingleMoment = (post) => {
    const senderIsUser = post.senderId === 'user';
    const postChar = !senderIsUser ? characterSets.find(c => c.id === post.senderId) : null;
    const senderName = senderIsUser ? (userMomentsProfile.name || '我') : postChar?.config.characterName || '一位朋友';
    const senderAvatar = senderIsUser ? userMomentsProfile.momentsAvatar : postChar?.config.aiAvatar || '';
    const momentType = currentChat.type === 'direct' ? 'direct' : 'group';

    return `
        <div class="moment-post" data-moment-id="${post.id}" data-sender-id="${post.senderId}" data-moment-type="${momentType}">
            <img src="${senderAvatar}" alt="avatar" class="moment-avatar">
            <div class="moment-body">
                <div class="moment-username">${senderName}</div>
                <div class="moment-content">${post.content.replace(/\n/g, '<br>')}</div>
                ${post.imageUrl ? `<img src="${post.imageUrl}" alt="moment image" class="moment-image">` : ''}
                <div class="moment-footer">
                    <span class="moment-timestamp">${post.timestamp}</span>
                    <div class="moment-actions">
                        <button class="like-btn ${post.likes.includes('user') ? 'liked' : ''}">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
                            <span class="like-count">${post.likes.length > 0 ? post.likes.length : ''}</span>
                        </button>
                        <button class="comment-btn">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"/></svg>
                        </button>
                        <button class="delete-moment-btn" title="删除动态">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" height="18px" width="18px"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
                        </button>
                    </div>
                </div>
                <div class="moment-comments">${renderComments(post.comments, post)}</div>
                <form class="comment-input-form" style="display: none;" data-reply-to="">
                    <input type="text" class="comment-input" placeholder="添加评论...">
                    <button type="submit">发送</button>
                </form>
            </div>
        </div>`;
};

// 总管函数：负责组合所有朋友圈动态
const renderMoments = () => {
    const chatData = getCurrentChatData(); if(!chatData) { elements.momentsFeed.innerHTML = ''; return; }
    let allPosts = [];
    elements.postNewMomentBtn.style.display = 'block';

    if (currentChat.type === 'direct') {
        const character = chatData;
        allPosts = [...(character.moments || []).map(m => ({ ...m, senderType: 'ai' })), ...(userMomentsProfile.posts || []).map(p => ({ ...p, senderType: 'user' }))];
        elements.momentsUserAvatar.src = userMomentsProfile.momentsAvatar;
        elements.momentsUserName.textContent = userMomentsProfile.name || '我';
        elements.momentsCoverArea.style.backgroundImage = `url(${userMomentsProfile.cover})`;
    } else { 
        const group = chatData;
        allPosts = [...(group.groupMoments || [])];
        elements.momentsUserAvatar.src = group.avatar;
        elements.momentsUserName.textContent = group.name;
        elements.momentsCoverArea.style.backgroundImage = `url(${group.avatar})`;
    }
    allPosts.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
    elements.momentsFeed.innerHTML = allPosts.length === 0 
        ? `<p style="text-align:center; padding: 40px; color: #999;">这里还没有任何动态。</p>`
        : allPosts.map(post => renderSingleMoment(post)).join('');
};
              // --- 全新的、用于删除评论的函数 ---
        const deleteCommentById = (commentArray, idToDelete) => {
            // 过滤掉当前层级中匹配ID的评论
            const filteredArray = commentArray.filter(comment => comment.id !== idToDelete);

            // 遍历过滤后的数组，对每一个评论的子回复进行递归操作
            filteredArray.forEach(comment => {
                if (comment.replies && comment.replies.length > 0) {
                    // 递归调用自身，处理子回复
                    comment.replies = deleteCommentById(comment.replies, idToDelete);
                }
            });

            return filteredArray;
        };
              // --- 全新的、修复AI评论和回复功能的核心函数 ---
        const addCommentOrReplyByAI = (type, momentId, text, senderId, replyToCommentId, momentType) => {
            let allPosts = [];
            if (momentType === 'direct') {
                const character = getCurrentCharacter();
                allPosts = [...(character?.moments || []), ...(userMomentsProfile.posts || [])];
            } else {
                const group = getCurrentGroup();
                allPosts = group ? [...(group.groupMoments || [])] : [];
            }
            const moment = allPosts.find(p => p.id === momentId);
            if (!moment) {
                console.error(`AI试图评论一个不存在的动态 (ID: ${momentId})`);
                return;
            }

            const newCommentByAI = { id: generateId('cmt'), sender: senderId, text, replies: [] };
            
            if (type === 'reply' && replyToCommentId) {
                newCommentByAI.replyTo = replyToCommentId; // 记录它回复的是谁的ID
                
                const findParentCommentAndPush = (comments, parentId, newReply) => {
                    for (const comment of comments) {
                        if (comment.id === parentId) {
                            if (!comment.replies) comment.replies = [];
                            comment.replies.push(newReply);
                            // 在给AI的回复中，记录它具体回复的是哪个用户的ID
                            newReply.replyTo = comment.sender;
                            return true;
                        }
                        if (comment.replies && findParentCommentAndPush(comment.replies, parentId, newReply)) {
                            return true;
                        }
                    }
                    return false;
                };
                findParentCommentAndPush(moment.comments || [], replyToCommentId, newCommentByAI);

            } else { // 'comment' type
                if (!moment.comments) moment.comments = [];
                moment.comments.push(newCommentByAI);
            }
            
            saveAllData();
            if (elements.momentsOverlay.classList.contains('show')) {
                renderMoments();
            }
        };
                       const handleMomentsInteraction = (e) => {
    const postEl = e.target.closest('.moment-post'); if (!postEl) return;
    const momentId = postEl.dataset.momentId;
    const momentType = postEl.dataset.momentType || (currentChat.type === 'group' ? 'group' : 'direct');

    let allVisiblePosts = [];
    if (momentType === 'direct') {
         const character = getCurrentCharacter();
         allVisiblePosts = [...(character?.moments || []), ...(userMomentsProfile.posts || [])];
    } else { 
        const group = getCurrentGroup(); 
        allVisiblePosts = group ? [...(group.groupMoments || [])] : []; 
    }
    
    // **修复您发的朋友圈角色不评论的bug的关键**
    // 如果在群聊里找不到这个动态，就去个人动态里找，确保能处理您自己的动态
    let moment = allVisiblePosts.find(m => m.id === momentId);
    if (!moment && momentType === 'group') {
         moment = userMomentsProfile.posts.find(p => p.id === momentId);
    }
    if (!moment) return;
    
    const likeBtn = e.target.closest('.like-btn');
    const commentBtn = e.target.closest('.comment-btn');
    const commentText = e.target.closest('.comment-text');
    const commentForm = e.target.closest('.comment-input-form');
    const deleteMomentBtn = e.target.closest('.delete-moment-btn');
    const deleteCommentBtn = e.target.closest('.delete-comment-btn');

    if (deleteMomentBtn) {
        if (confirm('您确定要删除这条动态吗？此操作无法撤销。')) {
            if (moment.senderId === 'user') { 
                userMomentsProfile.posts = userMomentsProfile.posts.filter(p => p.id !== momentId);
                if (momentType === 'group') { // 也从群聊里删除
                     const group = getCurrentGroup();
                     if (group && group.groupMoments) group.groupMoments = group.groupMoments.filter(m => m.id !== momentId);
                }
            } 
            else if (momentType === 'direct') { const postChar = characterSets.find(c => c.id === moment.senderId); if (postChar && postChar.moments) postChar.moments = postChar.moments.filter(m => m.id !== momentId); } 
            else if (momentType === 'group') { const group = getCurrentGroup(); if (group && group.groupMoments) group.groupMoments = group.groupMoments.filter(m => m.id !== momentId); }
            saveAllData(); renderMoments();
        }
        return;
    }
    if (deleteCommentBtn) { const commentEl = e.target.closest('.comment'); const commentIdToDelete = commentEl.dataset.commentId; if (confirm('您确定要删除这条评论吗？')) { moment.comments = deleteCommentById(moment.comments, commentIdToDelete);; saveAllData(); renderMoments(); } return; }
    if (likeBtn) { const likeIndex = moment.likes.indexOf('user'); if (likeIndex > -1) { moment.likes.splice(likeIndex, 1); } else { moment.likes.push('user'); } saveAllData(); renderMoments(); }
    if (commentBtn || commentText) {
        const form = postEl.querySelector('.comment-input-form');
        const input = form.querySelector('.comment-input');
        const targetCommentEl = e.target.closest('.comment');
        if(form.style.display === 'flex' && (targetCommentEl?.dataset.commentId === form.dataset.replyTo || !targetCommentEl)) { form.style.display = 'none'; } 
        else {
            form.style.display = 'flex';
            if (targetCommentEl) {
                form.dataset.replyTo = targetCommentEl.dataset.commentId;
                const repliedToChar = characterSets.find(c => c.id === targetCommentEl.dataset.senderId);
                const repliedToName = targetCommentEl.dataset.senderId === 'user' ? userMomentsProfile.name : (repliedToChar?.config.characterName || '一位朋友');
                input.placeholder = `回复 ${repliedToName}...`;
            } else { form.dataset.replyTo = ''; input.placeholder = '添加评论...'; }
            input.focus();
        }
    }

    if (commentForm) {
        e.preventDefault();
        const input = commentForm.querySelector('.comment-input');
        const text = input.value.trim();
        const replyToCommentId = commentForm.dataset.replyTo;
        if (text) {
            const newCommentByUser = { id: generateId('cmt'), sender: 'user', text, replies: [] };
            
            let repliedToAiId = null;

            if (replyToCommentId) { 
                 const findAndPushReply = (comments) => {
                    for (const c of comments) {
                        if (c.id === replyToCommentId) {
                            newCommentByUser.replyTo = c.sender;
                            if (c.sender !== 'user') repliedToAiId = c.sender;
                            if(!c.replies) c.replies = []; c.replies.push(newCommentByUser);
                            return true;
                        }
                        if (c.replies) { if(findAndPushReply(c.replies)) return true; }
                    }
                    return false;
                };
                findAndPushReply(moment.comments);
            } else { 
                if (!moment.comments) moment.comments = [];
                moment.comments.push(newCommentByUser);
                if(moment.senderId !== 'user') {
                    repliedToAiId = moment.senderId;
                }
            }
            
            input.value = ''; commentForm.style.display = 'none'; saveAllData(); renderMoments();

            // **核心升级：群聊里对AI的评论/回复，AI也会回应**
            if (repliedToAiId) {
                const finalCommentForAIToReplyTo = { ...newCommentByUser, sender: 'user' };
                setTimeout(() => triggerAiMomentReply(moment, finalCommentForAIToReplyTo, repliedToAiId, momentType), 2500 + Math.random() * 2000);
            }
        }
    }
};

        // --- Diary Logic ---
        const openDiaryModal = async () => { if (currentChat.type !== 'direct') return; const character = getCurrentCharacter(); if (!character) return; elements.diaryHeader.textContent = `${character.config.characterName}的日记本`; renderDiary(character); elements.diaryModal.classList.add('show'); };
                                                                const triggerAiDiaryEntry = async (character, date) => {
            try {
                const { config, chatHistory } = character;
                
                 const recentHistory = chatHistory.slice(-10);
                 const historyContext = recentHistory.map(msg => `${msg.sender === 'user' ? 'User' : 'AI'}: ${msg.text || '(非文本消息)'}`).join('\n');
                 
                 const finalPrompt = `[Role]: You are ${config.characterName}. Your persona is: ${config.characterPrompt}
[Recent Conversation Context for today, ${date}]:
${historyContext}
[Task]: Based on ALL the information above (your persona and the recent conversation), write a short, natural, first-person diary entry in Simplified Chinese reflecting on the day's events and feelings.
[CRITICAL OUTPUT FORMAT]: Your entire response MUST be a valid JSON array containing a single object, like this example:
[{"type": "diary_entry", "content": "Your actual diary text here."}]
Do NOT leave the content empty. Do NOT add any text, markdown, or explanations outside the JSON array.`;

                const payload = getApiPayload(elements.modelSelect.value, [], finalPrompt);
                const apiBaseUrl = elements.apiBaseUrlInput.value.trim();
                const apiKey = elements.apiKeyInput.value.trim();
                const model = elements.modelSelect.value;
                const isGemini = apiBaseUrl.includes('google');
                const fetchUrl = isGemini ? `${apiBaseUrl}/v1beta/models/${model}:generateContent?key=${apiKey}` : `${apiBaseUrl}/v1/chat/completions`;
                const headers = isGemini ? { 'Content-Type': 'application/json' } : { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` };
                
                const response = await fetch(fetchUrl, { method: 'POST', headers: headers, body: JSON.stringify(payload) });
                const rawText = await response.text();
                if (!response.ok) throw new Error(`API请求失败，官方报告 Status Code: ${response.status}`);

                const responseData = JSON.parse(rawText);
                let aiResponseText = '';
                if (isGemini) {
                    if (!responseData.candidates || responseData.candidates.length === 0) { throw new Error("Gemini的candidates列表为空。"); }
                    aiResponseText = responseData.candidates[0].content.parts.map(part => part.text || '').join('');
                } else {
                    aiResponseText = responseData.choices?.[0]?.message?.content;
                }

                if (!aiResponseText) { throw new Error("AI的响应中没有有效的文本内容。"); }
                
                // --- 【这，就是那唯一、但却决定性的修复】 ---
                const cleanedJsonString = aiResponseText.trim().replace(/^```json\s*/, '').replace(/\s*```$/, '');
                // --- 修复结束 ---
                
                const jsonAction = JSON.parse(cleanedJsonString);

                if (jsonAction && Array.isArray(jsonAction) && jsonAction[0] && jsonAction[0].type === 'diary_entry' && jsonAction[0].content && jsonAction[0].content.trim() !== "") {
                    addDiaryEntry(character.id, jsonAction[0].content, date);
                } else {
                    console.error("最终解析出的JSON无效或内容为空。", jsonAction);
                }
            } catch (e) {
                console.error("【重大错误】写日记时出错:", e);
                const entryEl = elements.diaryEntries.querySelector(`.diary-entry[data-date="${date}"] .diary-content`);
                if(entryEl) entryEl.textContent = `重写失败: ${e.message}`;
            }
        };
        const addDiaryEntry = (characterId, content, date) => {
            const character = characterSets.find(c => c.id === characterId);
            if (!character) return;
            if (!character.diary) character.diary = [];
            const existingEntryIndex = character.diary.findIndex(e => e.date === date);
            if (existingEntryIndex > -1) {
                character.diary[existingEntryIndex].content = content;
            } else {
                character.diary.unshift({ date: date, content });
            }
            saveAllData();
            if (elements.diaryModal.classList.contains('show')) renderDiary(character);
        };
                const renderDiary = (character) => {
            const entries = (character.diary || []).sort((a,b) => new Date(b.date) - new Date(a.date));
            if (entries.length === 0) {
                 elements.diaryEntries.innerHTML = '<p style="text-align:center; color:#999;">日记本还是空的。</p>';
            } else {
                elements.diaryEntries.innerHTML = entries.map(entry => `
                    <div class="diary-entry" data-date="${entry.date}">
                        <div class="diary-date">${entry.date}</div>
                        <div class="diary-content">${entry.content.replace(/\n/g, '<br>')}</div>
                        <button class="diary-regenerate-btn" title="为这一天重写日记">✏️</button>
                        <button class="diary-delete-btn" title="删除这篇日记">×</button>
                    </div>
                `).join('');
            }
        };
        const handleDeleteDiaryEntry = async (date) => {
            if (!confirm(`确定要删除 ${date} 的日记吗？删除后AI会重新生成一篇。`)) return;
            const character = getCurrentCharacter();
            if (!character || !character.diary) return;
            character.diary = character.diary.filter(entry => entry.date !== date);
            saveAllData();
            const entryEl = elements.diaryEntries.querySelector(`.diary-entry[data-date="${date}"]`);
            if (entryEl) {
                entryEl.innerHTML = `<div class="diary-date">${date}</div><div class="diary-content">正在重写中...</div>`;
            } else {
                renderDiary(character);
            }
            await triggerAiDiaryEntry(character, date);
        };
        const handleRegenerateDiaryEntry = async (date) => {
            if (!confirm(`您确定要让AI为 ${date} 重写一篇日记吗？原来的内容将会被覆盖。`)) return;
            const character = getCurrentCharacter();
            if (!character) return;
            const entryEl = elements.diaryEntries.querySelector(`.diary-entry[data-date="${date}"]`);
            if (entryEl) {
                const contentEl = entryEl.querySelector('.diary-content');
                if(contentEl) contentEl.innerHTML = '正在重写中...';
            }
            await triggerAiDiaryEntry(character, date);
        };

        // --- Data Import/Export ---
        const exportData = async () => { await saveCurrentSettings(); await saveAllData(); const data = localStorage.getItem('aiBoyfriendBackup_v7_meta'); const blob = new Blob([data], {type: 'application/json'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `ai_boyfriend_backup_${new Date().toISOString().slice(0,10)}.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); alert('全部数据已导出！'); };
        const importData = () => { if(confirm('确定要导入数据吗？这会覆盖所有当前数据。')) { elements.importDataInput.click(); } };
      // 这是一个全新的函数，负责将任何旧版本数据升级到最新的v7格式
const migrateDataToV7 = (oldData) => {
    console.log("开始数据迁移程序...");
    let newData = JSON.parse(JSON.stringify(oldData)); // 深拷贝一份，避免修改原始对象
    
    // 兼容最老版本 (v6)，它没有globalSettings
    if (!newData.globalSettings) {
        newData.globalSettings = {};
    }

    // 迁移主题和气泡样式到每个角色配置中
    const globalTheme = newData.globalSettings.theme || '1';
    const globalBubbleStyle = newData.globalSettings.bubbleStyle || 'default';
    if (newData.characterSets) {
        newData.characterSets.forEach(char => {
            if (char.config) {
                if (!char.config.theme) char.config.theme = globalTheme;
                if (!char.config.bubbleStyle) char.config.bubbleStyle = globalBubbleStyle;
            }
        });
    }
    delete newData.globalSettings.theme;
    delete newData.globalSettings.bubbleStyle;

    // 迁移全局 userPrompt 到每个角色中 (针对v6版本)
    if (newData.userMomentsProfile && newData.userMomentsProfile.userPrompt) {
        if (newData.characterSets) {
            newData.characterSets.forEach(char => {
                if (!char.userPrompt) char.userPrompt = newData.userMomentsProfile.userPrompt;
            });
        }
    }
    
    // 为旧数据添加新的默认设置
    if (newData.globalSettings.uiScale === undefined) newData.globalSettings.uiScale = 1.0;
    if (newData.globalSettings.fontSize === undefined) newData.globalSettings.fontSize = 13; // 您的默认值
    if (newData.globalSettings.bubblePadding === undefined) newData.globalSettings.bubblePadding = 10;
    if (newData.globalSettings.realTimeAwareness === undefined) newData.globalSettings.realTimeAwareness = false;
    if (!newData.globalSettings.presets) newData.globalSettings.presets = [];

    newData.version = '1.1'; // 标记为最新版本
    console.log("数据迁移完成！");
    return newData;
};
        const handleDataImport = (event) => {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = async (e) => {
        try {
            const data = e.target.result;
            let parsed = JSON.parse(data);

            // 智能检测并进行必要的升级
            if (!parsed.version || parsed.version !== '1.1') {
                alert('检测到旧版本备份文件，将为您进行升级转换...');
                parsed = migrateDataToV7(parsed); // 调用升级函数
            }

            if (parsed.characterSets && parsed.globalSettings) {
                // 在保存前，将图片数据存入IndexedDB，以保持数据格式一致性
                const isImage = (value) => typeof value === 'string' && value.startsWith('data:image');
                const processObjectForSaving = async (obj) => {
                    if (!obj || typeof obj !== 'object') return obj;
                    const newObj = Array.isArray(obj) ? [] : {};
                    for (const key in obj) {
                        if (Object.prototype.hasOwnProperty.call(obj, key)) {
                            const value = obj[key];
                            if (isImage(value)) {
                                const imageKey = `img_${generateId(key)}`;
                                await dbSet(imageKey, value);
                                newObj[key] = imageKey;
                            } else if (typeof value === 'object') {
                                newObj[key] = await processObjectForSaving(value);
                            } else {
                                newObj[key] = value;
                            }
                        }
                    }
                    return newObj;
                };
              // 这是一个全新的函数，负责将任何旧版本数据升级到最新的v7格式

                const processedData = await processObjectForSaving(parsed);
                localStorage.setItem('aiBoyfriendBackup_v7_meta', JSON.stringify(processedData));
                alert('数据导入并升级成功！页面即将刷新以应用您的备份。');
                location.reload();
            } else {
                alert('导入失败：文件内容格式不正确，缺少核心数据。');
            }
        } catch (error) {
            console.error("导入数据时发生错误:", error);
            alert(`导入失败：文件可能已损坏或不是有效的JSON文件。\n错误详情: ${error.message}`);
        }
    };
    reader.readAsText(file);
    event.target.value = '';
};

    // --- 全新的“计算并显示聊天天数”函数 ---
    const updateAndShowStreak = (character) => {
        if (!character || !character.config) return;

        const config = character.config;
        const streakEl = getEl('streak-notification');
        const streakTextEl = getEl('streak-text');
        
        const today = new Date();
        const todayStr = `${today.getFullYear()}-${today.getMonth() + 1}-${today.getDate()}`;

        if (config.lastChatDate) {
            const lastDate = new Date(config.lastChatDate);
            const yesterday = new Date();
            yesterday.setDate(today.getDate() - 1);
            const yesterdayStr = `${yesterday.getFullYear()}-${yesterday.getMonth() + 1}-${yesterday.getDate()}`;
            
            // 如果上次聊天是昨天，天数+1
            if (config.lastChatDate === yesterdayStr) {
                config.streak++;
            } 
            // 如果上次聊天不是今天也不是昨天，天数重置为1
            else if (config.lastChatDate !== todayStr) {
                config.streak = 1;
            }
        } else {
            // 如果是第一次聊天，天数就是1
            config.streak = 1;
        }

        // 更新最后聊天日期为今天并保存
        config.lastChatDate = todayStr;
        saveAllData();

        // 更新并显示提示条
        streakTextEl.textContent = `與「${config.characterName}」已連續熱聊 ${config.streak} 天`;
        streakEl.classList.add('show');

        // 5秒后自动隐藏
        setTimeout(() => {
            streakEl.classList.remove('show');
        }, 5000);
    };
                          
                const setupEventListeners = () => {
                  elements.darkModeToggle.addEventListener('change', () => applyDarkMode(elements.darkModeToggle.checked));
                  elements.compactModeToggle.addEventListener('change', () => applyCompactMode(elements.compactModeToggle.checked));       
                  elements.settingsBtn.onclick = openSettingsModal;
                  elements.closeSettingsBtn.onclick = () => closeModal(elements.settingsModal);
                  elements.saveSettingsBtn.onclick = async () => { await saveCurrentSettings(); alert('设置已保存！'); closeModal(elements.settingsModal); };
                  elements.sendBtn.onclick = () => { const text = elements.messageInput.value.trim(); if (!text) return; handleUserAction({ sender: 'user', type: 'text', text, llmContent: text }); elements.messageInput.value = ''; autoResizeTextarea(); };
                  elements.receiveBtn.onclick = triggerAiResponse; // TASK 5
                  elements.messageInput.onkeydown = (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); elements.sendBtn.click(); } };
                  elements.videoSendBtn.onclick = () => { const text = elements.videoMessageInput.value.trim(); if (!text) return; addVideoChatMessageToUI({ sender: 'user', text: text }); elements.videoMessageInput.value = ''; triggerVideoCallAIResponse(); };
                  elements.videoMessageInput.onkeydown = (e) => { if (e.key === 'Enter') { e.preventDefault(); elements.videoSendBtn.click(); } };
                  elements.mindVoiceCloseBtn.onclick = () => elements.mindVoiceModal.classList.remove('show');
                  elements.diaryModalCloseBtn.onclick = () => closeModal(elements.diaryModal);
                  
                  // TASK 2: Add event listener for diary deletion
                                      // --- 升级后的日记事件监听器 ---
                   elements.diaryEntries.addEventListener('click', (e) => {
                       const entryEl = e.target.closest('.diary-entry');
                       if (!entryEl) return;
                       
                       const date = entryEl.dataset.date;
                       if (e.target.closest('.diary-delete-btn')) {
                           handleDeleteDiaryEntry(date);
                       } else if (e.target.closest('.diary-regenerate-btn')) {
                           handleRegenerateDiaryEntry(date);
                       }
                   });

                  elements.actionBtn.onclick = () => toggleActionPanel();
                  elements.actionShowMoments.onclick = () => { openMoments(); toggleActionPanel(true); };
                  elements.actionShowDiary.onclick = () => { openDiaryModal(); toggleActionPanel(true); };
                  elements.actionSendTextImage.onclick = () => { handleTextImageSend(); toggleActionPanel(true); };
                  elements.actionSendRealImage.onclick = () => { elements.realImageUploadInput.click(); toggleActionPanel(true); };
                  elements.actionSendVoice.onclick = () => { handleVoiceSend(); toggleActionPanel(true); };
                  elements.actionSendTransfer.onclick = () => { handleTransferSend(); toggleActionPanel(true); };
                  elements.actionSendRedPacket.onclick = () => { openCreateRedPacketModal(); toggleActionPanel(true); };
                  elements.actionSendSticker.onclick = () => { handleStickerSend(); toggleActionPanel(true); };
                  elements.actionVideoCall.onclick = () => { startVideoCall(); toggleActionPanel(true); };
                  elements.actionCreatePoll.onclick = () => { openCreatePollModal(); toggleActionPanel(true); };
                                                      elements.fetchModelsBtn.onclick = async () => {
                      const baseUrl = elements.apiBaseUrlInput.value.trim();
                      const apiKey = elements.apiKeyInput.value.trim();
                      if (!baseUrl || !apiKey) { alert('请输入API端点和API密钥'); return; }
                      elements.fetchModelsBtn.textContent = '获取中...';
                      elements.fetchModelsBtn.disabled = true;
                      try {
                          const isGemini = baseUrl.includes('google');
                          // 智能拼接URL
                          const fetchUrl = isGemini ? `${baseUrl}/v1beta/models?key=${apiKey}` : `${baseUrl}/v1/models`;
                          const headers = isGemini ? {} : { 'Authorization': `Bearer ${apiKey}` };
                          
                          const response = await fetch(fetchUrl, { headers });
                          if (!response.ok) throw new Error(`获取模型列表失败, Status: ${response.status} ${await response.text()}`);
                          
                          const data = await response.json();
                          elements.modelSelect.innerHTML = '';
                          
                          const models = data.models || data.data || data;
                          if (!Array.isArray(models)) throw new Error('API返回的模型列表格式不正确');
                          
                          models.forEach(model => {
                              const modelId = model.name ? model.name.replace('models/', '') : model.id;
                              if (modelId) {
                                  if(isGemini && model.supportedGenerationMethods?.includes('generateContent') && modelId.startsWith('gemini')) {
                                      elements.modelSelect.add(new Option(modelId, modelId));
                                  } else if (!isGemini) {
                                      elements.modelSelect.add(new Option(modelId, modelId));
                                  }
                              }
                          });
                          const currentModel = elements.modelSelect.value;
                          if(currentModel) elements.modelSelect.value = currentModel;

                      } catch (error) {
                          alert(`获取模型失败: ${error.message}`);
                      } finally {
                          elements.fetchModelsBtn.textContent = '获取模型列表';
                          elements.fetchModelsBtn.disabled = false;
                      }
                  };
                  elements.themeSelector.onclick = (e) => { const t = e.target.closest('.theme-option'); if (t) applyTheme(t.dataset.theme, getCurrentChatData()); };
                  elements.fontSelect.addEventListener('change', () => applyFont(elements.fontSelect.value));   
                  const avatarCompression = { compress: true, quality: 0.7, maxWidth: 300, maxHeight: 300 };
                  const backgroundCompression = { compress: true, quality: 0.8, maxWidth: 1280, maxHeight: 1280 };
                  const chatImageCompression = { compress: true, quality: 0.75, maxWidth: 600, maxHeight: 600 };
                  elements.backgroundUploadInput.onchange = e => handleFileUpload(e.target.files[0], (d) => { elements.chatContainer.style.backgroundImage = `url(${d})`; }, backgroundCompression);
                  elements.aiAvatarUploadInput.onchange = e => handleFileUpload(e.target.files[0], (d) => { elements.aiAvatarPreview.src = d; if(currentChat.type==='direct') elements.headerAvatar.src = d; }, avatarCompression);
                  elements.groupAvatarSettingsInput.onchange = e => handleFileUpload(e.target.files[0], (d) => { elements.groupAvatarPreview.src = d; }, avatarCompression);
                  elements.userAvatarUploadInput.onchange = e => handleFileUpload(e.target.files[0], (d) => { elements.userAvatarPreview.src = d; }, avatarCompression);
                  elements.userMomentsAvatarInput.onchange = e => handleFileUpload(e.target.files[0], d => { elements.userMomentsAvatarPreview.src = d; }, avatarCompression);
                  elements.userMomentsCoverInput.onchange = e => handleFileUpload(e.target.files[0], d => { elements.userMomentsCoverPreview.src = d; }, backgroundCompression);
                  elements.realImageUploadInput.onchange = (e) => handleFileUpload(e.target.files[0], (d) => handleUserAction({ sender:'user', type:'image', imageUrl:d, llmContent:'[从相册发送了一张照片]' }), chatImageCompression);
                  elements.manageStickersBtn.onclick = () => openStickerManager('user');
                  elements.manageAiStickersBtn.onclick = () => openStickerManager('ai');
                  elements.clearHistoryBtn.onclick = clearChatHistory;
                  elements.deleteChatBtn.onclick = () => handleDeleteChat(currentChat.type, currentChat.id);
                  elements.exportDataBtn.onclick = exportData;
                  elements.importDataBtn.onclick = importData;
                  elements.importDataInput.onchange = handleDataImport;
                  elements.messageInput.addEventListener('input', autoResizeTextarea);
                  elements.featureModalCloseBtn.addEventListener('click', () => closeModal(elements.featureModal));
                  elements.featureModalSubmitBtn.addEventListener('click', () => { if (onFeatureModalSubmit) onFeatureModalSubmit(); });
                  elements.chatManagerBtn.onclick = openChatManager;
                  elements.momentsCloseBtn.onclick = () => elements.momentsOverlay.classList.remove('show');
                  elements.postNewMomentBtn.onclick = openPostMomentModal;
                  elements.momentsFeed.addEventListener('click', handleMomentsInteraction);
                  elements.messagesContainer.addEventListener('click', e => { const voteBtn = e.target.closest('.poll-vote-btn'); if (voteBtn && !voteBtn.disabled) handleUserVote(voteBtn.dataset.pollId, voteBtn.dataset.option); });
                  window.addEventListener('click', (e) => { if (e.target === elements.settingsModal) closeModal(elements.settingsModal); if (e.target === elements.featureModal) closeModal(elements.featureModal); if (e.target === elements.diaryModal) closeModal(elements.diaryModal); if (e.target === elements.mindVoiceModal) elements.mindVoiceModal.classList.remove('show'); });
                  elements.chatNameHeader.addEventListener('blur', () => { const chatData = getCurrentChatData(); if(!chatData) return; const newName = elements.chatNameHeader.textContent.trim(); const oldName = currentChat.type === 'direct' ? chatData.config.characterName : chatData.name; if(newName && newName !== oldName){ if(currentChat.type === 'direct') chatData.config.characterName = newName; else chatData.name = newName; saveAllData(); } else { elements.chatNameHeader.textContent = oldName; } });
                  elements.confirmDeleteBtn.onclick = deleteSelectedMessages;
                  elements.cancelDeleteBtn.onclick = () => toggleMultiSelectMode(false);
                  
                  // TASK 9: Sizing slider event listeners
                  const updateSizing = () => applySizing({ uiScale: parseFloat(elements.uiScaleSlider.value) / 100, fontSize: parseInt(elements.fontSizeSlider.value), bubblePadding: parseInt(elements.bubbleSizeSlider.value) });
                  elements.uiScaleSlider.addEventListener('input', () => { elements.uiScaleValue.textContent = `${elements.uiScaleSlider.value}%`; updateSizing(); });
                  elements.fontSizeSlider.addEventListener('input', () => { elements.fontSizeValue.textContent = `${elements.fontSizeSlider.value}px`; updateSizing(); });
                  elements.bubbleSizeSlider.addEventListener('input', () => { elements.bubbleSizeValue.textContent = `${elements.bubbleSizeSlider.value}px`; updateSizing(); });
                  
                  elements.bubbleStyleSelect.addEventListener('change', (e) => { applyBubbleStyle(e.target.value, getCurrentCharacter()); });
                  elements.applyCustomFontBtn.onclick = () => applyCustomFont(elements.customFontNameInput.value, elements.customFontUrlInput.value);
                };

const updatePresetsFromUI = () => {
    const presetItems = document.querySelectorAll('.preset-item');
    if (presetItems.length === 0 && globalPresets.length > 0) { globalPresets = []; return; }
    const updatedPresets = [];
    presetItems.forEach(itemEl => {
        const id = itemEl.dataset.id;
        const nameInput = itemEl.querySelector('.preset-name-input');
        const contentInput = itemEl.querySelector('.preset-content-input');
        const enabledToggle = itemEl.querySelector('.preset-enabled-toggle');
        if (id && nameInput && contentInput && enabledToggle) {
            updatedPresets.push({ id: id, name: nameInput.value, content: contentInput.value, enabled: enabledToggle.checked });
        }
    });
    globalPresets = updatedPresets;
};
      
    const renderPresets = () => {
        elements.presetListContainer.innerHTML = '';
        if (globalPresets.length === 0) {
            elements.presetListContainer.innerHTML = '<p style="text-align:center; color:#999;">还没有预设条目，点击下方按钮添加一个吧！</p>';
        } else {
            globalPresets.forEach(preset => {
                const presetEl = document.createElement('div');
                presetEl.className = 'preset-item';
                presetEl.dataset.id = preset.id;
                presetEl.innerHTML = `
                    <div class="preset-header">
                        <div class="form-group"><input type="text" class="preset-name-input" placeholder="给这个预设起个名" value="${preset.name || ''}"></div>
                        <div class="preset-actions">
                            <label class="preset-toggle"><input type="checkbox" class="preset-enabled-toggle" ${preset.enabled ? 'checked' : ''}><span class="slider"></span></label>
                            <button class="preset-delete-btn">删除</button>
                        </div>
                    </div>
                    <div class="form-group"><textarea class="preset-content-input" rows="3" placeholder="在此输入预设的提示词内容">${preset.content || ''}</textarea></div>`;
                elements.presetListContainer.appendChild(presetEl);
            });
        }
    };
    const setupPresetEventListeners = () => {
        elements.addPresetBtn.onclick = () => { updatePresetsFromUI(); const newPreset = { id: generateId('preset'), name: '', content: '', enabled: true }; globalPresets.push(newPreset); renderPresets(); };
        elements.presetListContainer.addEventListener('click', (e) => { if (e.target.classList.contains('preset-delete-btn')) { const item = e.target.closest('.preset-item'); if (item && confirm('确定要删除这个预设条目吗？')) { globalPresets = globalPresets.filter(p => p.id !== item.dataset.id); renderPresets(); } } });
        const updateSliderValue = (slider, valueEl) => { valueEl.textContent = slider.value; };
        elements.temperatureSlider.addEventListener('input', () => updateSliderValue(elements.temperatureSlider, elements.temperatureValue));
        elements.topPSlider.addEventListener('input', () => updateSliderValue(elements.topPSlider, elements.topPValue));
    };

        // --- Initialization ---
        loadAllData();
        setupEventListeners();
        setupPresetEventListeners();
        autoResizeTextarea();
    });
    </script>
</body>
</html>